\documentclass[a4paper,USenglish,cleveref, autoref, thm-restate]{lipics-v2021}
%see https://submission.dagstuhl.de/documentation/authors

\bibliographystyle{plainurl}% the mandatory bibstyle

\title{A formalization of Dedekind domains and class groups of global fields}
\titlerunning{Dedekind domains and class groups}

\author{Anne Baanen}{Vrije Universiteit Amsterdam, Netherlands \and \url{https://cs.vu.nl/~tbn305}}{t.baanen@vu.nl}{https://orcid.org/0000-0001-8497-3683}
{NWO Vidi grant No. 016.Vidi.189.037, Lean Forward}
%{Received funding from the NWO under the Vidi program (project No. 016.Vidi.189.037, Lean Forward)}
\author{Sander R. Dahmen}{Vrije Universiteit Amsterdam, Netherlands \and \url{https://few.vu.nl/~sdn249/}}{s.r.dahmen@vu.nl}{https://orcid.org/0000-0002-0014-0789}{NWO Vidi grant No. 639.032.613, New Diophantine Directions}
\author{Ashvni Narayanan}{London School of Geometry and Number Theory}{a.narayanan20@imperial.ac.uk}{orcID?}{EPSRC, UK}
\author{Filippo A. E. Nuccio Mortarino Majno di Capriglio}{Univ Lyon, Université Jean Monnet Saint-Étienne, CNRS UMR 5208, Institut Camille Jordan\and\url {https://perso.univ-st-etienne.fr/nf51454h/index.html}}{filippo.nuccio@univ-st-etienne.fr}{https://orcid.org/0000-0002-5318-9869}{\empty}

\authorrunning{T. Baanen, S. R. Dahmen, A. Narayanan, and F. A. E. Nuccio}

\Copyright{Anne Baanen, Sander R. Dahmen, Ashvni Narayanan, and Filippo A. E. Nuccio Mortarino Majno di Capriglio}

\ccsdesc[500]{Mathematics of computing~Mathematical software}
\ccsdesc[500]{Security and privacy~Logic and verification}

\keywords{formal math, algebraic number theory, commutative algebra, Lean, mathlib} %TODO mandatory; please add comma-separated list of keywords

\supplement{Full source code of the formalization is part of mathlib. Copies of the source files relevant to this paper are available in a separate repository.}
\supplementdetails[swhid={Software Heritage Identifier}]{Software}{https://github.com/lean-forward/class-number}

\acknowledgements{I want to thank \dots}%optional

%\nolinenumbers %uncomment to disable line numbering

%\hideLIPIcs  %uncomment to remove references to LIPIcs series (logo, DOI, ...), e.g. when preparing a pre-final version to be uploaded to arXiv or another public repository

%Editor-only macros:: begin (do not touch as author)%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\EventEditors{John Q. Open and Joan R. Access}
\EventNoEds{2}
\EventLongTitle{42nd Conference on Very Important Topics (CVIT 2016)}
\EventShortTitle{CVIT 2016}
\EventAcronym{CVIT}
\EventYear{2016}
\EventDate{December 24--27, 2016}
\EventLocation{Little Whinging, United Kingdom}
\EventLogo{}
\SeriesVolume{42}
\ArticleNo{23}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage{xcolor}
\usepackage{xspace}
\usepackage{listings}
\def\lstlanguagefiles{lstlean.tex}
\lstset{language=lean}

\newcommand{\C}{\mathbb{C}}
\newcommand{\lean}[1]{\texttt{#1}\xspace} % for writing Lean expressions
\newcommand{\OK}{\mathrm{O}_K}
\DeclareMathOperator{\Tr}{\mathrm{Tr}}
\newcommand{\mathlib}{\textsf{mathlib}\xspace}
\newcommand{\N}{\mathbb{N}}
\newcommand{\pow}{\textasciicircum\xspace}
\newcommand{\Q}{\mathbb{Q}}
\newcommand{\Qbar}{\mathbb{\bar{Q}}}
\newcommand{\Z}{\mathbb{Z}}
\DeclareMathOperator{\Frac}{Frac}

\definecolor{keywordcolor}{rgb}{0.7, 0.1, 0.1}   % red
\definecolor{commentcolor}{rgb}{0.4, 0.4, 0.4}   % grey
\definecolor{symbolcolor}{rgb}{0.4, 0.4, 0.4}    % grey
\definecolor{sortcolor}{rgb}{0.1, 0.5, 0.1}      % green

\DeclareUnicodeCharacter{2090}{\ensuremath{_a}}
\DeclareUnicodeCharacter{2097}{\ensuremath{_l}}
\DeclareUnicodeCharacter{211A}{\ensuremath{\Q}}
\DeclareUnicodeCharacter{22A4}{\ensuremath{\top}}
\DeclareUnicodeCharacter{22A5}{\ensuremath{\bot}}

\begin{document}

\maketitle

\begin{abstract}
Dedekind domains and their class groups are notions in commutative algebra that are essential in algebraic number theory.
We formalized these structures and several fundamental properties, including number theoretic finiteness results for class groups, in the Lean prover as part of the mathlib mathematical library.
This paper describes the formalization process,
noting the idioms we found useful in our development
and mathlib's decentralized collaboration processes involved in this project.
\end{abstract}

\section{Introduction}

In its basic form, number theory studies properties of the integers $\Z$
%(say as a set together with the \lq standard\rq\ addition and multiplication operations)
and its fraction field, the rational numbers $\Q$.\footnote{From a classical point of view, one could even argue that the positive, or perhaps nonnegative, integers and rational numbers are the most basic objects of study of number theory. From an algebraic point of view, this would still quickly lead into studying $\Z$ and $\Q$.}
Both for the sake of generalization, as well as for providing powerful techniques to answer questions about the original objects $\Z$ and $\Q$,
it is worthwhile to study finite field extensions of $\Q$, called \emph{number fields}, as well as their so called \emph{rings of integers} (defined in Section~\ref{sec math background} below),
whose relations mirror the way $\Q$ contains $\Z$ as a subring.
These number fields and their rings of integers form the basic objects of study of algebraic number theory, an important brach of modern number theory.
In this paper, we describe our project aiming to formalize these notions and some of their important properties.
Our goal, however, is not to get to the definitions and properties as quickly as possible,
but instead we aim at our formalization as a foundation for future work,
as part of a natural and more general theory as we shall explain below.

In particular, our project resulted in formalized definitions and elementary properties of
number fields and their rings of integers (described in Section \ref{sec:ring-of-integers}),
Dedekind domains (Section \ref{sec:Dedekind-domain}),
and the ideal class group and class number (Section \ref{sec:class-number}).
The main proofs that we formalized show
that two definitions of Dedekind domains are equivalent (Section \ref{sec:equivalence}),
that the ring of integers (or more generally: the integral closure of a Dedekind domain in a finite separable field extension) is a Dedekind domain (Section \ref{sec:integral-closure})
and that the class group of a number field is finite (Section \ref{sec:class-number}).
%
%As a preview, the latter two results correspond to the following declarations in Lean:
%\begin{lstlisting}
%instance : is_dedekind_domain (ring_of_integers K) :=
%integral_closure_int.is_dedekind_domain K
%
%noncomputable instance :
%  fintype (class_group (ring_of_integers.fraction_map K)) :=
%class_group.finite_of_admissible K int.fraction_map int.admissible_abs
%
%noncomputable def class_number : ℕ :=
%fintype.card (class_group (ring_of_integers.fraction_map K))
%\end{lstlisting}

Apart from the achievement of formalizing a non-trivial amount of mathematical theory,
our formal definition of the class number is an essential requirement
for theorem provers assisting in modern number theory research.
% doing ``fashionable mathematics'' in a theorem prover, borrowing a term from prof. Kevin Buzzard~\cite{fashionable-mathematics}.
Additionally, our formalization opens the door to the verification of software used for number theoretic research,
such as KASH/KANT~\cite{kash} and PARI/GP~\cite{PARI2}.

Our work is developed as part of the mathematical library \mathlib~\cite{mathlib} for the Lean 3 theorem prover~\cite{lean-prover}.
The formal system of Lean is a dependent type theory based on the calculus of inductive constructions,
with a proof-irrelevant impredicative universe \lean{Prop} at the bottom of a noncumulative hierarchy of universes \lean{Prop : Type : Type 1 : Type 2 : \dots}.\footnote{In our code samples, we use \lean{Type*} as abbreviation of ``\lean{Type u} for an arbitrary choice of \lean{u}''.}
Other important characteristics of Lean as used in \mathlib are the use of quotient types, ubiquitous classical reasoning and the use of type classes to define the hierarchy of algebraic structures.
Organizationally, \mathlib is characterized by a distributed set of contributors, a willingness to refactor its basic definitions, and a preference for complete and regular contributions over larger projects added all at once.
Our own project, being part of the development of \mathlib, follows this philosophy by contributing pieces of our work as they are finished,
in turn taking advantage of results contributed by others after the start of the project.
At several points, we had just merged a formalization into \mathlib that another contributor needed,
immediately before they contributed a result that we needed.
Due to the decentralized organization and fluid nature of contributions to mathlib, its contents are built up of many different contributions from many different authors. Attributing each formalization to a single set of main authors would not do justice to all others whose additions and tweaks are essential to its current use. Therefore, we will make clear whether a contribution is part of our project or not, but not who we consider to be the main author(s).

The source files of the formalization are currently in the process of being merged into \mathlib, an up-to-date branch being available \url{https://github.com/leanprover-community/mathlib/tree/dedekind-domain-dev}. We also maintain a separate repository containing the files relevant to this paper, available at \url{https://github.com/lean-forward/class-number}.

\section{Mathematical background}\label{sec math background}

Let us now introduce some of the main objects we study, described in a \lq standard\rq\ mathematical way. In the later sections we will go into the details concerning formalizing them in Lean.

A \emph{number field} $K$ is a finite field extensions of $\Q$, and as such has the structure of a finite dimensional vector space over $\Q$. The smallest example is $\Q$ itself, and the two-dimensional cases are given by the quadratic number fields
\[\Q(\sqrt{d})=\{a+b\sqrt{d} : a,b \in \Q\}\]
where $d\not=1$ is a squarefree (i.e. not divisible by $p^2$ for any prime $p$) integer, and there is no loss in generality in considering $\sqrt{d}$ as a complex number (since every number field can be embedded into the complex numbers).
A cubic example is
\[K:=\{a+b\alpha+c \alpha^2: a,b,c \in \Q\}\]
where $\alpha$ satisfies $\alpha^3 + \alpha^2 - 2\alpha + 8=0$ (e.g. the unique real number with this property).

The \emph{ring of integers} $\mathcal{O}_K$ of a number field $K$ is defined as the integral closure of $\Z$ in $K$, which boils down to
\[\OK := \{x \in K : f(x)=0 \text{ for some \emph{monic} polynomial } f \text{ with integer coefficients}\},\]
where we recall that a polynomial is called \emph{monic} if its leading coefficient equals $1$.
While it might not be immediately obvious that $\mathcal{O}_K$ forms indeed a ring, this follows form general algebraic properties of integral closures.
Some examples of $\OK$ are as follows. Taking $K=\Q$, we get $\OK=\Z$ back. For $K=\Q(\sqrt{2})$ we get $\OK=\Z[\sqrt{2}]=\{a+b\sqrt{2} : a,b \in \Z\}$. But for $K=\Q(\sqrt{5})$ we do \emph{not} simply get $\Z[\sqrt{5}]=\{a+b\sqrt{5} : a,b \in \Z\}$ as $\OK$, since the golden ratio $\varphi:=(1+\sqrt{5})/2\not\in \Z[\sqrt{5}]$ satisfies the monic polynomial equation $\varphi^2-\varphi-1=0$, hence by definition $\varphi \in \OK$; it turns out that $\OK=\Z[\varphi]=\{a+b\varphi : a,b \in \Z\}$. For quadratic numbers field $\Q(\sqrt{d})$, with $d$ as above, the previous two examples in fact generalize to
\begin{equation*}
\mathcal{O}_{\Q(\sqrt{d})}=
\begin{cases}
\Z[\sqrt{d}]=\{a+b\sqrt{d}: a,b \in \Z\} \text { if } d \not\equiv 1 \pmod{4}\\
 \Z\left[\frac{1+\sqrt{d}}{2}\right]=\left\{a+b \frac{1+\sqrt{d}}{2} : a,b \in \Z \right\} \text { if } d \equiv 1 \pmod{4}.
\end{cases}
\end{equation*}
Finally, if $K=\Q(\alpha)$ with $\alpha$ as before, then $\OK=\{a+b \alpha+c (\alpha+\alpha^2)/2 : a,b,c \in \Z\}$, illustrating that explicitly writing down $\OK$ can quickly become complicated.
%TODO do we want to say something here about the existence of an integral basis? And the existence/nonexistence of a power basis for number fields/rings of integers?
We could think of $\OK$ as generalization of $\Z$, and ask for properties of $\Z$ if they still hold in $\OK$, and if not, if a natural generalization still holds. An important property of $\Z$ is that it is a PID (i.e. a principal ideal domain), and hence a UFD (i.e. unique factorization domain); the latter meaning that every nonzero nonunit element can be written as a (nonempty) finite product of irreducible elements, which is unique up to the order of the elements and changing the elements by multiplication with units (which are $\pm 1$ in $\Z$).
For example, $6$ can be factorized in exactly 4 ways, namely $6=2\cdot 3=3\cdot2=(-2)\cdot (-3)=(-3) \cdot (-2)$. Some well known rings of integers are e.g. the Gaussian integers $\Z[i]=\{a+b i : a,b, \in \Z\}$ (with $i$ some squareroot of $-1$), the Eisenstein integers $\Z[(1+\sqrt{-3})/2]$, and the \lq real\rq\ quadratic ring $\Z[\sqrt{2}]$. They all have in common that they are also UFD's, like $\Z$. However, this is certainly not true for all rings of integers. For example $\Z[\sqrt{-5}]$ is \emph{not} a UFD: $6=2\cdot3=(1+\sqrt{-5}) (1-\sqrt{-5})$ provide two essentially different ways to factor $6$ in irredicible elements in $\Z[\sqrt{-5}]$.
As it turns out, there is a beautiful way to remedy this. Namely by considering factorization of \emph{ideals} instead of elements: for a number field $K$, with ring of integers $\OK$, every nonzero ideal of $\OK$ can be factored into prime ideals in a unique way, up to the order of the factors.
%TODO? ?Talk about unique factorization monoid?

Although unique factorization in terms of ideals is of great importance and beauty, it is still very interesting, and for many arithmetic applications necessary, to also consider factorization properties in terms of elements. For this, one can consider the nonzero fractional ideals of $\OK$ modulo the units $K^*$, which a priori has the structure of a commutative monoid, but actually turns out to be a group, called the \emph{class group} of $\OK$. An important theorem is that $\OK$ is finite. The interpretation is that its order, called the \emph{class number}, measures how far away $\OK$ is from being a UFD. In particular, the class group of $\OK$ is trivial if and only if $\OK$ is a UFD.


%%
Now talk about the more general setting and describe more explicitly  the different theorems concerning Dedekind domains, class groups, etc.
%%

The intrinsic algebraic properties of $\OK$ are very nice. In particular, every ring of integers $\OK$ is a \emph{Dedekind domain}. The latter can be defined as a domain $D$ which is Noetherian (i.e. every ideal of $D$ is finitely generated), integrally closed (i.e. if $x$ is in the fraction field of $D$ and a root of a monic polynonial with coefficients in  $D$, then actually $x \in D$), and of Krull dimension at most $1$ (i.e. every nonzero prime ideal of $D$ is maximal).

%% Generalize

%Both generalizing algebraic aspects to general definitions and theorems in commutative algebra, most notably about Dedekind domains (defined below), and generalizing number theoretic aspect to also include function fields, i.e. finite field extensions of the fraction field of the polynomial ring $(\Z/p\Z)[t]$ (with $p$ prime)


\section{Number fields, global fields and rings of integers}

A number field is a finite field extension of $\Q$.
Number fields are a basic concept in algebraic number theory. Examples: ....
We formalized number fields as the following typeclass:
\begin{lstlisting}
class is_number_field (K : Type*) [field K] :=
[cz : char_zero K] [fd : finite_dimensional ℚ K]
\end{lstlisting}
The condition \lean{[cz : char\_zero K]} states that $K$ has characteristic zero, i.e. the canonical ring homomorphism $\Z \to K$ is an embedding.
This implies that there is a $\Q$-algebra structure on $K$ (found by typeclass search), this gives the vector space structure used in the \lean{[fd : finite\_dimensional ℚ K]} hypothesis.

\subsection{Field extensions}

The definition of \lean{is\_number\_field} illustrates our treatment of field extensions.
In informal mathematics, a field $L$ containing a subfield $K$ is said to be a field extension $L / K$.
Often we encounter towers of field extensions: we might have that $\Q$ is contained in $K$, $K$ is contained in $L$, $L$ is contained in an algebraic closure $\bar{K}$ of $K$, and $\bar{K}$ is contained in $\C$.
We might formalize this situation by viewing $\Q$, $K$, $L$ and $\bar{K}$ to be sets of complex numbers $\C$ and defining field extensions as subset relations between these subfields.
This way, no coercions need to be inserted to map elements of one field into a larger field.
% I believe this is what mathcomp does; verify?
In type theory we cannot define $\Q$ as a subset of $\C$ since we need $\Q$ to define $\C$.
Thus, some coercion is always needed to go from the original definition of $\Q$ to its image in $\C$; and similar issues arise for other subfields that were not originally defined as such.
Moreover, such an approach loses flexibility since we need to fix the top field, of which all others are subfields, at the start of our development and cannot adjoin more elements when needed.

Instead, we formalize results about field extensions by parametrization.
The lemma statement is parametrized over abritrary types $K$ and $L$ with a field structure,
along with the hypothesis ``$L$ is a field extension of $K$'', represented by an instance parameter \lean{[algebra K L]}.
This provides us with a canonical ring homomorphism $\lean{algebra\_map K L} : K \to L$; this map is injective because $K$ and $L$ are fields.
In other words, field extensions are given by their canonical embeddings.

\subsection{Scalar towers} \label{sec:scalar_tower}

The main drawback of using arbitrary embeddings to represent field extensions is that we need to prove that these maps commute.
For example, we might start with a field extension $L / \Q$, then define a subfield $K$ of $L$,
resulting in a tower of extensions $L / K / \Q$.
In such a tower, the map $\Q \to L$ should be equal to the composition $\Q \to K \to L$.
The example has other maps depend on the map $\Q \to L$, so we cannot arrange the coherence condition by defining $\Q \to L$ after the fact.

The solution in \mathlib is to parametrize over all three maps, as long a there is also a proof of coherency:
a hypothesis of the form ``$L / K / F$ is a tower of field extensions'' is translated to three instance parameters \lean{[algebra F K]}, \lean{[algebra K L]} and \lean{[algebra F L]},
along with an additional parameter \lean{[is\_scalar\_tower F K L]} expressing that the maps commute.

The \lean{is\_scalar\_tower} typeclass derives its name from its applicability to any three types between which exist scalar multiplication operations:
\begin{lstlisting}
class is_scalar_tower (M N α : Type*) [has_scalar M N] [has_scalar N α]
  [has_scalar M α] : Prop :=
(smul_assoc : ∀ (x : M) (y : N) (z : α), (x • y) • z = x • (y • z))
\end{lstlisting}
For example, if $R$ is a ring, $A$ is an $R$-algebra and $M$ an $A$-module, we can express the fact that $M$ is also an $R$-module by adding a \lean{[is\_scalar\_tower R A M]} parameter.
Since \lean{x $\cdot$ y} for an $R$-algebra $A$ is defined as \lean{algebra\_map R A x * y}, applying \lean{smul\_assoc} for each $x$ with $y = z = 1$ shows that the \lean{algebra\_map}s indeed commute.

The typeclass system is set up to automatically provide common \lean{is\_scalar\_tower} instances,
such as for the maps $R \to S \to A$ when $S$ is a $R$-subalgebra of $S$.
The effect is that almost all coherence proof obligations are automatically solved from known results or filled in from parameters.
In our formalization, we found that the \lean{is\_scalar\_tower} typeclass translates towers of field extension well.

\subsection{Ring of integers} \label{sec:ring-of-integers}

A number ring is defined as a ring whose fraction field is a number field, the ring of integers $\OK$ is an important example.
The ring of integers in $K$ is defined as the integral closure of $\Z$ in $K$.
This is the subring containing those $x : K$ that are the root of a monic polynomials with coefficients in $\Z$:
\begin{lstlisting}
def ring_of_integers (K : Type*) [field K] [is_number_field K] :
  subalgebra ℤ K :=
integral_closure ℤ K
\end{lstlisting}
where \lean{integral\_closure} was previously defined in mathlib as follows:
\begin{lstlisting}
def integral_closure (R A : Type*) [comm_ring R] [comm_ring A]
  [algebra R A] : subalgebra R A :=
{ carrier := { r | is_integral R r },
  .. /- proofs omitted -/ }
\end{lstlisting}

Some examples of rings of integers include $\Z$ and $\Z[\iota]$. We prove ahead that the ring of integers of a number field is, in fact, a Dedekind domain. Moreover, it is a finitely-generated free $\Z$-module, with rank equal to the degree of the number field over $\Q$.

%Will add more after completing proof

\subsection{Subobjects}

The ring of integers are one example of a subobject, such as a subfield, subring or subalgebra, defined through a characteristic predicate.
In mathlib, a subobject is defined as a bundled structure comprising the carrier set,
along with proofs showing the carrier set is closed under the relevant operations.

Two new subobjects we needed in our development were \lean{subfield} and \lean{intermediate\-\_field}.
We define a subfield of a field $K$ as a subset of $K$ that contains $0$ and $1$ and is closed under addition, negation, multiplication, and taking inverses.
If $L$ is a field extension of $K$, we define an intermediate field as a subfield that is also a subalgebra: a subfield that contains the image of $\lean{algebra\_map K L}$.
Other examples of subobjects available in mathlib are submonoids, subgroups and submodules (with ideals as a special case of submodules).

The new definitions found immediate use:
soon after we contributed our definition of \lean{intermediate\_field} to \mathlib,
the Berkeley Galois theory group used it in a proof of the primitive element theorem.
Soon after the primitive element theorem was merged into \mathlib,
we used it in our development of the trace form.
This anecdote illutrates the decentralized development style of \mathlib,
with different groups and people building on each other's results in a collaborative process.

By providing a coercion from subobjects to types, sending a subobject $S$ to the subtype of all elements of $S$,
and putting typeclass instances on this subtype,
we can reason about inductively defined rings such as $\Z$ and subrings such as \lean{integral\_closure $\Z$ K} uniformly.
If $S : \lean{subfield}\ K$, the map that sends $x : S$ to $K$ by ``forgetting'' that $x \in S$ is a ring embedding,
and we register this map as a \lean{algebra S K} instance, also allowing us to treat field extensions of the form $\Q \to \C$ and subfields uniformly.
Similarly, for $F : \lean{intermediate\_field K L}$, we defined the corresponding \lean{algebra K F}, \lean{algebra F L} and \lean{is\_scalar\_tower K F L} instances.

\subsection{Fraction fields}
The fraction field $\Frac R$ of an integral domain $R$ can be defined explicitly as a quotient type as follows:
starting from the set of pairs $(a,b)$ with $a,b \in R$ such that $b\neq 0$,
one quotients by the equivalence relation stating that $(\alpha a, \alpha b) \sim (a,b)$ for all $\alpha \ne 0 : R$, writing the equivalence class of $(a,b)$ as $\frac{a}{b}$.
It can easily be proved that the ring structure on $R$ extends uniquely to a ring structure turning $K$ into a field.
When $R=\Z$, this yields the traditional description of $\Q$ as the set of equivalence classes of fractions, where $\frac{2}{3}=\frac{-4}{-6}$, etc.
The drawback of this construction is that it hides a crucial property of fraction fields, which can be informally phrased as being ``the smallest field containing $R$''.
Indeed, although it is easy to check that no subfield of $\Frac R$ can contain $R$, one can often encounter a field $K$, with an injective map $f\colon R\to K$, having no subfield with this property, and yet not being equal to $\Frac R$, but simply \emph{isomorphic} to it. For instance, although there is an isomorphism of $\Frac \C[\![t]\!]$ with the field
\[
\C(\!(t)\!)=\big\{\sum_{i=a}^{+\infty} a_it^i\quad\text{ with }a \in \Z\big\}
\]
of Laurent series, there is no (definitional) equality between the types. Another example comes from the field
\[
\Q(i)=\{z \in \C : \Re z \in \Q, \Im z\in\Q\}
\]
which is isomorphic to $\Frac (\Z[i])$, but not definitionally equal to it.
In fact, even the rational numbers in Lean are a counterexample:
for computational efficiency, they are defined as a subtype where the numerator and denominator are coprime,
instead of a quotient by ``scalar multiplication''.

A definition like
\begin{lstlisting}
def fraction_field (R : Type*) : Type* :=
{ab : R × R // ab.2 ≠ 0}
\end{lstlisting}
would require transferring results across isomorphisms as soon as one needs to handle a different construction of a field isomorphic to $\Frac R$.

The strategy we have chosen is to rather allow for many different \emph{fraction fields} of our given integral domain $R$, as fields $K$ receving an injective map $f\colon R\to K$ which satisfies a certain ``minimality property'', and to make this part of the data of every result. To make this precise\dots

\bigskip


A fraction field $K$ of an integral domain $R$ is the smallest field that contains $R$ (or some other equivalent definitions).
The choice of $K$ is only unique up to isomorphism.
In particular, the generic construction of a fraction field of $\Z$ does not yield $\Q$.
One solution is to build a transfer tactic, the other is to state our theorems parametrized by $K$, along with a proof that $K$ is a fraction field of $R$.

The mathlib definition of fraction fields is based around the localization map. Let $R$ and $K$ be (commutative) rings with submonoid $P \subset R$, then $f : R \to K$ is a localization map if ..., expressed formally as the following structure:

The localization map $f$ endows $K$ with an $R$-algebra structure.

If the submonoid $P$ consists of all non-zero-divisors of $R$, we say that $f$ is a fraction map, and if $R$ is an integral domain, $K$ is a field. We call $K$ the fraction field of $R$.

The choice of $R$-algebra structure on $K$ is not unique, so we use a type synonym \lean{f.codomain}. This instructs the type class system to use the algebra instance derived from the localization map $f$.

In the following sections, let $f : R \to K$ be a fraction map.

\subsection{Fractional ideals}

When working with fraction fields, it is useful to extend the notion of $R$-ideals to fractional ideals:
these are $R$-ideals divided by some $x : R$,
or equivalently $R$-submodules $I$ of $K$ such that there is an $x : R$ with $x I \subseteq R$.
We formalized the latter definition as a type \lean{fractional\_ideal f}.
The dependency on $f$ follows from the module structure on $K$ being determined by $f$.
Despite the dependency, the structure of fractional ideals does not depend on the choice of fraction map $f$,
which we formalized as an isomorphism \lean{fractional\_ideal.canonical\_equiv} between the fractional ideals on two different fraction fields $K, K'$ of $R$.

We defined the addition, multiplication and intersection operations on fractional ideals,
by showing the corresponding operations on submodules map fractional ideals to fractional ideals.
We also proved that these operations give a commutative semiring structure on the type of fractional ideals.
For example, multiplication of fractional ideals is defined as:
\begin{lstlisting}
lemma fractional_mul (I J : fractional_ideal f) :
  is_fractional f (I.1 * J.1) := _ -- proof omitted

instance : has_mul (fractional_ideal f) :=
⟨λ I J, ⟨I.1 * J.1, fractional_mul I J⟩⟩
\end{lstlisting}

Defining the quotient of two fractional ideals requires slightly more work.
The submodule quotient $I / J$\footnote{The $:$ operator typically used for the submodule quotient is already reserved by the type theory, so \mathlib uses $/$ instead.} is characterized by the property
\begin{lstlisting}
lemma submodule.mem_div_iff_forall_mul_mem {x : A} {I J : submodule R A} :
  x ∈ I / J ↔ ∀ y ∈ J, x * y ∈ I
\end{lstlisting}
However, if $J$ contains only the element $0$,
then $xy = 0 \in I$ for all $y \in J$, so all $x : A$ are elements of $I / J$.
The submodule consisting of all $x : A$ is not a fractional ideal in general,
so we cannot simply define the quotient of two fractional ideals to be the submodule quotient.
Instead we set $I / 0 = 0$, resulting in the following definition of the fractional ideal quotient:
\begin{lstlisting}
noncomputable instance fractional_ideal.has_div :
  has_div (fractional_ideal g) :=
⟨λ I J, if h : J = 0 then 0 else ⟨I.1 / J.1, fractional_div_of_nonzero h⟩⟩
\end{lstlisting}

In general, if there is a multiplicative inverse $J$ of $I$, such that $I J = J I = 1$, then $J = 1 / I$.
However, the converse does not always hold: $1 / I$ is not always the multiplicative inverse of $I$.
Indeed, the condition that $1 / I$ is an inverse for all $I$ is one of the equivalent definitions of a Dedekind domain.
Therefore, we defined the inverse operator $\cdot^{-1}$ only for fractional ideals in a Dedekind domain:
\begin{lstlisting}
noncomputable instance [is_dedekind_domain R] (g : fraction_map R K) :
  has_inv (fractional_ideal g) :=
⟨λ I, 1 / I⟩
\end{lstlisting}

Defining the inverse in terms of the quotient caused a problem later on, when we tried to define a \lean{group\_with\_zero} instance for fractional ideals in a Dedekind domain.
Groups with zero are defined in \mathlib as monoids with multiplication $*$ and identity $1$ along with an absorbing element $0$ and an inverse $x^{-1}$ for all $x \ne 0$; for completeness $0^{-1}$ is defined as $0$.
An important class of examples are fields, if we ignore the addition operator $+$.

The \lean{group\_with\_zero} typeclass defines its own division operator, $x / y := x y^{-1}$,
resulting in a definitionally unequal second interpretation of $I / J = I * (1 / J)$.
We were able to fix this issue by including the division operator as a field in \lean{group\_with\_zero},
along with a field $\lean{div\_eq\_mul\_inv} : \forall\ a\ b, a / b = a * b^{-1}$.
This resulted in weakening $a / b = a * b^{-1}$ from a definitional equality to a propositional equality.
As a consequence, many \lean{group\_with\_zero} instances and proofs throughout \mathlib needed slight changes to explicily rewrite $x / y$ to $x * y^{-1}$ instead of using unification to implicitly do so; in total hundreds of lines of code needed to be changed.

\subsection{Representing simple field extensions}

A number field $K$ is defined as a finite extension of $\Q$, or equivalently a field of the form $\Q(\alpha)$ for some algebraic number $\alpha$.
A field extension $L / K$ is called \emph{simple} if there is an $\alpha$ algebraic over $K$, called the \emph{primitive element}, such that $L = K(\alpha)$.
The primitive element theorem states that a finite, separable extension is simple; the converse holds if the primitive element $\alpha$ is separable.

The exact choice of these $\alpha$ and $K(\alpha)$ are underspecified in informal mathematical usage.
We can find $K(\alpha)$ by adjoining the root of a polynomial: there is an irreducible polynomial $p \in K[X]$ such that $K[X] / p \simeq L$; we set $\alpha$ to be the image of $X$ in $K[X] / p$.
We can also take $\alpha : \bar{K}$, the algebraic closure of $K$, set $K(\alpha)$ to be the smallest subfield of $\bar{K}$ that contains $\alpha$ and the image of $K$, and have an equality $L = K(\alpha)$ as subsets of $\bar{K}$.
Similarly, we can take $\alpha : L$ and $K(\alpha)$ to be the smallest subfield of $L$ containing $\alpha$ and the image of $K$; then $L = K(\alpha)$ means that $K(\alpha)$, as a subfield of $L$, is equal to the subfield $\top$ containing all elements of $L$.

Because $\alpha$ is algebraic the smallest subring containing $\alpha$ and $\Q$ will be a field, thus we can add two more representations, replacing ``smallest subfield'' with ``smallest subring''.
Moreover, all subfields/subrings containing $K$ are also $K$-algebras, so we can additionally replace ``subfield'' with ``intermediate field'' and ``subring'' with ``$K$-subalgebra''.

The ability to switch between these representations is important: sometimes $K$ and $L$ are fixed and we want an arbitrary $\alpha$; sometimes $\alpha$ is fixed and we want an arbitrary type representing $K(\alpha)$.
The different constructions of $K(\alpha)$ have already been formalized in \mathlib:
$K[X] / p$ is a type called \lean{adjoin\_root p};
$K(\alpha)$ as smallest $K$-subalgebra containing $\alpha$ is called \lean{subalgebra.adjoin $K$ \{$\alpha$\}},
which itself is defined as the smallest subring containing the image of $K$ and $\alpha$.
After we contributed intermediate fields and subfields to \mathlib,
the smallest intermediate field containing $\alpha$ was defined \lean{intermediate\_field.adjoin $K$ \{$\alpha$\}},
which itself is defined as the smallest field containing the image of $K$ and $\alpha$,
along with a formalization of the primitive element theorem:
\begin{lstlisting}
theorem exists_primitive_element
  [finite_dimensional F E] [is_separable F E] :
  ∃ α : E, intermediate_field.adjoin F {α} = ⊤
\end{lstlisting}

Note that the choice of $\alpha$ (or the irreducible polynomial $p$) is not unique in general; both $3^\frac{1}{3}$ and $3^\frac{2}{3}$ generate $\Q(\sqrt[3]{3})$.
This means none of the above conditions provides a uniform way of reasoning about simple extensions:
if we use a predicate like ``finite, separable extension'' we cannot guarantee that the primitive element chosen for $K(\alpha)$ is indeed $\alpha$.
If we need to choose an $\alpha$ ahead of time and prove a result about $K(\alpha)$, we need extra work to transfer the result across the isomorphism $K(\alpha) \simeq L$.

We chose instead to use a \emph{power basis} to represent simple field extensions, a basis of the form $1, x, x^2, \dots, x^{n-1} : A$ (viewing $A$ as an $R$-module).
We call $x$ the \emph{generator} and $n$ the \emph{dimension} of this power basis.
In Lean, we defined the following structure, bundling the information of a power basis:
\begin{lstlisting}
structure power_basis (R A : Type*) [comm_ring R] [ring A]
  [algebra R A] :=
(gen : S) (dim : ℕ)
(is_basis : is_basis R (λ (i : fin dim), gen ^ (i : ℕ)))
\end{lstlisting}

% TODO: or just refer here to the names of the Lean functions?
If $x : A$ is the generator of a power basis over $R$, it is also integral over $R$:
let $n$ be the dimension of the power basis, then $x^n : A$ can be written as $x^n = \sum_i c_i x^i$ for some coefficients $c_i : R$;
thus $p(X) = X^n - \sum_i c_i X^i$ is a polynomial with root $x$.
That $p$ has minimal degree, follows from the linear independence of the powers of $x$ up to $n$.
Conversely, for algebraic (and therefore integral) $\alpha$, $\Q(\alpha)$ has a power basis generated by $\alpha$.
This shows that the condition of having a power basis is equivalent to being a simple field extension.

With the \lean{power\_basis} structure, we have the ability to parametrize our results,
being able to choose the $K$ and $L$ in a simple field extension $L / K$,
or being able to choose the $\alpha$ generating $K(\alpha)$ (packaged up as \lean{power\_basis.gen\ pb}).
Specializing a result from an arbitrary $L$ with a power basis over $K$, to \lean{adjoin K \{$\alpha$\}} specifically, is a matter of applying the result to the power basis generated by $\alpha$, and rewriting $\lean{power\_basis.gen (adjoin.power\_basis K $\alpha$)} = \alpha$.


\section{Defining Dedekind domains} \label{sec:Dedekind-domain}

The ring of integers $\OK$ satisfies many useful algebraic properties.
An important class of integral domains that satisfy many of these properties is the class of \emph{Dedekind domains},
and these play a fundamental role in algebraic number theory.
There are various equivalent conditions, used at various times, for an integral domain $R$ being a Dedekind domain,
of which the following three have been formalized in \mathlib:
\begin{itemize}
\item \lean{is\_dedekind\_domain R}: $R$ is a Noetherian integral domain, integrally closed in its fraction field and has Krull dimension at most $1$.
\item \lean{is\_dedekind\_domain\_inv R}: $R$ is an integral domain and nonzero fractional ideals of $R$ have a multiplicative inverse.
\item \lean{is\_dedekind\_domain\_dvr R}: $R$ is a Noetherian integral domain and the localization of $R$ at each prime ideal is a discrete valuation ring.
\end{itemize}
We did not use \lean{is\_dedekind\_domain\_dvr} in our project, so we will not discuss this definition further.

Some authors exclude fields from being Dedekind domains, a convention we initially followed.
Since we did not encounter any cases where excluding fields was necessary to prove a theorem,
we decided to simplify the definition of a Dedekind domain.
It is still possible to exclude fields in a theorem by adding an extra hypothesis \lean{¬ is\_field R}.

The ``main'' definition was chosen to be \lean{is\_dedekind\_domain},
since this condition is usually the one checked in practice~\cite{Neukirch}.
The other two equivalent definitions were added \mathlib, before the proof they are indeed equivalent.
Having multiple definitions allowed us to do our work in parallel without depending on unformalized results.
For example,
the proof of unique ideal factorization in a Dedekind domain initially assumed \lean{is\_dedekind\_domain\_inv R},
and the proof that the ring of integers is a Dedekind domain concluded \lean{is\_dedekind\_domain (ring\_of\_integers K)}.
After the equivalence between \lean{is\_dedekind\_domain R} and \lean{is\_dedekind\_domain\_inv R} was formalized,
we could painlessly replace usages of \lean{is\_dedekind\_domain\_inv R} with \lean{is\_dedekind\_domain R}.
Separating the different definitions meshed well with the contribution philosophy followed by \mathlib, preferring small, standalone additions over in-progress work or entire finished projects.
% This is basically how gregkh described the ideal Linux patch in a talk, but I can't find a good source.

The conditions \lean{is\_dedekind\_domain} and \lean{is\_dedekind\_domain\_inv} require a fraction field $K$,
although the truth value of the predicates does not depend on the choice of $K$.
For ease of use, we let the type of \lean{is\_dedekind\_domain} only depend on the domain $R$
by instantiating $K$ in the definition as \lean{fraction\_ring R}.
\begin{lstlisting}
class is_dedekind_domain (R : Type*) [integral_domain R] : Prop :=
(to_is_noetherian_ring : is_noetherian_ring R)
(dimension_le_one : dimension_le_one R)
(is_integrally_closed : integral_closure R (fraction_ring R) = ⊥)
\end{lstlisting}
Applications of \lean{is\_dedekind\_domain} can choose a specific fraction field through the following lemma exposing the alternate definition:
\begin{lstlisting}
lemma is_dedekind_domain_iff (f : fraction_map R K) :
  is_dedekind_domain R ↔
    is_noetherian_ring R ∧ dimension_le_one R ∧
    integral_closure R f.codomain = ⊥
\end{lstlisting}

We mark \lean{is\_dedekind\_domain} as a typeclass by using the keyword \lean{class} rather than \lean{structure},
allowing the typeclass system to automatically infer the Dedekind domain structure when an appropriate instance is declared,
such as for principal ideal domains or rings of integers.

\section{Equivalence of the definitions} \label{sec:equivalence}

In this section, we describe how we proved that the two definitions of Dedekind domain \lean{is\_dedekind\_domain} and \lean{is\_dedekind\_domain\_inv} are equivalent.

We use the proof given in Cassels and Frohlich's Algebraic Number Theory (Chapter 1, Section 2, Proposition 1) to show that \lean{is\_dedekind\_domain\_inv} implies \lean{is\_dedekind\_domain}. A constant challenge that was faced while coding this proof is that one must work with pushforwards and pull backs of elements that belong to the ring, and hence to its localisation. The proofs for integrally closed and dimension being less than or equal to one are fairly straightforward.

Proving the Noetherian condition was the most challenging.
In the original proof by Cassels and Frohlich, they consider elements $a_1, \dots, a_n \in I$ and $b_1, \dots, b_n \in I^{-1}$ for any nonempty fractional ideal $I$,
such that $ \sum_i a_i b_i = 1 $.
However, it is quite challenging to prove that an element of the multiplication of two $R$-submodules $M$ and $N$ must be of the form $\sum_{i = 1}^m a_i*b_i$, for $a_i \in A$ and $b_i \in B$ for all $1 \leq i \leq m$.
Instead, we show that, for every element of an ideal, there exists a \lean{finset} whose span is contained in the ideal, and which contains the element.
This is accomplished by the lemma \lean{submodule.mem\_span\_mul\_finite\_of\_mem\_span\_mul}.
Now considering an ideal $s$ of the ring $A$, due to its invertibility, by \lean{submodule.mem\_span\_mul\_finite\_of\_mem\_span\_mul}, we obtain \lean{finset A} $T \subset s$ and $T' \subset 1/s$, such that 1 is contained in the span of $T*T'$.
This is then sufficient to show that $s$ is finitely generated, as shown in the lemma \lean{fg\_of\_one\_mem\_span\_mul}.

The theorem \lean{fractional\_ideal.mul\_inv\_cancel} proves the converse, that \lean{is\_dedekind\_domain} implies \lean{is\_dedekind\_domain\_inv}.
The proof goes along these lines: we differentiate into cases when the Dedekind domain $A$ is and is not a field.
This is done because our main argument requires that every non-zero ideal must contain a product of non-zero prime ideals (\lean{exists\_prime\_spectrum\_prod\_le\_and\_ne\_bot\_of\_domain}),
and fields don't have non-zero prime ideals.
The field case is trivial, since the only non-zero fractional ideal in a field is the field itself (\lean{fractional\_ideal.eq\_zero\_or\_one\_of\_is\_field}).
When $A$ is not a field, the standard proof first shows that it is suffices that maximal ideals of $A$ are invertible~\cite[Proposition 3.8]{Neukirch}.
% using the factorization of into prime ideals (which are maximal in a Dedekind domain), but we show something more general.
We show in general that it is sufficient to prove invertibility for non-zero ideals of $R$.
This is done in the lemma \lean{coe\_ideal\_mul\_one\_div}.
We consider, for a non-zero ideal $I$, the ideal $J := I * (1/I)$, and show that $1/J \leq 1 \le J$, hence $J = 1$ since $J \le 1$ holds in an arbitrary domain. So, we want to show that any element $x \in 1/J$ is in $R$, or equivalently, since we have \lean{is\_dedekind\_domain R}, it suffices to prove that $x$ is in the integral closure of $R$. We consider $A := R[x]$, and show that $A \leq 1/I$, which is Noetherian, hence $A$ is a finitely generated subalgebra containing $x$. It suffices to prove that for every $n \in \mathbb{N}$, $x^n \in 1/I$. This follows from \lean{h₁ : (submodule.span R {x} * (1 / ↑I : fractional_ideal f).val) ≤
      (1 / ↑I : fractional_ideal f).val}. This follows from repeated usage of the lemma \lean{submodule.mem\_div\_iff\_forall\_mul\_mem} and \lean{fractional\_ideal.coe\_div}. The latter statement requires $I$ and $J$ to be non-zero. 

\section{Principal ideal domains are Dedekind}

As an example of our definitions, we will discuss in some detail our formalization of the fact that a principal ideal domain is a Dedekind domain.
A principal ideal domain (PID) is an integral domain $R$ such that each ideal is generated by one element.
There is no explicit definition of PIDs in \mathlib, rather it is split up into two hypotheses.
One uses \lean{[integral domain R] [is\_principal\_ideal\_ring R]} to denote a PID $R$,
where \lean{is\_principal\_ideal\_ring} is a typeclass defined for all commutative rings:
\begin{lstlisting}
class is_principal_ideal_ring (R : Type*) [comm_ring R] : Prop :=
(principal : ∀ (S : ideal R), S.is_principal)
\end{lstlisting}

Our proof that the hypotheses \lean{[integral\_domain A] [is\_principal\_ideal\_ring A]} imply \lean{is\_dedekind\_domain A} is relatively short:
\begin{lstlisting}
instance principal_ideal_ring.to_dedekind_domain (A : Type*)
  [integral_domain A] [is_principal_ideal_ring A] :
  is_dedekind_domain A :=
⟨principal_ideal_ring.is_noetherian_ring,
 dimension_le_one.principal_ideal_ring _,
 unique_factorization_monoid.integrally_closed (fraction_ring.of A)⟩
\end{lstlisting}

Making this an \lean{instance} instead of a \lean{lemma} ensures that the typeclass system can now automatically infer a Dedekind domain structure whenever a principal ideal structure is already available.

The Noetherian property of a Dedekind domain follows easily by the previously defined lemma \lean{principal\_ideal\_ring.is\_noetherian\_ring}, since, by definition, each ideal in a principal ideal ring is finitely generated (by a single element).

The lemma \lean{dimension\_le\_one.principal\_ideal\_ring} is an instantiation of the existing result \lean{is\_prime.to\_maximal\_ideal} showing a nonzero prime ideal in a PID is maximal.
The latter lemma uses the characterization that $I$ is a maximal ideal if and only if any strictly larger ideal $J > I$ is the full ring $\top$.
% This proof is probably a bit too detailed: if someone wanted to know all details, they can read the formalization.
%The proof says : suppose a prime ideal I is properly contained in an ideal J, then $1 \in J$. Let $i \in I$ and $j \in J$ be generators of $I$ and $J$ respectively. Since $I \subset J$, $\exists a \in A$ such that $i = a * j$. Since $I$ is a prime ideal, this implies that either $a \in I$ or $j \in I$. The latter would imply that $I = J$, which contradicts our assumption that $I$ is properly contained in $J$. The former would imply that $\exists k \in A$ such that $a = k * i = k * (a * j)$. Since $A$ is an integral domain, we then have $k * j = 1$, which implies that $1 \in J$, as required. 
If $I$ is a nonzero prime ideal and $J > I$ in the PID $R$, we have that the generator $j$ of $J$ is a divisor of the generator $i$ of $I$. Since $I$ is prime, this implies that either $j \in I$, contradicting the assumption that $J > I$, $i = 0$, contradicting that $I$ is nonzero, or that $j$ is a unit, implying $J = \top$ as desired.

The final condition of a PID being integrally closed is the most challenging.
We use the previously defined instance \lean{principal\_ideal\_ring.to\_unique\_factorization\_monoid} that a PID is a unique factorisation monoid (UFM),
to instantiate our proof that every UFM is integrally closed.
In the same way that principal ideal domains are generalized to principal ideal rings, \mathlib generalizes unique factorization domains to unique factorization monoids.
A commutative monoid $R$ with an absorbing element $0$ and injectivity of multiplication is defined to be a UFM,
if the relation ``$x$ properly divides $y$'' is well-founded (implying each element can be factored as a product of irreducibles) and
an element of $R$ is prime if and only if it is irreducible (implying the factorization is unique).
The first condition is satisfied for a PID since the Noetherian property implies that the division relation is well-founded.
The second condition follows from \lean{principal\_ideal\_ring.irreducible\_iff\_prime}.
To prove that an irreducible element $p$ is prime, the proof uses that prime elements generate prime ideals and irreducible elements of a PID generate maximal ideals. Since all maximal ideals are prime ideals, the ideal generated by $p$ is maximal, hence prime, thus $p$ is prime.
The lemma \lean{irreducible\_of\_prime} proves the converse holds in any commutative monoid with zero.

In order to show that a UFM is integrally closed, we first proved the Rational Root Theorem, named \lean{denom\_dvd\_of\_is\_root},
which states that for polynomial $p : R[X]$ and $x$ an element of the fraction field $K$ such that $p(x) = 0$, the denominator of $x$ divides the leading coefficient of $p$.
If $x$ is integral with minimal polynomial $p$, the leading coefficient is $1$, therefore the denominator is a unit and $x$ is an element of $R$.
This gives us the required lemma \lean{unique\_factorization\_monoid.integrally\_closed}, which states that the integral closure of A in its fraction field is A itself.

\section{Ring of integers are Dedekind domains} \label{sec:integral-closure}

An important class of Dedekind domains consists of the rings of integers of number fields.
We defined the ring of integers of a number field $K$ as the integral closure $\Z$ in $K$.
We proved a stronger result: let $R$ be a Dedekind domain with fraction field $K$, if $L$ is a finite separable extension of $K$, then the integral closure of $R$ in $L$ is a Dedekind domain with fraction field $L$.
Our approach is based on Neukirch, theorem 3.1, with adaptations to match the available results in \mathlib. % TODO: cite
Throughout this section, $R$ will be an integral domain with fraction field $K$ (given by the map $f : R \to K$), $L$ a field extension of $K$ and $S$ the integral closure of $R$ in $L$,
corresponding to the following Lean declarations:
\begin{lstlisting}
variables {R K L : Type*} [integral_domain R] [field K] [field L]
variables (f : fraction_map R K)
variables [algebra f.codomain L] [algebra R L] [is_scalar_tower R L]
notation `S` := integral_closure R L
\end{lstlisting}

The first step is showing $L$ is indeed the fraction field of the integral closure,
i.e. that there is a \lean{fraction\_map (integral\_closure R L) L}.
We formalized the following two results, where the first implies the second:
\begin{lstlisting}
def fraction_map_of_algebraic (alg : is_algebraic R L)
  (inj : function.injective (algebra_map R L)) :
  fraction_map S L

def fraction_map_of_finite_extension [finite_dimensional f.codomain L] :
  fraction_map S L
\end{lstlisting}
The main contents of \lean{fraction\_map\_of\_algebraic} consist of showing that all elements $x : L$ can be written as $y / z$ for integral elements $y, z$;
the standard proof of this fact formalizes readily. % TODO: a nice proof to refer to: Neukirch?
%Since $x$ is algebraic over $A$, it satisfies an equation $a_n x^n + a_{n-1} x^{n-1} + \cdots + a_0 = 0$, with $a_n, \dots, a_0 : A$.
%Multiplying each term by $a_n^{n-1}$, we see $(a_n x)^{n} + a_{n-1} (a_n x)^{n - 1} + \cdots + a_0 a_n^{n-1} = 0$,
%therefore $a_n x$ is integral, and we can write $x = (a_n x) / a_n$.

Now we are ready to show the integral closure of $R$ in $L$ is a Dedekind domain,
by proving it is integrally closed in $L$, has Krull dimension at most one and is Noetherian.
The fact that the integral closure is integrally closed is immediate.

To show the Krull dimension is at most one, we needed to develop basic going-up theory for ideals.
In particular, we show that an ideal $I$ in an integral extension is maximal if it lies over a maximal ideal,
and use a result already available in \mathlib that a prime ideal $I$ in an integral extension lies over a prime ideal.
\begin{lstlisting}
lemma is_maximal_of_is_integral_of_is_maximal_comap
  {S : Type*} [integral_domain S] [algebra R S]
  (hRS : algebra.is_integral R S) (I : ideal S) [I.is_prime]
  (hI : is_maximal (I.comap (algebra_map R S))) : is_maximal I

theorem is_prime.comap [hK : K.is_prime] : (comap f K).is_prime
\end{lstlisting}

\subsection{Integral closure is Noetherian}
The final condition, that the integral closure of $R$ in $L$ is a Noetherian ring, requires the most work.
It suffices to show that the integral closure is contained in a finitely generated $R$-module $M$,
since the well-founded order on $R$-submodules of $M$ restricts to a well-founded order on ideals of $S$.
\cite{Dummit-and-Foote}, theorem 15.29, proves that the integral closure of $\Z$ in $L$ is a finitely generated free $\Z$-module,
by first showing it is contained in a finitely generated $\Z$-module, and deriving the conclusion from this result.
If we weaken the assumptions, taking the integral closure of an arbitrary Dedekind domain $R$,
the first part of the proof still goes through.

Our formal proof that $S$ is a Noetherian ring adapts this first half of Dummit and Foote's proof.
Suppose we have a family of basis elements $b : \iota \to L$, such that each $b_i$ is integral,
and let $B$ be a nondegenerate bilinear form such that all integral $x, y : L$ satisfy $B(x, y) \in \lean{integral\_closure}\ R\ L$.
If $L$ is separable over $K$ and $R$ is integrally closed in $K$,
then there is a ``dual basis'' $b'$ also indexed by $\iota$, such that the integral closure is contained within the $R$-span of $b'$.
In particular, the $i$'th coordinate of $x : L$ according to the dual basis $b'$ satisfies $x_i = B(b_i, x)$,
therefore $x_i \in R$ if $x \in S$.
This gives the following result:
\begin{lstlisting}
lemma integral_closure_le_span
  [is_separable (localization_map.codomain f) L]
  {ι : Type*} [fintype ι] {b : ι → L} (hb : is_basis f.codomain b)
  (hb_int : ∀ i, is_integral R (b i))
  (int_cl : integral_closure R f.codomain = ⊥) :
  (S : submodule R L) ≤ submodule.span R (set.range (dual_basis hb))
\end{lstlisting}

Since $L$ is a finite extension of $K$, it has a finite basis $b : \iota \to L$ (as a vector space over $K$).
Each $b_i$ is algebraic, so there is a (nonzero) $c_i$ such that $c_i b_i$ is integral over $R$.
Thus, we can multiply $b$ by the product of all $c_i$ to give a basis of $L$ over $K$ consisting of integral elements.
That this is indeed a basis follows from the fact that each $c_i$ is invertible as element of $L$,
thus multiplying by each in turn is a linear automorphism $\lean{lsmul\_equiv}\ c_i : L \to L$.

The remaning ingredient is to find a bilinear form $B$ that is nondegenerate and maps pairs of integral elements to integral elements. In the next subsection, we will discuss how we proved the \emph{trace form} satisfies these criteria.

\subsection{Trace form}
Our formalization of the trace form is based on \cite{Neukirch}, 2.5--2.8.
In an $R$-algebra $S$ that is free and finitely generated as an $R$-module,
the map $\lean{lmul} = \lambda x y : S, xy$ is $R$-linear map in both $x$ and $y$, so it can be represented by a matrix $M_x$.
The \emph{algebra trace} of $x : S$ over $R$, denoted $\Tr_{S : R} x$ is the trace of $\lean{lmul}\ x$, i.e. the sum of the diagonal entries of $M_x$\footnote{Although the entries of $M_x$ depend on the choice of basis, the sum does not.}.
We defined the trace as an $R$-linear map from $S$ to $R$ as the composition of $\lean{lmul}$ and the trace operator for linear maps:
\begin{lstlisting}
noncomputable def trace : S →ₗ[R] R :=
(linear_map.trace R S).comp (lmul R S).to_linear_map
\end{lstlisting}
This definition is marked noncomputable since \lean{linear\_map.trace} makes a case distinction on the existence of a basis,
using an arbitrary basis if one exists and returning $0$ otherwise.
This latter case does not occur in our development.

The \emph{trace form} is a $R$-bilinear form on $S$, mapping $x, y : S$ to $\Tr(xy)$.
\begin{lstlisting}
noncomputable def trace_form : bilin_form R S :=
{ bilin := λ x y, trace R S (x * y), .. }
\end{lstlisting}

Although the trace form can be defined for any algebra,
for simplicity of exposition we will only consider finite field extensions in this paper.
In the formalization, we weakened assumptions to commutative rings or integral domains whenever this was practical.
In the following, let $K : L : F$ be a tower of finite field extensions,
i.e. we have the following declarations:
\begin{lstlisting}
variables {K L F : Type*} [field K] [field L] [field F]
variables [algebra K L] [algebra L F] [algebra K F] [is_scalar_tower K L F]
\end{lstlisting}
Note the use of \lean{is\_scalar\_tower K L F} to indicate that the extensions fit in a tower, as described in Section \ref{sec:scalar_tower}.

The value of the trace depends on the choice of $K$ and $L$: if $x : L$ and $L$ is a subfield of $F$,
then the trace of $(x : F)$ is an integer multiple of the trace of $(x : L)$.
This is a consequence of the following two results, formalizing \cite{Neukirch}, corollary 2.7:
\begin{lstlisting}
lemma trace_algebra_map (x : K) :
  trace K L (algebra_map K L x) = findim K L • x

lemma trace_comp (x : F) :
  trace K F x = trace K L (trace L F x)
\end{lstlisting}
Since a basis $b : \iota \to L$ for $K : L$ and a basis $c : \kappa \to F$ for $L : F$ induce a basis $b \cdot c : \iota \times \kappa \to F$ for $K : F$,
these results follow by direct computation of the multiplication matrices $M_x$.

To compute $\Tr_{K : L}(x)$ it therefore suffices to consider the trace of $x$ in the smallest field containing $x$ and $K$, which is $K(x)$.
It turns out that the trace of $x$ in $K(x)$ is the sum of all conjugate roots to $x$,
i.e. if the field extension $F$ contains all roots of the minimal polynomial of $x$, then the sum of its roots is exactly (the image of) $\Tr_{K : K(x)}(x)$.
We formalize this using the power basis, as follows:
\begin{lstlisting}
lemma power_basis.trace_gen_eq_sum_roots (pb : power_basis K L)
  (h : polynomial.splits (algebra_map K F) pb.minpoly_gen) :
  algebra_map K F (trace K L pb.gen) =
    (pb.minpoly_gen.map (algebra_map K F)).roots.sum
\end{lstlisting}
Applying this result to a specific $x$ is then a question of applying it to the power basis for $K(x)$ generated by $x$, to give:
\begin{lstlisting}
lemma trace_eq_sum_roots [finite_dimensional K L]
  {x : L} (hx : is_integral K x)
  (hF : (minimal_polynomial hx).splits (algebra_map K F)) :
  algebra_map K F (algebra.trace K L x) =
  (findim K(x) L) • ((minimal_polynomial hx).map (algebra_map K F)).roots.sum
\end{lstlisting}
We formulate the lemma in terms of the power basis, since we will also use it for a finite simple extension $L : K$ later in the proof.

Each conjugate element of $x$ is integral since they are roots of (the same) monic polynomial,
and integer multiples and sums of integral elements are integral.
Since \lean{trace\_eq\_sum\_roots} shows that the trace of $x$ is an integer (\lean{findim K(x) L}) multiple of a sum of conjugate roots,
we conclude that the trace (and trace form) of an integral element is also integral.
% It would be marginally easier if `is_integral' was just an auxiliary definition for the subalgebra
% `integral_closure', since subalgebras are closed under sums and smul "for free".

To show the trace form is nondegenerate, we adapted \cite{Neukirch}, Proposition 2.8 as follows:
Suppose $L : K$ is a separable field extension of finite degree $n$,
thus it has a primitive element $x$ generating a power basis \lean{pb} of dimension $n$.
Let $F$ be the algebraic closure of $K$. Since $L$ is a finite extension, hence algebraic over $K$, we find a tower of field extensions $F : L : K$.
Let $A$ be the matrix corresponding to \lean{trace\_form K L}, written out with respect to the basis \lean{pb}.
Computing the entries of this matrix, we see $A_{ij} = \Tr_{L : K} (x^{i + j})$.
We want to show that $\det A \ne 0$.

Let $x_0, \dots, x_{n - 1} : F$ enumerate the roots of the minimal polynomial of $x$,
since $L : K$ is separable and of degree $n$, there are indeed exactly $n$ distinct roots in $F$.
Consider the $n$-by-$n$ matrix $B$ such that $B_{ij} = x_i^j$.
This is a Vandermonde matrix, which has determinant $\prod_{i < j} (x_i - x_j)^2$.
In particular, since $L : K$ is separable, the conjugates are distinct, meaning each factor $x_i - x_j$ is nonzero,
so $\det B = \prod_{i < j} (x_i - x_j)^2 \ne 0$.
Therefore, $\det (B^T B) = (\det B)^2 \ne 0$.
We claim that $B^T B$ is equal to $A$('s image in $F$), whhich implies our desired result.

The $(i, j)$'th entry of $B^T B$ is equal to $\sum_k x_k^{i + j}$,
and we want to show this is equal to \lean{algebra\_map K F (trace (x \pow (i + j)))}.
Directly applying \lean{trace\_eq\_sum\_roots} is tempting, since we have a sum over conjugates of powers on both sides.
However, the two expressions will not precisely match: $B^T B$ contains a sum over conjugates of $x$, with each conjugate raised to the power $i + j$,
while the conclusion of \lean{trace\_eq\_sum\_roots} results in a sum over conjugates of $x^{i + j}$.

Instead of directly proving that the conjugates of $x^{i + j}$ (counted with the correct multiplicities) correspond to $i + j$'th powers of the conjugates of $x$,
we need to use an equivalent definition of conjugate:
the conjugates of $x$ in $F$ are the (distinct) images of $x$ under each embedding $K(x) \to F$ that fixes $K$.
The equivalence between these two notions of conjugates was developed in Berkeley at the same time as our project, and mapping the equivalence through a sum shows: % TODO: awkward, rephrase
\begin{lstlisting}
lemma power_basis.sum_embeddings_gen
  [is_alg_closed F] [is_separable K L] (f : F → R) :
  ∑ σ in (@finset.univ _ (@alg_hom.fintype_of_separable _ _ _ _ _ _ _ _ _
      pb.finite_dimensional)),
    f (σ pb.gen) =
  ((pb.minpoly_gen.map (algebra_map K F)).roots.map f).sum
\end{lstlisting}
Combining this result with \lean{trace\_gen\_eq\_sum\_roots} gives:
\begin{lstlisting}
lemma power_basis.trace_gen_eq_sum_embeddings [is_separable K L]
  (h : pb.minpoly_gen.splits (algebra_map K F)) :
  algebra_map K F (trace K L pb.gen) =
    ∑ σ in (@finset.univ _
        (@alg_hom.fintype_of_separable _ _ _ _ _ F _ _ _
          pb.finite_dimensional)),
      σ pb.gen
\end{lstlisting}
Taking the power basis of $K(y)$ generated by $y$, we generalize the above to all $y : L$.
\begin{lstlisting}
lemma trace_eq_sum_embeddings
  [is_alg_closed F] [finite_dimensional K L] [is_separable K L]
  {x : L} (hx : is_integral K x) :
  algebra_map K F (algebra.trace K L x) = ∑ σ : L →ₐ[K] F, σ x
\end{lstlisting}
The advantage of using these embeddings is that $\sigma\ x^{i + j} = (\sigma\ x)^{i + j}$,
so we can directly go from the conjugates of $x^{i + j}$ to the $i + j$'th powers of conjugates of $x$.

\section{Class number} \label{sec:class-number}

The class group is the quotient \lean{units (fractional\_ideal f)} modulo the principal fractional ideals, or equivalently the ideals of $R$ (except $0$) modulo the elements of $R$ (except $0$).

We are interested in the class group because ...

An important property of the ring of integers in a number field is that the class group is finite. The number of elements of the class group is called the class number.

We prove that the class group is finite using a simplified form of the traditional proof, ...

\section{Discussion}

\subsection{Related work}

We are not aware of any other formal developments of fractional ideals, Dedekind domains or class groups of global fields.
Since our project touches upon the theories of field extensions, ideals, number fields and number rings,
we provide here a partial overview of formalizations in these areas.

There are many libraries formalizing basic notions of commutative algebra such as field extensions and ideals, including the Mathematical Components library in Coq~\cite{mathcomp}, the algebraic library for Isabelle/HOL~\cite{algebra_isabelle}, the \texttt{set.mm} database for MetaMath~\cite{metamath} and the Mizar Mathematical Library~\cite{algebraic-hierarchy_mizar}. The field of algebraic numbers, or more generally algebraic closures of arbitrary fields, are also available in many provers, for example Coq~\cite{real-algebraic-numbers-coq, mathcomp}, Isabelle/HOL~\cite{algebraic-numbers-isabelle}, MetaMath~\cite{algebraic-numbers-metamath}, and Mizar~\cite{algebraic-numbers-mizar}. To our knowledge, the Coq Mathematical Components library is the only formal development except ours specifically dealing with number fields~\cite[\texttt{field/algnum.v}]{mathcomp}.

Apart from the general theory of algebraic numbers, there are formalizations of specific number rings: the Gaussian integers $\Z[i]$ are available in Isabelle/HOL~\cite{gaussian_integers-isabelle}, MetaMath~\cite{gaussian_integers-metamath} and Mizar~\cite{gaussian_integers-mizar}.
The Isabelle/HOL formalization deserves special mention since it introduces techniques from algebraic number theory,
defining the integer-valued norm on $\Z[i]$ and classifying the prime elements of $\Z[i]$.

\section{Conclusion}

The formalization efforts described in this paper cannot be cleanly separated from the development of \mathlib as a whole.

Stuff was formalized\ldots
Working together with people formalizing Galois theory turned out to me mutually beneficial.

\ldots
 


\bibliography{lean}

\end{document}
