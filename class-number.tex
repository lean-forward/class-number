\documentclass[a4paper,USenglish,cleveref, autoref, thm-restate]{lipics-v2021}
%see https://submission.dagstuhl.de/documentation/authors

\bibliographystyle{plainurl}% the mandatory bibstyle

\title{A formalization of Dedekind domains and class groups of global fields}
\titlerunning{Dedekind domains and class groups}

\author{Anne Baanen}{Department of Computer Science, Vrije Universiteit Amsterdam, The Netherlands \and \url{https://cs.vu.nl/~tbn305}}{t.baanen@vu.nl}{https://orcid.org/0000-0001-8497-3683}
{NWO Vidi grant No. 016.Vidi.189.037, Lean Forward}
%{Received funding from the NWO under the Vidi program (project No. 016.Vidi.189.037, Lean Forward)}
\author{Sander R. Dahmen}{Department of Mathematics, Vrije Universiteit Amsterdam, The Netherlands \and \url{https://few.vu.nl/~sdn249/}}{s.r.dahmen@vu.nl}{https://orcid.org/0000-0002-0014-0789}{NWO Vidi grant No. 639.032.613, New Diophantine Directions}
\author{Ashvni Narayanan}{London School of Geometry and Number Theory}{a.narayanan20@imperial.ac.uk}{https://orcid.org/0000-0003-2777-4228}{EPSRC Grant EP/S021590/1 (UK)}
\author{Filippo A. E. Nuccio Mortarino Majno di Capriglio}{Univ Lyon, Université Jean Monnet Saint-Étienne, CNRS UMR 5208, Institut Camille Jordan, F-42023 Saint-\'Etienne, France\and\url {https://perso.univ-st-etienne.fr/nf51454h/index.html}}{filippo.nuccio@univ-st-etienne.fr}{https://orcid.org/0000-0002-5318-9869}{\empty}

\authorrunning{T. Baanen, S. R. Dahmen, A. Narayanan, and F. A. E. Nuccio}

\Copyright{Anne Baanen, Sander R. Dahmen, Ashvni Narayanan, and Filippo A. E. Nuccio Mortarino Majno di Capriglio}

\ccsdesc[500]{Mathematics of computing~Mathematical software}
\ccsdesc[500]{Security and privacy~Logic and verification}

\keywords{formal math, algebraic number theory, commutative algebra, Lean, mathlib} %TODO mandatory; please add comma-separated list of keywords

\supplement{Full source code of the formalization is part of \mathlib. Copies of the source files relevant to this paper are available in a separate repository.}
\supplementdetails%[swhid={Software Heritage Identifier}]
{Software}{https://github.com/lean-forward/class-number}

\acknowledgements{We want to thank the whole \mathlib community for invaluable advice all along the project.\\
A.~N.~would like to thank Prof Kevin Buzzard for his constant support and encouragement, and for introducing her to the other co-authors.\\
A.~N.~and F.~N.~wish to express their deepest gratitude to Anne Baanen for the generosity shown along all stages of the project. Without Anne's never-ending patience, it would have been impossible for them to contribute to this project, and to overcome several difficulties.
}

%\nolinenumbers %uncomment to disable line numbering

%\hideLIPIcs  %uncomment to remove references to LIPIcs series (logo, DOI, ...), e.g. when preparing a pre-final version to be uploaded to arXiv or another public repository

%Editor-only macros:: begin (do not touch as author)%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\EventEditors{John Q. Open and Joan R. Access}
\EventNoEds{2}
\EventLongTitle{Interactive~Theorem~Proving~2021 (ITP~2021)}
\EventShortTitle{ITP~2021}
\EventAcronym{ITP}
\EventYear{2021}
\EventDate{June~29--July~1, 2021}
\EventLocation{Rome, Italy}
\EventLogo{}
\SeriesVolume{}
\ArticleNo{}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage{xcolor}
\usepackage{xspace}
\usepackage{soul}
\usepackage{listings}
\def\lstlanguagefiles{lstlean.tex}
\lstset{language=lean}

\newcommand{\C}{\mathbb{C}}
\newcommand{\lean}[1]{\texttt{#1}\xspace} % for writing Lean expressions
\newcommand*{\OK}[1][K]{\mathcal{O}_{#1}}
\newcommand*{\Cl}{\mathcal{C}\kern-.075em l}
% \DeclareMathOperator{\Cl}{Cl}
\newcommand*{\Fq}[1][q]{\mathbb{F}_{#1}}
\DeclareMathOperator{\Tr}{Tr}
\newcommand{\mathlib}{\textsf{mathlib}\xspace}
\newcommand{\N}{\mathbb{N}}
\newcommand{\R}{\mathbb{R}}
\newcommand{\pow}{\textasciicircum\xspace}
\newcommand{\Q}{\mathbb{Q}}
\newcommand{\Qbar}{\mathbb{\bar{Q}}}
\newcommand{\Z}{\mathbb{Z}}
\DeclareMathOperator{\Frac}{Frac}

\definecolor{keywordcolor}{rgb}{0.7, 0.1, 0.1}   % red
\definecolor{commentcolor}{rgb}{0.4, 0.4, 0.4}   % grey
\definecolor{symbolcolor}{rgb}{0.4, 0.4, 0.4}    % grey
\definecolor{sortcolor}{rgb}{0.1, 0.5, 0.1}      % green

\DeclareUnicodeCharacter{03B1}{\ensuremath{\alpha}}
\DeclareUnicodeCharacter{03C3}{\ensuremath{\sigma}}
\DeclareUnicodeCharacter{2081}{\ensuremath{_1}}
\DeclareUnicodeCharacter{2090}{\ensuremath{_a}}
\DeclareUnicodeCharacter{2097}{\ensuremath{_l}}
\DeclareUnicodeCharacter{211A}{\ensuremath{\Q}}
\DeclareUnicodeCharacter{2124}{\ensuremath{\Z}}
\DeclareUnicodeCharacter{2211}{\ensuremath{\sum}}
\DeclareUnicodeCharacter{2264}{\ensuremath{\l}}
\DeclareUnicodeCharacter{2286}{\ensuremath{\subseteq}}
\DeclareUnicodeCharacter{22A4}{\ensuremath{\top}}
\DeclareUnicodeCharacter{22A5}{\ensuremath{\bot}}

\begin{document}

\maketitle

\begin{abstract}
Dedekind domains and their class groups are notions in commutative algebra that are essential in algebraic number theory.
We formalized these structures and several fundamental properties, including number theoretic finiteness results for class groups, in the Lean prover as part of the \mathlib mathematical library.
This paper describes the formalization process, noting the idioms we found useful in our development and \mathlib's decentralized collaboration processes involved in this project.
\end{abstract}

\section{Introduction}

In its basic form, number theory studies properties of the integers $\Z$
%(say as a set together with the ``standard'' addition and multiplication operations)
and its fraction field, the rational numbers $\Q$.\footnote{From a classical point of view, one could even argue that the positive, or perhaps nonnegative, integers and rational numbers are the most basic objects of study of number theory. From an algebraic point of view, this would still quickly lead into studying $\Z$ and $\Q$.}
Both for the sake of generalization, as well as for providing powerful techniques to answer questions about the original objects $\Z$ and $\Q$,
it is worthwhile to study finite extensions of $\Q$, called \emph{number fields}, as well as their \emph{rings of integers} (defined in Section~\ref{sec math background} below),
whose relations mirror the way $\Q$ contains $\Z$ as a subring. 
% These number fields and their rings of integers form the basic objects of study of algebraic number theory, an important brach of modern number theory.--[F] seems redundant, as it is more or less the same as the previous sentence
In this paper, we describe our project aiming at formalizing these notions and some of their important properties. Our goal, however, is not to get to the definitions and properties as quickly as possible,
but rather %instead we aim at our formalization as a
to lay the foundations for future work,
as part of a natural and more general theory as we shall explain below.

In particular, our project resulted in formalized definitions and elementary properties of
number fields and their rings of integers (described in Section~\ref{sec:ring-of-integers}),
Dedekind domains (Section~\ref{sec:Dedekind-domain}),
and the ideal class group and class number (Section~\ref{sec:class-number}).
The main proofs that we formalized show
that two definitions of Dedekind domains are equivalent (Section \ref{sec:equivalence}),
that the ring of integers (or more generally: the integral closure of a Dedekind domain in a finite separable field extension) is a Dedekind domain (Section \ref{sec:integral-closure})
and that the class group of a number field is finite (Section \ref{sec:class-number}).
In fact, most of our results for number fields are actually obtained in the more general setting of so-called \emph{global fields},
namely number fields together with finite field extensions of $\Fq[\empty](t)$ with $\Fq[\empty]$ a finite field (restricting to $\Fq[\empty]\simeq \Z/p\Z$ with $p$ prime yields no loss of generality here).

%
%As a preview, the latter two results correspond to the following declarations in Lean:
%\begin{lstlisting}
%instance : is_dedekind_domain (ring_of_integers K) :=
%integral_closure_int.is_dedekind_domain K
%
%noncomputable instance :
%  fintype (class_group (ring_of_integers.fraction_map K)) :=
%class_group.finite_of_admissible K int.fraction_map int.admissible_abs
%
%noncomputable def class_number : ℕ :=
%fintype.card (class_group (ring_of_integers.fraction_map K))
%\end{lstlisting}

Apart from the achievement of formalizing a non-trivial amount of mathematical theory,
our formal definition of the class number is an essential requirement
for the use of theorem provers in modern number theory research.
% doing ``fashionable mathematics'' in a theorem prover, borrowing a term from prof. Kevin Buzzard~\cite{fashionable-mathematics}.
%Additionally, our formalization opens the door to the verification of number theoretic software,
%such as KASH/KANT~\cite{kash} and PARI/GP~\cite{PARI2}.

Our work is developed as part of the mathematical library \mathlib~\cite{mathlib} for the Lean 3 theorem prover~\cite{lean-prover}.
The formal system of Lean is a dependent type theory based on the calculus of inductive constructions,
with a proof-irrelevant impredicative universe \lean{Prop} at the bottom of a noncumulative hierarchy of universes \lean{Prop : Type : Type 1 : Type 2 : \dots}.\footnote{In our code samples, we use \lean{Type*} as abbreviation of ``\lean{Type u} for an arbitrary choice of \lean{u}''.}
Other important characteristics of Lean as used in \mathlib are the use of quotient types, ubiquitous classical reasoning and the use of typeclasses to define the hierarchy of algebraic structures.

Organizationally, \mathlib is characterized by a distributed and decentralized community of contributors, a willingness to refactor its basic definitions, and a preference for small yet complete contributions over larger projects added all at once.
Our own project, being part of the development of \mathlib, follows this philosophy by contributing pieces of our work as they are finished,
in turn taking advantage of results contributed by others after the start of the project.
At several points, we had just merged a formalization into \mathlib that another contributor needed,
immediately before they contributed a result that we needed.
Due to the decentralized organization and fluid nature of contributions to \mathlib, its contents are built up of many different contributions from many different authors. Attributing each formalization to a single set of main authors would not do justice to all others whose additions and tweaks are essential to its current use. Therefore, we will make clear whether a contribution is part of our project or not, but we will not stress whom we consider to be the main author(s).

The source files of the formalization are currently in the process of being merged into \mathlib, an up-to-date branch being available \url{https://github.com/leanprover-community/mathlib/tree/dedekind-domain-dev}. We also maintain a %separate
repository containing the source code referred to in this paper, available at \url{https://github.com/lean-forward/class-number}.

\section{Mathematical background}\label{sec math background}

Let us now introduce some of the main objects we study, described in a ``standard'' mathematical way. We assume some familiarity with basic ring and field theory.% In the later sections we will detail their formalization in Lean.

A \emph{number field} $K$ is a finite extension of the field $\Q$, and as such has the structure of a finite dimensional vector space over $\Q$; its dimension is called the \emph{degree} of $K$.
The easiest example is $\Q$ itself, and the two-dimensional cases are given by the quadratic number fields
$\Q(\sqrt{d})=\{a+b\sqrt{d} : a,b \in \Q\}$
with $d \in \Z$ not a square. 
%where $d\not=1$ is a squarefree (i.e. not divisible by $p^2$ for any prime $p$) integer.
%, and there is no loss in generality in considering $\sqrt{d}$ as a complex number (since every number field can be embedded into the complex numbers).
For an interesting cubic example, let $\alpha$ be the unique real number satisfying $\alpha^3 + \alpha^2 - 2\alpha + 8=0$: it gives rise to the number field
$\Q(\alpha)=\{a+b\alpha+c \alpha^2: a,b,c \in \Q\}$.
%where $\alpha$ satisfies $\alpha^3 + \alpha^2 - 2\alpha + 8=0$ (it is the unique real number with this property).
In general, taking any root $\alpha$ of an irreducible polynomial of degree $n$ over $\Q$ yields a number field of degree $n$:
$\Q(\alpha)=\{c_0+c_1\alpha+\ldots+c_{n-1} \alpha^{n-1} : c_0,c_1,\ldots,c_{n-1} \in \Q \}$,
and, up to isomorphism, these are all the number fields of degree $n$.

The \emph{ring of integers} $\OK$ of a number field $K$ is defined as the integral closure of $\Z$ in $K$, which boils down to
\[
  \OK := \{x \in K : f(x)=0 \text{ for some \emph{monic} polynomial } f \text{ with integer coefficients}\},\]
where we recall that a polynomial is called \emph{monic} if its leading coefficient equals $1$.
While it might not be immediately obvious that $\OK$ is a ring, this follows from general algebraic properties of integral closures.
Some examples of $\OK$ are as follows. Taking $K=\Q$, we get $\OK=\Z$ back.
For $K=\Q(i)=\Q(\sqrt{-1})$ we get that $\OK$ is the Gaussian integers $\Z[i]=\{a+bi : a,b \in \Z\}$.
%For $K=\Q(\sqrt{2})$ we get $\OK=\Z[\sqrt{2}]=\{a+b\sqrt{2} : a,b \in \Z\}$.
But for $K=\Q(\sqrt{5})$ we do \emph{not} simply get $\Z[\sqrt{5}]=\{a+b\sqrt{5} : a,b \in \Z\}$ as $\OK$, since the golden ratio $\varphi:=(1+\sqrt{5})/2\not\in \Z[\sqrt{5}]$ satisfies the monic polynomial equation $\varphi^2-\varphi-1=0$, hence by definition $\varphi \in \OK$; it turns out that $\OK=\Z[\varphi]=\{a+b\varphi : a,b \in \Z\}$. %For quadratic numbers field $\Q(\sqrt{d})$, with $d$ as above, the previous two examples in fact generalize to
% \begin{equation*}
% \OK[\Q(\sqrt{d})]=
% \begin{cases}
% \Z[\sqrt{d}]=\{a+b\sqrt{d}: a,b \in \Z\} \text { if } d \not\equiv 1 \pmod{4}\\
%  \Z\left[\frac{1+\sqrt{d}}{2}\right]=\left\{a+b \frac{1+\sqrt{d}}{2} : a,b \in \Z \right\} \text { if } d \equiv 1 \pmod{4}.
% \end{cases}
% \end{equation*}%[F] TODO I wonder if this is not too much.
Finally, if $K=\Q(\alpha)$ with $\alpha$ as before, then $\OK=\{a+b \alpha+c (\alpha+\alpha^2)/2 : a,b,c \in \Z\}$, illustrating that explicitly writing down $\OK$ can quickly become complicated.
Further well-known rings of integers are % the Gaussian integers $\Z[i]=\{a+b i : a,b, \in \Z\}$ (where $i^2=-1$),
the Eisenstein integers $\Z[(1+\sqrt{-3})/2]$, and the %``real'' quadratic 
ring $\Z[\sqrt{2}]$.
%TODO do we want to say something here about the existence of an integral basis? And the existence/nonexistence of a power basis for number fields/rings of integers?

Thinking of $\OK$ as a generalization of $\Z$, it is natural to ask which of its properties %of $\Z$ if they
still hold in $\OK$ and, when this fails, if a reasonable weakening does. %still holds.

An important property of $\Z$ is that it is a principal ideal domain (PID), meaning that every ideal is generated by one element. This implies that every nonzero nonunit element can be written as a %(nonempty)
finite product of prime elements, which is unique up to reordering and multiplying by $\pm 1$: a ring where this holds is called a unique factorization domain, or UFD. % with units (which are $\pm 1$ in $\Z$).
For example, $6$ can be factored in primes in $4$ equivalent ways, namely $6=2\cdot 3=3\cdot2=(-2)\cdot (-3)=(-3) \cdot (-2)$.
In fact, the previously mentioned examples of rings of integers are UFDs, but this is certainly not true for all rings of integers. For example, unique factorization \emph{does not} hold in $\Z[\sqrt{-5}]$% is \emph{not} a UFD
: it is easy to prove that $6=2\cdot3$ and $6=(1+\sqrt{-5}) (1-\sqrt{-5})$ provide two essentially different ways to factor $6$ into prime elements of $\Z[\sqrt{-5}]$.

As it turns out, there is a way to remedy this. Namely, by considering factorization of \emph{ideals} instead of elements: given a number field $K$, with ring of integers $\OK$, a beautiful and classical result by Dedekind shows that every nonzero ideal of $\OK$ can be factored as a product of prime ideals in a unique way, up to reordering.
%TODO? ?Talk about unique factorization monoid?

Although unique factorization in terms of ideals is of great importance, it is still interesting, and sometimes %for many arithmetic applications 
necessary, to also consider factorization properties in terms of elements.
We mentioned that unique factorization in $\Z$ follows from the fact that every ideal is generated by a single element.
We can extend the monoid of ideals of $\Z$ to a group of \emph{fractional ideals}.
These are additive subgroups of $\Q$ of the form $\frac{1}{d} I$ with $I$ an ideal of $\Z$ and $d$ a nonzero integer.
When the distinction is important, we refer to an ideal $I \subseteq \Z$ as an \emph{integral ideal}.
The nonzero fractional ideals of $\Z$ naturally form a multiplicative group (whereas there is no integral ideal $I\subseteq \Z$ such that $I*(2\Z)=(1)$).
The statement that every ideal is generated by a single element
translates to the fact that the quotient group of nonzero fractional ideals modulo $\Q^\times$ (where $\frac{a}{b} \in \Q^\times$ corresponds to $\frac{1}{b} a \Z$) is trivial.

It turns out that this quotient group can be %extended of defining the group of fractional ideals, embedding the multiplicative group of the fraction field into the first group, and taking the quotient, can be
defined for every ring of integers $\OK$.
The fundamental theoretical notion beneath this construction is that of Dedekind domain: these are integral domains $D$ which are Noetherian (every ideal of $D$ is finitely generated), integrally closed (if an element $x$ in the fraction field of $D$ is a root of a monic polynomial with coefficients in $D$, then actually $x \in D$), and of Krull dimension at most $1$ (every nonzero prime ideal of $D$ is maximal).
%It can be proved that considering the group of invertible ideals of $\OK$, embedding $K^\times$ into the latter group% of invertible ideals
%, and then taking the quotient makes sense in every Dedekind domain. This quotient group we call the \emph{ideal class group} $\Cl_D$ of the Dedekind domain $D$. %the procedure of 
It can be proved that the nonzero fractional ideals of $D$ %$\OK$
again form a group, and the quotient of this group by the image of the natural embedding of $(\Frac D)^\times$ is called the \emph{\textup{(}ideal\textup{)} class group} $\Cl_{D}$.
%REMARK: Of course we could also take the invertible fractional ideals (in any domain), which a priori form a group, but the former probably ties in better with the previous paragraph, and also illustrates a nontrivial theorem.
%The quotient of this group by the natural embedding of $K^\times$ into it is called the \emph{(ideal) class group} $\Cl_{OK}$. This construction generalized to any Dedekind domain $D$, giving rise to its class group $\Cl_D$.

What is arithmetically crucial is the theorem ensuring that the ring of integers $\OK$ of every number field $K$ is a Dedekind domain,
and that in this case the class group $\Cl_{\OK}$ is actually \emph{finite}.
In particular, $\Cl_{\OK}$ can be seen as ``measuring'' how far ideals of $\OK$ are from being generated by a single element and,
consequently, as a measure of the failure of unique factorization.
The order of $\Cl_{\OK}$ is called \emph{the class number} of $K$.
Intuitively, then, the smaller the class number, the fewer factorizations are possible.
%In particular, as long as we are concerned with ``uniqueness'' of factorization, and with measuring the lack thereof, already  is a tremendously interesting arithmetic feature.

Actually, the same statement holds for \emph{function fields}, the fields which are finite extensions of $\Fq(t) \simeq \Frac \Fq[q][t]$, where $\Fq$ is a finite field with $q$ elements. Remind that when $q=p$ is a prime number, $\Fq$ is simply the field $(\Z/p\Z)$. 
% A prototypical example is $K=(\Z/p\Z)(t)=\Fq[p](t)$, or an extension of the form, for instance, $K=\Fq[p^2](t)[s]/(s^2-t)$, obtained by adjoining to $\Fq[p](t)$ a square root of $t$ as well as the $(p^2-1)$-st roots of unity.
A field which is either a number field or a function field is called a \emph{global field}.

% In this project, we formalized Dedekind domains, their class group, number fields and function fields together with their ring of integers, and the definition of the class number, via the proof that the class group of a ring of integers (assuming separability conditions) is finite. 
In the next sections we will describe the formalization of the above concepts.

\section{Number fields, global fields and rings of integers}

We refer the reader to Section~\ref{sec math background} for the mathematical background needed in this section.

We formalized number fields as the following typeclass:
\begin{lstlisting}
class is_number_field (K : Type*) [field K] : Prop :=
[cz : char_zero K] [fd : finite_dimensional ℚ K]
\end{lstlisting}
The \emph{class} keyword declares a structure type (i.e. a type of records) and enables typeclass inference for terms of this type.
Round brackets mark parameters explicitly supplied by the user, such as \lean{(K : Type*)},
square brackets mark instance parameters inferred by the typeclass system, such as \lean{[field K]}.

The condition \lean{[cz : char\_zero K]} states that $K$ has characteristic zero, so the canonical ring homomorphism $\Z \to K$ is an embedding.
This implies that there is a $\Q$-algebra structure on $K$ (found by typeclass search),
and from this follows the vector space structure used in the \lean{[fd : finite\_dimensional ℚ K]} hypothesis.

We define the function fields $K$ over a finite field $\Fq$ using the following typeclass:
\begin{lstlisting}
class is_function_field_over {$\Fq$ F : Type*} [field $\Fq$] [fintype $\Fq$]
  [field F] (f : fraction_map (polynomial $\Fq$) F) (L : Type*) [field L]
  [algebra f.codomain L] : Prop :=
[fd : finite_dimensional f.codomain L]
\end{lstlisting}
Curly brackets mark implicit parameters inferred through unification, such as \lean{\{$\Fq$ F : Type*\}}.
The map \lean{f} witnesses that $F$ is a fraction field of the polynomial ring $\Fq[q][t]$,
the notation \lean{f.codomain} endows $F$ with the $\Fq[q][t]$-algebra structure of $\Fq(t)$. We present a more detailed examination of \lean{fraction\_map} in Section \ref{subsection : fields of fractions}.

\subsection{Field extensions}

The definition of \lean{is\_number\_field} illustrates our treatment of field extensions.
In unformalized mathematics, a field $L$ containing a subfield $K$ is said to be a field extension $L / K$.
Often we encounter towers of field extensions: we might have that $\Q$ is contained in $K$, $K$ is contained in $L$, $L$ is contained in an algebraic closure $\bar{K}$ of $K$, and $\bar{K}$ is contained in $\C$.
We might formalize this situation by viewing $\Q$, $K$, $L$ and $\bar{K}$ to be sets of complex numbers $\C$ and defining field extensions as subset relations between these subfields.
This way, no coercions need to be inserted to map elements of one field into a larger field.
Unfortunately, we can only avoid coercions as far as we able to stay within one largest field.
For example, to define the complex numbers requires many results for rational numbers, which must be reproved for or transported to $\Q$ as a subfield of $\C$.
%In type theory we cannot define $\Q$ as a subset of $\C$ since we need $\Q$ to define $\C$.

Instead, we formalize results about field extensions through parametrization. The fields $K$ and $L$ can be arbitrary types
and the hypothesis ``$L$ is a field extension of $K$'' is represented by an instance parameter \lean{[algebra K L]} denoting a $K$-algebra structure on $L$.%
\footnote{Lean does not enforce uniqueness of typeclass instances, but the \mathlib maintainers try to ensure all instances that can be inferred are definitionally equal.}
This provides us with a canonical ring homomorphism $\lean{algebra\_map K L} : K \to L$; this map is injective because $K$ and $L$ are fields.
In other words, field extensions are given by their canonical embeddings.

\subsection{Scalar towers} \label{sec:scalar_tower}

The main drawback of using arbitrary embeddings to represent field extensions is that we need to prove that these maps commute.
For example, we might start with a field extension $L / \Q$, then define a subfield $K$ of $L$,
resulting in a tower of extensions $L / K / \Q$.
In such a tower, the map $\Q \to L$ should be equal to the composition $\Q \to K$ followed by $K \to L$.
Such an equality cannot always be achieved by defining the map $\Q \to L$ to be this composition: in the example, the map $\Q \to K$ depends on the map $\Q \to L$.

The solution in \mathlib is to parametrize over all three maps, as long a there is also a proof of coherence:
a hypothesis of the form ``$L / K / F$ is a tower of field extensions'' is translated into three instance parameters \lean{[algebra F K]}, \lean{[algebra K L]} and \lean{[algebra F L]},
along with an additional parameter \lean{[is\_scalar\_tower F K L]} expressing that the maps commute.

The \lean{is\_scalar\_tower} typeclass derives its name from its applicability to any three types between which exist scalar multiplication operations:
\begin{lstlisting}
class is_scalar_tower (M N α : Type*)
  [has_scalar M N] [has_scalar N α] [has_scalar M α] : Prop :=
(smul_assoc : ∀ (x : M) (y : N) (z : α), (x • y) • z = x • (y • z))
\end{lstlisting}
For example, if $R$ is a ring, $A$ is an $R$-algebra and $M$ an $A$-module, we can express the fact that $M$ is also an $R$-module by adding a \lean{[is\_scalar\_tower R A M]} parameter.
Since \lean{x~$\cdot$~y} for an $R$-algebra $A$ is defined as \lean{algebra\_map R A x * y}, applying \lean{smul\_assoc} for each $x : K$ with $y = (1 : L)$ and $z = (1 : F)$ shows that the \lean{algebra\_map}\kern-.3em s indeed commute.

Common \lean{is\_scalar\_tower} instances are declared in \mathlib,
such as for the maps $R \to S \to A$ when $S$ is a $R$-subalgebra of $S$.
The effect is that almost all coherence proof obligations are automated through typeclass instance search.
%In our formalization, we found that the \lean{is\_scalar\_tower} typeclass translates towers of field extension well.

\subsection{Ring of integers} \label{sec:ring-of-integers}

%A number ring is defined as a ring whose fraction field is a number field, the ring of integers $\OK$ is an important example.
When $K$ is a number field, the ring $\OK$ of integers in $K$ is defined as the integral closure of $\Z$ in $K$.
This is the subring containing those $x : K$ that are the root of a monic polynomial with coefficients in $\Z$:
\begin{lstlisting}
def number_field.ring_of_integers (K : Type*) [field K]
  [is_number_field K] : subalgebra ℤ K :=
integral_closure ℤ K
\end{lstlisting}
where \lean{integral\_closure} was previously defined in \mathlib.
% \begin{lstlisting}
% def integral_closure (R A : Type*) [comm_ring R] [comm_ring A]
%   [algebra R A] : subalgebra R A :=
% { carrier := { r | is_integral R r }, .. /- proofs omitted -/ }
% \end{lstlisting}
%Some examples of rings of integers include $\Z$ and $\Z[i]$.
%We prove ahead that the ring of integers of a number field is, in fact, a Dedekind domain. Moreover, it is a finitely-generated free $\Z$-module, with rank equal to the degree of the number field over $\Q$.%TODO : USEFUL?

When $K$ is a function field over the finite field $\Fq$, we define $\OK$ analogously as \lean{integral\_closure (polynomial K) F}.
% TODO: or should the following remarks be in another section?
In order to reason uniformly for both concepts of the ring of integers,
we will work with the integral closure of any principal ideal domain when possible.

\subsection{Subobjects} \label{sec:subobjects}

The ring of integers are one example of a subobject, such as a subfield, subring or subalgebra, defined through a characteristic predicate.
In \mathlib, subobjects are ``bundled'', in the form of a \lean{structure} comprising the carrier set and proofs showing the carrier set is closed under the relevant operations.

Two new subobjects we needed in our development were \lean{subfield} and \lean{intermediate\-\_field}.
We define a subfield of a field $K$ as a subset of $K$ that contains $0$ and $1$ and is closed under addition, negation, multiplication, and taking inverses.
If $L$ is a field extension of $K$, we define an intermediate field as a subfield that is also a subalgebra: a subfield that contains the image of $\lean{algebra\_map K L}$.
Other examples of subobjects available in \mathlib are submonoids, subgroups and submodules (with ideals as a special case of submodules).

The new definitions found immediate use:
soon after we contributed our definition of \lean{intermediate\_field} to \mathlib,
the Berkeley Galois theory group used it in a proof of the primitive element theorem.
Soon after the primitive element theorem was merged into \mathlib,
we used it in our development of the trace form.
This anecdote illustrates the decentralized development style of \mathlib,
with different groups and people building on each other's results in a collaborative process.

By providing a coercion from subobjects to types, sending a subobject $S$ to the subtype of all elements of $S$,
and putting typeclass instances on this subtype,
we can reason about inductively defined rings such as $\Z$ and subrings such as \lean{integral\_closure $\Z$ K} uniformly.
If $S : \lean{subfield}\ K$, there is a canonical ring embedding, the map that sends $x : S$ to $K$ by ``forgetting'' that $x \in S$,
and we register this map as an \lean{algebra S K} instance, also allowing us to treat field extensions of the form $\Q \to \C$ and subfields uniformly.
Similarly, for $F : \lean{intermediate\_field K L}$, we defined the corresponding \lean{algebra K F}, \lean{algebra F L} and \lean{is\_scalar\_tower K F L} instances.

\subsection{Fields of fractions}\label{subsection : fields of fractions}
The fraction field $\Frac R$ of an integral domain $R$ can be defined explicitly as a quotient type as follows:
starting from the set of pairs $(a,b)$ with $a,b \in R$ such that $b\neq 0$,
one quotients by the equivalence relation stating that $(\alpha a, \alpha b) \sim (a,b)$ for all $\alpha \ne 0 : R$, writing the equivalence class of $(a,b)$ as $\frac{a}{b}$.
It can easily be proved that the ring structure on $R$ extends uniquely to a field structure on $\Frac R$;
in \mathlib this construction is called \lean{fraction\_ring R}.
When $R=\Z$, this yields the traditional description of $\Q$ as the set of equivalence classes of fractions, where $\frac{2}{3}=\frac{-4}{-6}$, etc.
The drawback of this construction is that there are many other fields that can serve as the field of fractions for the same ring.
%For instance, although there is an isomorphism of $\Frac \C[\![t]\!]$ with the field
%\[
%\C(\!(t)\!)=\Big\{\sum_{i=a}^{+\infty} a_it^i\quad\text{ with }a \in \Z\Big\}
%\]
%of Laurent series, there is no (definitional) equality between the types. Another example comes from the field
Consider for instance the field $\{z \in \C : \Re z \in \Q, \Im z\in\Q\}$, which is isomorphic to $\Frac (\Z[i])$, but not definitionally equal to it.
% In fact, even the rational numbers in Lean are a counterexample:
% for computational efficiency, $\Q$ is defined as a subtype where the numerator and denominator are coprime,
% instead of a quotient by ``scalar multiplication''. A definition like
% \begin{lstlisting}
% def fraction_field (R : Type*) [integral_domain R] : Type* :=
% {ab : R × R // ab.2 ≠ 0}
% \end{lstlisting}
% would require transferring results across isomorphisms.% as soon as one needs to handle a different construction of a field isomorphic to $\Frac R$.

The strategy used in \mathlib is to rather allow for many different \emph{fraction fields} of our given integral domain $R$,
as fields $F$ along with an injective \emph{fraction map} $f : R \to F$ which witnesses that all elements of $F$ are ``fractions'' of elements of $R$,%
\footnote{In the definition used by \mathlib, a fraction map is a special case of a \emph{localization map}. Different localizations restrict the denominators to different submonoids of $R^\times$.}
and to parametrize every result over the choice of $f$.
The conditions on $f$ imply that $F$ is the smallest field containing $R$,
by showing each injective map $g \colon R \to A$ to a ring $A$ such that $g(x)$ has a multiplicative inverse for all $x \ne 0 : R$,
can be extended uniquely to a map $F \to A$ compatible with $f$ and $g$.
In particular, if $f_1 \colon R \to F_1$ and $f_2 \colon R \to F_2$ are fraction maps, they induce an isomorphism $F_1 \simeq F_2$.
The construction of $\Frac R$ then results in \emph{a} field of fractions (with fraction map \lean{fraction\_ring.of R}) rather than \emph{the} field of fractions.

% As the notion of \emph{fractional ideals}, which is pivotal to the definition of the (ideal) class group, depends on the choice of an ambient field of fraction $K$ and on the map $f\colon R\to K$, we could either fix a field of fractions (say, $\Frac R$) once and for all, or rather let all our construction be relative to this choice.  As Lean already contained the following
%\begin{lstlisting}
%def fraction_map [comm_ring K] := localization_map (non_zero_divisors R) K
%\end{lstlisting}
%and because the nonzero divisor of an integral domain coincide with $R\setminus\{0\}$, we opted for this setting for our development of fields of fractions and of fractional ideals. 

This came at a price: % one is normally used to consider that $\Z \subseteq \Q$ and that $(2 : \Z) \in \Q$, for instance.  Likewise, in the abstract framework of integral domains,
informally, at any given stage of one's reasoning, the field $F$ is fixed and the map $f\colon R\to F$ is applied implicitly, just viewing every $x:R$ as $x:F$.
%This is clearly false from a type-theoretical point of view, but
It is now impossible to view $f(R) \leq F$ as an inclusion of subalgebras,
because the map $f$ is needed explicitly to give the $R$-algebra structure on $F$.
%because the extra structure on the map $f$ that $K$ was endowed with the structure of an $R$-algebra and that any of our results might have been applied in a setting where the field of fractions under consideration was different, although isomorphic, to $K$.
We use a type synonym \lean{f.codomain := F} and instantiate the $R$-algebra structure given by $f$ on this synonym.

% In the following sections, let $f \colon R \to F$ be a fraction map.

%This applies, in particular, to all algebraic structures related to $\lean{R}$ and to its embedding in $\lean{K}$, and was approached through Lean's management of coercions. This will become even more relevant in the following section, concerning fractional ideals, and suffices here, as an example, to consider 
%\begin{lstlisting}
%lemma mul_inv_cancel [comm_ring K] (f : fraction_map R K) (x : K) (hx : x ≠ 0) :
%x * φ.inv x = 1 :=
%\end{lstlisting}
%showing that the inverse of an element $x$ will be defined in terms of the localization map $f$.
%In particular, given any ideal $\lean{I : ideal R}$, one can consider it a 
%
%As our main aim in the project was the construction of the ideal class group, which relies on the construction of the group 
%
%\bigskip
%
%
%A fraction field $K$ of an integral domain $R$ is the smallest field that contains $R$ (or some other equivalent definitions).
%The choice of $K$ is only unique up to isomorphism.
%In particular, the generic construction of a fraction field of $\Z$ does not yield $\Q$.
%One solution is to build a transfer tactic, the other is to state our theorems parametrized by $K$, along with a proof that $K$ is a fraction field of $R$.
%
%The \mathlib definition of fraction fields is based around the localization map. Let $R$ and $K$ be (commutative) rings with submonoid $P \subset R$, then $f : R \to K$ is a localization map if ..., expressed formally as the following structure:
%
%The localization map $f$ endows $K$ with an $R$-algebra structure.
%
%If the submonoid $P$ consists of all nonzero-divisors of $R$, we say that $f$ is a fraction map, and if $R$ is an integral domain, $K$ is a field. We call $K$ the fraction field of $R$.

\subsection{Representing monogenic field extensions} \label{sec:simple-field-extension}

% A number field $K$ is defined as a finite extension of $\Q$, or equivalently (by the primitive element theorem) a field of the form $\Q(\alpha)$ for some algebraic number $\alpha$. 
% %A field extension $L / K$ is called \emph{simple} if there is an $\alpha$ algebraic over $K$, called the \emph{primitive element}, such that $L = K(\alpha)$.
%The primitive element theorem states that a finite, separable extension is simple; the converse holds if the primitive element $\alpha$ is separable.
We have seen in Section~\ref{sec math background} that every number field $K$ can be written as
% The choice of $\alpha$ and is normally underspecified in informal mathematical usage. We can find 
$K=\Q(\alpha)$ by adjoining to $\Q$ a root $\alpha$ of a polynomial: there is an irreducible polynomial $p \in \Q[X]$ such that $\Q[X] / p \simeq K$; we set $\alpha$ to be the image of $X$ in $\Q[X] / p$.
%We can also take $\alpha : \bar{K}$, the algebraic closure of $K$, set $K(\alpha)$ to be the smallest subfield of $\bar{K}$ that contains $\alpha$ and the image of $K$, and have an equality $L = K(\alpha)$ as subsets of $\bar{K}$.
If $K$ is given, we can also take $\alpha : K$ and let $\Q(\alpha)$ be the smallest subfield of $K$ containing $\alpha$; %and the image of $K$
then $K = \Q(\alpha)$ means that $\Q(\alpha)$, as a subfield of $K$, is equal to the subfield $\top$ containing all elements of $K$. 
% We could also view $K$ and $\Q(\alpha)$ as subfields of an arbitrary larger field $F$.
% Because $\alpha$ is algebraic, the smallest subring containing $\alpha$ and $\Q$ will be a field, thus we can add two more representations, replacing ``smallest subfield'' with ``smallest subring''.
% Moreover, all subfields/subrings containing $\Q$ are also $\Q$-algebras, so we can additionally replace ``subfield'' with ``intermediate field'' and ``subring'' with ``$\Q$-subalgebra''. 
The same continues to hold if we replace the base field $\Q$ with $F$, thus considering extensions of the form $F(\alpha)$, now requiring that $\alpha$ be a root of some $p\in F[X]$. Many different constructions of $F(\alpha)$ have already been formalized in \mathlib. The ability to switch between these representations is important: sometimes $K$ and $F$ are fixed and we want an arbitrary $\alpha$; sometimes $\alpha$ is fixed and we want an arbitrary type representing $F(\alpha)$. 

%$K[X] / p$ is a type called \lean{adjoin\_root p};
%$K(\alpha)$ as smallest $K$-subalgebra containing $\alpha$ is called \lean{subalgebra.adjoin $K$ \{$\alpha$\}},
%which itself is defined as the smallest subring containing the image of $K$ and $\alpha$.
%After we contributed intermediate fields and subfields to \mathlib,
%the smallest intermediate field containing $\alpha$ was defined \lean{intermediate\_field.adjoin $K$ \{$\alpha$\}},
%which itself is defined as the smallest field containing the image of $K$ and $\alpha$,
%along with a formalization of the primitive element theorem as a statement of intermediate fields:
%\begin{lstlisting}
%theorem exists_primitive_element [finite_dimensional K L] [is_separable K L] :
%  ∃ α : L, intermediate_field.adjoin K {α} = ⊤
%\end{lstlisting}

%Note that the choice of $\alpha$ (or the irreducible polynomial $p$) is not unique in general; both $3^\frac{1}{3}$ and $3^\frac{2}{3}$ generate $\Q(\sqrt[3]{3})$.
%This means none of the above conditions provides a uniform way of reasoning about simple extensions:
%if we use a predicate like ``finite, separable extension'' we cannot guarantee that the primitive element chosen for $K(\alpha)$ is indeed $\alpha$.
%If we need to choose an $\alpha$ ahead of time and prove a result about $K(\alpha)$, we need extra work to transfer the result across the isomorphism $K(\alpha) \simeq L$.

To find a uniform way to reason about all these equivalent definitions,
we chose to formalize the notion of \emph{power basis} to represent simple field extensions, a basis of the form $1, x, x^2, \dots, x^{n-1} : K$ (viewing $K$ as a $F$-vector space).\footnote{In the formalization we generalize this notion to any algebra $A$ over a commutative ring $R$.}
% We call $x$ the \emph{generator} and $n$ the \emph{dimension} of this power basis.
We defined a structure type bundling the information of a power basis:
\begin{lstlisting}
structure power_basis (F K : Type*) [field F] [field K] [algebra F K] :=
(gen : S) (dim : ℕ)
(is_basis : is_basis F (λ (i : fin dim), gen ^ (i : ℕ)))
\end{lstlisting}
We proved that the various notions of simple field extensions are equivalent to the existence of a power basis.

% TODO: or just refer here to the names of the Lean functions?
%If $x : A$ is the generator of a power basis over $R$, it is also integral over $R$:
%let $n$ be the dimension of the power basis, then $x^n : A$ can be written as $x^n = \sum_i c_i x^i$ for some coefficients $c_i : R$;
%thus $p(X) = X^n - \sum_i c_i X^i$ is a polynomial with root $x$.
%That $p$ has minimal degree, follows from the linear independence of the powers of $x$ up to $n$.
%Conversely, for algebraic (and therefore integral) $\alpha$, $\Q(\alpha)$ has a power basis generated by $\alpha$.
%This shows that the condition of having a power basis is equivalent to being a simple field extension.

With the \lean{power\_basis} structure, we have the ability to parametrize our results,
being able to choose the $F$ and $K$ in a simple field extension $K / F$, or being able to choose the $\alpha$ generating $F(\alpha)$ (by setting \lean{power\_basis.gen\ pb} equal to $\alpha$). Specializing a result from an arbitrary $K$ with a power basis over $F$,
to a specific value of $K$ such as $F(\alpha) = \lean{algebra.adjoin F \{α\}}$, is a matter of applying the result to the power basis generated by $\alpha$, and rewriting $\lean{power\_basis.gen (adjoin.power\_basis F $\alpha$)} = \alpha$.


\section{Dedekind domains} \label{sec:Dedekind-domain}
The aim of this section is to introduce the notion of \emph{Dedekind domain} which, as discussed in Section~\ref{sec math background} is the right setting to study algebraic properties of number fields.
\subsection{Definitions}\label{subsec:definitions_DD}
There are various equivalent conditions, used at various times, for an integral domain $D$ to be a Dedekind domain,\footnote{Some authors exclude fields from being Dedekind domains, a convention we don't follow.}
of which the following three have been formalized in \mathlib:
\begin{itemize}
\item \lean{is\_dedekind\_domain D}: $D$ is a Noetherian integral domain, integrally closed in its fraction field and has Krull dimension at most $1$;
\item \lean{is\_dedekind\_domain\_inv D}: $D$ is an integral domain and nonzero fractional ideals of $D$ have a multiplicative inverse (we discuss the notion and formalization of fractional ideals in Section~\ref{subsection:frac_ideals});
\item \lean{is\_dedekind\_domain\_dvr D}: $D$ is a Noetherian integral domain and the localization of $D$ at each prime ideal is a discrete valuation ring.
\end{itemize}
We did not use \lean{is\_dedekind\_domain\_dvr} in our project, so we will not discuss this definition further.


The ``main'' definition was chosen to be \lean{is\_dedekind\_domain},
since this condition is usually the one checked in practice~\cite{Neukirch}.
The other two equivalent definitions were added to \mathlib, but before formalizing the proof that they are indeed equivalent.
Having multiple definitions allowed us to do our work in parallel without depending on unformalized results.
For example,
the proof of unique ideal factorization in a Dedekind domain initially assumed \lean{is\_dedekind\_domain\_inv D},
and the proof that the ring of integers $\OK$ is a Dedekind domain concluded \lean{is\_dedekind\_domain (ring\_of\_integers K)}.
After the equivalence between \lean{is\_dedekind\_domain D} and \lean{is\_dedekind\_domain\_inv D} was formalized,
we could painlessly replace usages of \lean{is\_dedekind\_domain\_inv R} with \lean{is\_dedekind\_domain D}.
%Separating the different definitions meshed well with the contribution philosophy followed by \mathlib, preferring small, standalone additions over in-progress work or entire finished projects.
% This is basically how gregkh described the ideal Linux patch in a talk, but I can't find a good source.

The conditions \lean{is\_dedekind\_domain} and \lean{is\_dedekind\_domain\_inv} require a fraction field $F$,
although the truth value of the predicates does not depend on the choice of $F$.
For ease of use, we let the type of \lean{is\_dedekind\_domain} only depend on the domain $D$
by instantiating $F$ in the definition as \lean{fraction\_ring D}. From now on, we fix a fraction map $f\colon D\to F$.
\begin{lstlisting}
class is_dedekind_domain (D : Type*) [integral_domain D] : Prop :=
(to_is_noetherian_ring : is_noetherian_ring D)
(dimension_le_one : dimension_le_one D)
(is_integrally_closed : integral_closure D (fraction_ring D) = ⊥)
\end{lstlisting}
Applications of \lean{is\_dedekind\_domain} can choose a specific fraction field through the following lemma exposing the alternate definition:
\begin{lstlisting}
lemma is_dedekind_domain_iff (f : fraction_map D F) :
  is_dedekind_domain D ↔
    is_noetherian_ring D ∧ dimension_le_one D ∧
    integral_closure D f.codomain = ⊥
\end{lstlisting}

We mark \lean{is\_dedekind\_domain} as a typeclass by using the keyword \lean{class} rather than \lean{structure},
allowing the typeclass system to automatically infer the Dedekind domain structure when an appropriate instance is declared, such as for PIDs or rings of integers.

\subsection{Fractional ideals}\label{subsection:frac_ideals}
%\st{When working with fraction fields, it is useful to extend the notion of $R$-ideals to fractional ideals:} 
The notion which is pivotal to the definition of the ideal class group of a Dedekind domain is that of \emph{fractional ideals}: given any integral domain $R$ with a field of fractions $F$, these are 
%$R$-ideals divided by some $x : R$,
%or equivalently 
$R$-submodules $J$ of $F$ such that there is an $x : R$ with $x J \subseteq R$. %The reason for introducing them is that, unlike their subset of proper ideals, 
%Recall that, f
For a Dedekind domain, they form a group under multiplication. As seen in Section~\ref{subsection : fields of fractions}, this notion depends on the field $F$ as well as on the fraction map $f\colon R\to F$. A more precise way of stating the above condition is then 
%  allowing to speak about $R$-submodules of $F$ and, more importantly, to see an element $x:R$ as the element $f x : F$, so as to be able to write the inclusion 
$f(x)J\subseteq f(R)$. We formalized the definition of fractional ideals relative to a map $f\colon R\to F$ as a type \lean{fractional\_ideal f}. 
%\st{The dependency on $f$ follows from the module structure on $K$ being determined by $f$.
%Despite the dependency, }
%We encoded that 
The structure of fractional ideals does not depend on the choice of a fraction map, which we formalized as an isomorphism \lean{fractional\_ideal.canonical\_equiv} between the fractional ideals relative to fraction maps $f_1\colon R\to F_1$ and $f_2\colon R\to F_2$.

We defined the addition, multiplication and intersection operations on fractional ideals,
by showing the corresponding operations on submodules map fractional ideals to fractional ideals.
We also proved that these operations give a commutative semiring structure on the type of fractional ideals.
For example, multiplication of fractional ideals is defined as:
\begin{lstlisting}
lemma fractional_mul (I J : fractional_ideal f) :
  is_fractional f (I.1 * J.1) := _ -- proof omitted

instance : has_mul (fractional_ideal f) :=
⟨λ I J, ⟨I.1 * J.1, fractional_mul I J⟩⟩
\end{lstlisting}

Defining the quotient of two fractional ideals requires slightly more work. Consider any $R$-algebra $A$ and an injection $R\hookrightarrow A$, allowing to look at $x:R$ as $x:A$: given ideals $I,J\le R$, the submodule quotient $I / J\le A$ %\footnote{The $:$ operator typically used for the submodule quotient is already reserved by the type theory, so \mathlib uses $/$ instead.}
is characterized by the property
\begin{lstlisting}
lemma submodule.mem_div_iff_forall_mul_mem {x : A} {I J : submodule R A} :
  x ∈ I / J ↔ ∀ y ∈ J, x * y ∈ I
\end{lstlisting}
Beware that the notation $1/I$ might be misleading here: indeed, for general integral domains, the equality $I\ast 1/I=1$ might not hold: as an example, one can consider the ideal $(X,Y)$ in $\C[X,Y]$. 
% An example comes from the product
% \[
% \frac{1}{(X,Y)}\ast (X,Y)=(X,Y)<\C[X,Y]
% \]
% of the fractional ideals $1/(X,Y)$ and $(X,Y)$ in the fraction field $\C(X,Y)$ of $\C[X,Y]$.
On the other hand, we formalized that this equality holds for Dedekind domains (see Section~\ref{sec:equivalence}) in the following
\begin{lstlisting}
  lemma fractional_ideal.is_unit {hD : is_dedekind_domain D}
    (I : fractional_ideal f) (hne : I ≠ ⊥) : is_unit I
\end{lstlisting}
This justifies the notation $I^{-1}=1/I$. In fact, we define this notation even for the ideal $0$, by declaring that $0^{-1}=0$. This reflects the existence of the typeclass \lean{group\_with\_zero} in \mathlib, consisting of groups endowed with an extra element \lean{0} whose inverse is again \lean{0}. %In particular, the zero fractional ideal is invertible (in the \mathlib sense) but is not a unit, leading to the strange phenomenon above. %Moreover, the fact that~\eqref{eq:mul_div_frac_ideals} might fail to hold in certain circumstances shows that, for general domains, $1/I\neq I^{-1}$. 

Moreover, \mathlib used to define \lean{$a / b := a * b^{-1}$} but our definition of $I^{-1} = 1 / I$ would cause circularity. This led us to a major refactor of this core definition. In particular, we had to weaken the definitional equality to a proposition; this involved many small changes throughout \mathlib.



% Since \lean{a / b} used to have the built-in definition $a / b = a \ast b^{-1}$, the notation $1 / I$, defined for every nonzero $I$, was conflicting with the fact that $I$ might not be invertible. Since, for Dedekind domains, we wanted to \emph{define} $I^{-1}$ as $1 / I$, a major refactor of a core definition was needed. In particular, to break the circularity, we had to weaken the definitional equality to a proposition
%
%\bigskip
%END?
%\bigskip
%
%\begin{lstlisting}
%noncomputable instance [is_dedekind_domain R] (g : fraction_map R K) :
%  has_inv (fractional_ideal g) :=
%⟨λ I, 1 / I⟩
%\end{lstlisting}
%However, if $J$ contains only the element $0$,
%then $xy = 0 \in I$ for all $y \in J$, so all $x : A$ are elements of $I / J$.
%The submodule consisting of all $x : A$ is not a fractional ideal in general,
%so we cannot simply define the quotient of two fractional ideals to be the submodule quotient.
%Instead we set $I / 0 = 0$, resulting in the following definition of the fractional ideal quotient:
%\begin{lstlisting}
%noncomputable instance fractional_ideal.has_div :
%  has_div (fractional_ideal g) :=
%⟨λ I J, if h : J = 0 then 0 else ⟨I.1 / J.1, fractional_div_of_nonzero h⟩⟩
%\end{lstlisting}
%
%In general, if there is a multiplicative inverse $J$ of $I$, such that $I J = J I = 1$, then $J = 1 / I$.
%However, the converse does not always hold: $1 / I$ is not always the multiplicative inverse of $I$.
%Indeed, the condition that $1 / I$ is an inverse for all $I$ is one of the equivalent definitions of a Dedekind domain.
%Therefore, we defined the inverse operator $\cdot^{-1}$ only for fractional ideals in a Dedekind domain:
%\begin{lstlisting}
%noncomputable instance [is_dedekind_domain R] (g : fraction_map R K) :
%  has_inv (fractional_ideal g) :=
%⟨λ I, 1 / I⟩
%\end{lstlisting}
%
%Defining the inverse in terms of the quotient caused a problem later on, when we tried to define a \lean{group\_with\_zero} instance for fractional ideals in a Dedekind domain.
%Groups with zero are defined in \mathlib as monoids with multiplication $*$ and identity $1$ along with an absorbing element $0$ and an inverse $x^{-1}$ for all $x \ne 0$; for completeness $0^{-1}$ is defined as $0$.
%An important class of examples are fields, if we ignore the addition operator $+$.
%
%The \lean{group\_with\_zero} typeclass defines its own division operator, $x / y := x y^{-1}$,
%resulting in a definitionally unequal second interpretation of $I / J = I * (1 / J)$.
%We were able to fix this issue by including the division operator as a field in \lean{group\_with\_zero},
%along with a field $\lean{div\_eq\_mul\_inv} : \forall\ a\ b, a / b = a * b^{-1}$.
%This resulted in weakening $a / b = a * b^{-1}$ from a definitional equality to a propositional equality.
%As a consequence, many \lean{group\_with\_zero} instances and proofs throughout \mathlib needed slight changes to explicily rewrite $x / y$ to $x * y^{-1}$ instead of using unification to implicitly do so; in total hundreds of lines of code needed to be changed.
%

\subsection{Equivalence of the definitions} \label{sec:equivalence}
We now describe how we proved and formalized that the two definitions \lean{is\_dedekind\_domain} and \lean{is\_dedekind\_domain\_inv} of being a Dedekind domain are equivalent. Let $D$ be a Dedekind domain, and $f\colon D\to F$ a fraction map to a field of fractions $F$ of $D$.

To show that \lean{is\_dedekind\_domain\_inv} implies \lean{is\_dedekind\_domain}, we follow the proof given by Fr\"ohlich in~\cite[Chapter 1, \S~2, ~Proposition 1.2.1]{frohlich}. A constant challenge that was faced while coding this proof was already mentioned in Section \ref{subsection : fields of fractions}, namely the fact that elements of the ring must be traced along the fraction map. %\st{ that one must work with pushforwards and pull backs of elements that belong to the ring, and hence to its localisation.}
The proofs for being integrally closed and of dimension being less than or equal to $1$ are fairly straightforward.

Proving the Noetherian condition was the most challenging. In the original proof by Fr\"ohlich, he considers elements $a_1, \dots, a_n \in I$ and $b_1, \dots, b_n \in I^{-1}$ for any nonempty fractional ideal $I$,
satisfying $ \sum_i a_i b_i = 1 $.
However, it is quite challenging to prove that an element of the product of two $D$-submodules $A$ and $B$ must be of the form $\sum_{i = 1}^m a_i*b_i$, for $a_i \in A$ and $b_i \in B$ for all $1 \leq i \leq m$.
Instead, we show that, for every element of $A\ast B$, there are finite sets $T\subseteq A$, $T'\subseteq B$ such that \lean{x : span (T * T')}, formalized as %there exists an \lean{s : finset D} whose span is contained in the ideal, and which contains the element.
%This is accomplished by the lemma 
\lean{submodule.mem\_span\_mul\_finite\_of\_mem\_mul}.
Now considering a nonzero integral ideal $I$ of the ring $D$, its invertibility allows to write \lean{1 : (1 : fractional\_ideal f) = I * 1 / I}. Hence, we obtain 
% due to its invertibility (as a fractional ideal), by \lean{submodule.mem\_span\_mul\_finite\_of\_mem\_span\_mul}, we %obtain 
finite sets $T \subset I$ and $T' \subset 1/I$ such that $1$ is contained in the $D$-span of $T*T'$. We used \lean{norm\_cast} to resolve most coercions, however, this tactic did not solve coercions coming from the fraction map. With coercions, the actual statement of the latter expression in Lean is \lean{↑T' ⊆ ↑↑(1 / ↑I)}, which reads:
\begin{lstlisting}
(T' : set (fraction_ring.of D).codomain) ⊆ (((1 / (I : fractional_ideal (fraction_ring.of D))) : submodule D (fraction_ring.of D).codomain) : set (fraction_ring.of D).codomain
\end{lstlisting}
The lemma \lean{fg\_of\_one\_mem\_span\_mul} then shows that $I$ is finitely generated, concluding the proof.

The theorem \lean{fractional\_ideal.mul\_inv\_cancel} proves the converse, namely that \lean{is\_dedekind\_domain} implies \lean{is\_dedekind\_domain\_inv}. The classical proof consists of three steps: first, every maximal ideal $M\subseteq D$, seen as a fractional ideal, is invertible; seconly, every nonzero ideal is invertible, using that it is contained in a maximal ideal; finally, the fact that every fractional ideal $J$ satisfies $xJ\leq I$ for a suitable $x\in D$ and an ideal $I\subseteq D$ implies that every fractional ideal is invertible, concluding the proof that nonzero fractional ideals form a group. The third step was easy, building upon the material developed for the general theory of \lean{fractional\_ideals f}. Concerning the first two, we found that passing from the case where $M$ is maximal to the general case required more code than directly showing invertibility of arbitrary nonzero ideals. The formal statement reads
\begin{lstlisting}
lemma coe_ideal_mul_one_div [hD : is_dedekind_domain D] 
  (I : ideal D) (hne : I ≠ ⊥) :
  ↑I * ((1 : fractional_ideal f) / ↑I) = (1 : fractional_ideal f) :=
\end{lstlisting}
from where it becomes apparent that we had to repeatedly distinguish between \lean{I:ideal D}, and its coercion \lean{↑I:fractional\_ideal f} although these objects, from a mathematical point of view, are identical.

The proof of the above result relies on the lemma \lean{exists\_not\_mem\_one\_of\_ne\_bot}, which says that for every non-trivial ideal $0\subsetneq I\subsetneq D$, there exists an element in the field $F$ which is not integral (so, not in $f(D)$) but lies in $1/I$. The proof begins by invoking that every nonzero ideal in the Noetherian ring $D$ contains a product of nonzero prime ideals. This result was not previously available in \mathlib. %, and we formalized it as \lean{exists\_prime\_spectrum\_prod\_le\_and\_ne\_bot\_of\_domain}.
It is when applying this that the dimension condition shows its full force: each prime ideal in the product, being nonzero, will be maximal because the Krull dimension of $D$ is at most $1$; from this, \lean{exists\_not\_mem\_one\_of\_ne\_bot} follows easily. Having the above lemma at our disposal, we can prove that every ideal $I\ne 0$ is invertible by arguing by contradiction: if $I\ast 1/I\lneq D$, we can find an element $x\in F\setminus f(R)$ which is in $1/(1\ast 1/I)$ thanks to \lean{exists\_not\_mem\_one\_of\_ne\_bot} and some easy algebraic manipulation will imply that $x$ is actually integral over $D$. Since $D$ is integrally closed, it must lie in $f(D)$, contradicting its construction. Combining these results gives the equivalence between the two conditions for being a Dedekind domain.

% The final step, when we prove that invertibility of ideals implies that of fractional ones as well, was easy: the material developed for the general theory of \lean{fractional\_ideals f} allowed to smoothly deduce that a fractional ideal $J$ must be invertible as soon as a certain multiple $xJ$ of it is, and since there always exists an $\lean{x : D}$ satisfying the latter condition (because $xJ$ can be made into a ``usual'' ideal), this leads to the final \lean{lemma fractional\_ideal.is\_unit} quoted above.
% \subsection{from above}
% In our setting, %we consider a field of fractions $K$, together with a localization map $f\colon R\to K$: 
% we can look at every ideal as the fractional ideal $I/1 \le F$. The first main theoretical result that we need to define the ideal class group is to show that every nonzero ideal $0<I \le R$ becomes invertible when seen as a fractional ideal: this means, by definition, that the equality 
% \begin{equation}\label{eq:mul_div_frac_ideals}
% f(I) \ast \frac{1}{f(I)} = 1=f(R)\le F
% \end{equation}
% as $R$-submodules of $F$, holds. 

% it can be proved that Dedekind domain are precisely the right class of integral domains for which~\eqref{eq:mul_div_frac_ideals} always holds. This was formalised as the following
% \begin{lstlisting}
% lemma fractional_ideal.is_unit {hD : is_dedekind_domain D}
%   (I : fractional_ideal f) (hne : I ≠ ⊥) : is_unit I :=
% \end{lstlisting}
% together with
% \begin{lstlisting}
% noncomputable instance [is_dedekind_domain D] (g : fraction_map D F) :
%   has_inv (fractional_ideal g) :=
% ⟨λ I, 1 / I⟩
% \end{lstlisting}
% asserting that the inverse of any fractional ideal $I$ (defined as another fractional ideal $J$ such that $I\ast J=1$)---which always exists thanks to the \lean{lemma fractional\_ideal.is\_unit}---is unique and coincides with $1/I$.
%The proof goes along these lines: we differentiate into cases when the Dedekind domain $A$ is and is not a field.
%This is done because our main argument requires that every nonzero ideal must contain a product of nonzero prime ideals (\lean{exists\_prime\_spectrum\_prod\_le\_and\_ne\_bot\_of\_domain}),
%and fields don't have nonzero prime ideals.
%The field case is trivial, since the only nonzero fractional ideal in a field is the field itself (\lean{fractional\_ideal.eq\_zero\_or\_one\_of\_is\_field}).
%When $R$ is not a field, the standard proof first shows that it is suffices that maximal ideals of $R$ are invertible~\cite[Proposition 3.8]{Neukirch}.
%% using the factorization of into prime ideals (which are maximal in a Dedekind domain), but we show something more general.
%We show in general that it is sufficient to prove invertibility for nonzero ideals of $R$.
%This is done in the lemma \lean{coe\_ideal\_mul\_one\_div}.
%
%We consider, for a nonzero ideal $I$, the ideal $J := I * (1/I)$, and show that $1/J \leq 1 \le J$, hence $J = 1$ since $J \le 1$ holds in an arbitrary domain. So, we want to show that any element $x \in 1/J$ is in $R$, or equivalently, since we have \lean{is\_dedekind\_domain R}, it suffices to prove that $x$ is in the integral closure of $R$. We consider $A := R[x]$, and show that $A \leq 1/I$, which is Noetherian, hence $A$ is a finitely generated subalgebra containing $x$. It suffices to prove that for every $n \in \mathbb{N}$, $x^n \in 1/I$. This follows from repeated usage of the lemma \lean{submodule.mem\_div\_iff\_forall\_mul\_mem} and \lean{fractional\_ideal.coe\_div}. The latter statement requires $I$ and $J$ to be nonzero. 
\section{Principal ideal domains are Dedekind}

As an example of our definitions, we will discuss in some detail our formalization of the fact that a principal ideal domain is a Dedekind domain. There is no explicit definition of PIDs in \mathlib, rather it is split up into two hypotheses.
One uses \lean{[integral\_domain R] [is\_principal\_ideal\_ring R]} to denote a PID $R$,
where \lean{is\_principal\_ideal\_ring} is a typeclass defined for all commutative rings:
\begin{lstlisting}
class is_principal_ideal_ring (R : Type*) [comm_ring R] : Prop :=
(principal : ∀ (I : ideal R), is_principal I)
\end{lstlisting}

Our proof that the hypotheses \lean{[integral\_domain R] [is\_principal\_ideal\_ring R]} imply \lean{is\_dedekind\_domain R} is relatively short:
\begin{lstlisting}
instance principal_ideal_ring.to_dedekind_domain (R : Type*)
  [integral_domain R] [is_principal_ideal_ring R] :
  is_dedekind_domain R :=
⟨principal_ideal_ring.is_noetherian_ring,
 dimension_le_one.principal_ideal_ring _,
 unique_factorization_monoid.integrally_closed (fraction_ring.of R)⟩
\end{lstlisting}
The \lean{instance} keyword marks the declaration for inference by the typeclass system.
%Making this an \lean{instance} instead of a \lean{lemma} ensures that the typeclass system can now automatically infer a Dedekind domain structure whenever a principal ideal structure is already available.

The Noetherian property of a Dedekind domain follows easily by the previously defined lemma \lean{principal\_ideal\_ring.is\_noetherian\_ring}, since, by definition, each ideal in a principal ideal ring is finitely generated (by a single element).

The lemma \lean{dimension\_le\_one.principal\_ideal\_ring} is an instantiation of the existing result \lean{is\_prime.to\_maximal\_ideal} showing a nonzero prime ideal in a PID is maximal.
The latter lemma uses the characterization that $I$ is a maximal ideal if and only if any strictly larger ideal $J\supsetneq I$ is the full ring $R$.
% This proof is probably a bit too detailed: if someone wanted to know all details, they can read the formalization.
%The proof says : suppose a prime ideal I is properly contained in an ideal J, then $1 \in J$. Let $i \in I$ and $j \in J$ be generators of $I$ and $J$ respectively. Since $I \subset J$, $\exists a \in A$ such that $i = a * j$. Since $I$ is a prime ideal, this implies that either $a \in I$ or $j \in I$. The latter would imply that $I = J$, which contradicts our assumption that $I$ is properly contained in $J$. The former would imply that $\exists k \in A$ such that $a = k * i = k * (a * j)$. Since $A$ is an integral domain, we then have $k * j = 1$, which implies that $1 \in J$, as required. 
If $I$ is a nonzero prime ideal and $J \supsetneq I$ in the PID $R$, we have that the generator $j$ of $J$ is a divisor of the generator $i$ of $I$. Since $I$ is prime, this implies that either $j \in I$, contradicting the assumption that $J \supsetneq I$, $i = 0$, contradicting that $I$ is nonzero, or that $j$ is a unit, implying $J = R$ as desired.

The final condition of a PID being integrally closed is the most challenging.
We use the previously defined instance \lean{principal\_ideal\_ring.to\_unique\_factorization\_monoid} that a PID is a unique factorisation monoid (UFM),
to instantiate our proof that every UFM is integrally closed.
In the same way that principal ideal domains are generalized to principal ideal rings, \mathlib generalizes unique factorization domains to unique factorization monoids.
A commutative monoid $R$ with an absorbing element $0$ and injectivity of multiplication is defined to be a UFM,
if the relation ``$x$ properly divides $y$'' is well-founded (implying each element can be factored as a product of irreducibles) and
an element of $R$ is prime if and only if it is irreducible (implying the factorization is unique).
The first condition is satisfied for a PID since the Noetherian property implies that the division relation is well-founded.
The second condition follows from \lean{principal\_ideal\_ring.irreducible\_iff\_prime}.
To prove that an irreducible element $p$ is prime, the proof uses that prime elements generate prime ideals and irreducible elements of a PID generate maximal ideals. Since all maximal ideals are prime ideals, the ideal generated by $p$ is maximal, hence prime, thus $p$ is prime.
The lemma \lean{irreducible\_of\_prime} proves the converse holds in any commutative monoid with zero.

In order to show that a UFM is integrally closed, we first proved the Rational Root Theorem, named \lean{denom\_dvd\_of\_is\_root},
which states that for polynomial $p : R[X]$ and $x$ an element of the fraction field $\Frac R$ such that $p(x) = 0$, the denominator of $x$ divides the leading coefficient of $p$.
If $x$ is integral with minimal polynomial $p$, the leading coefficient is $1$, therefore the denominator is a unit and $x$ is an element of $R$.
This gives us the required lemma \lean{unique\_factorization\_monoid.integrally\_closed}, which states that the integral closure of $R$ in its fraction field is $R$ itself.

\section{Rings of integers are Dedekind domains} \label{sec:integral-closure}

%An important class of Dedekind domains consists of the rings of integers of number fields.%TODO Haven't we said this already at the beginning?

An important classical result in algebraic number theory, is that the ring of integers of a number field $K$, defined as the integral closure of $\Z$ in $K$, is a Dedekind domain. We formalized a stronger result: given a Dedekind domain $D$ and a field of fractions $F$, if $L$ is a finite separable extension of $F$, then the integral closure of $D$ in $L$ is a Dedekind domain with fraction field $L$.
Our approach adapts \cite[Theorem~3.1]{Neukirch}.
Throughout this section, let $D$ be a Dedekind domain with a field of fractions $F$ (given by the map $f \colon D \to F$), $L$ a finite, separable field extension of $F$ and let $S$ denote the integral closure of $D$ in $L$.
% corresponding to the following Lean declarations:
%% either the above or below, both might be unnecessary
%% \begin{lstlisting}
%% variables {R K L : Type*} [integral_domain R] [field K] [field L]
%% variables (f : fraction_map R K)
%% variables [algebra f.codomain L] [algebra R L] [is_scalar_tower R L]
%% notation `S` := integral_closure R L
%% \end{lstlisting}

The first step is to show that $L$ is a field of fractions for the integral closure, namely that there is a map \lean{fraction\_map\_of\_finite\_extension f L : fraction\_map S L}.
%We formalized the following definition, which implies the desired result:
%\begin{lstlisting}
% def fraction_map_of_algebraic (alg : is_algebraic D L)
%   (inj : function.injective (algebra_map D L)) :
%   fraction_map S L
% \end{lstlisting}
The main content of \lean{fraction\_map\_of\_finite\_extension} consists of showing that all elements $x : L$ can be written as $y / z$ for elements $y \in S$, $z \in D \subseteq S$;
the standard proof of this fact (see~\cite[Theorem~15.29]{Dummit-and-Foote}) formalizes readily.
%Since $x$ is algebraic over $A$, it satisfies an equation $a_n x^n + a_{n-1} x^{n-1} + \cdots + a_0 = 0$, with $a_n, \dots, a_0 : A$.
%Multiplying each term by $a_n^{n-1}$, we see $(a_n x)^{n} + a_{n-1} (a_n x)^{n - 1} + \cdots + a_0 a_n^{n-1} = 0$,
%therefore $a_n x$ is integral, and we can write $x = (a_n x) / a_n$.

Now we are ready to show that the integral closure of $D$ in $L$ is a Dedekind domain,
by proving it is integrally closed in $L$, has Krull dimension at most $1$ and is Noetherian.
The fact that the integral closure is integrally closed is immediate.

To show the Krull dimension is at most $1$, we needed to develop basic going-up theory for ideals.
In particular, we show that an ideal $I$ in an integral extension is maximal if it lies over a maximal ideal,
and use a result already available in \mathlib that a prime ideal $I$ in an integral extension lies over a prime ideal.
%% Do the lemmas need to be stated, especially the second one?
\begin{lstlisting}
lemma is_maximal_of_is_integral_of_is_maximal_comap
  (I : ideal S) [is_prime I]
  (hI : is_maximal (comap f I)) : is_maximal I
theorem is_prime.comap (I : ideal S) [hI : is_prime I] :
  is_prime (comap f I)
\end{lstlisting}

The final condition, that the integral closure $S$ of $D$ in $L$ is a Noetherian ring, requires the most work.
We start by following the first half of \cite[Theorem~15.29]{Dummit-and-Foote},
so that it suffices to find a nondegenerate bilinear form $B$ such that all integral $x, y : L$ satisfy $B(x, y) \in \lean{integral\_closure}\ D\ L$.
We formalized the results in \cite[\S\S~2.5--2.8]{Neukirch}, to show the \emph{trace form} is a bilinear form satisfying these requirements.

\subsection{The trace form}\label{sec:trace-form}
In the notation from the previous section, consider the bilinear form \lean{lmul := $\lambda$ x y $:$ S, x~*~y}.
The trace of the linear map \lean{lmul x} is called the \emph{algebra trace} $\Tr_{L / F}(x)$ of $x$.
We define the algebra trace\footnote{In fact, we define the trace and trace form for any algebra over a commutative ring.
For simplicity of exposition in this paper we will only consider finite extensions of fields.} as a linear map from $L$ to $F$:
\begin{lstlisting}
noncomputable def trace : L →ₗ[F] F :=
linear_map.comp (linear_map.trace F L) (to_linear_map (lmul F L))
\end{lstlisting}
This definition is marked noncomputable since \lean{linear\_map.trace} makes a case distinction on the existence of a basis,
choosing an arbitrary basis if one exists and returning $0$ otherwise.
This latter case does not occur in our development.

The \emph{trace form} is an $F$-bilinear form on $L$, mapping $x, y : L$ to $\Tr_{L/F}(xy)$.
\begin{lstlisting}
noncomputable def trace_form : bilin_form F L :=
{ bilin := λ x y, trace F L (x * y), .. /- proofs omitted -/ }
\end{lstlisting}

 %% We are only considering trace forms of finite field extensions in this paper.
In the following, let $E / L / F$ be a tower of finite extensions of fields, namely we assume \lean{[algebra E L] [algebra L F] [algebra E F] [is\_scalar\_tower E L F]}, as described in Section~\ref{sec:scalar_tower}.

The value of the trace depends on the choice of $E$ and $L$; we formalized this as lemmas \lean{trace\_algebra\_map x $:$ trace E L (algebra\_map E L x) = findim E L • x} as well as \lean{trace\_comp L x $:$ trace E F x = trace E L (trace L F x)}.
%Since a basis $b : \iota \to L$ for $K : L$ and a basis $c : \kappa \to F$ for $L : F$ induce a basis $b \cdot c : \iota \times \kappa \to F$ for $K : F$,
These results follow by direct computation.

To compute $\Tr_{L/F}(x)$ it therefore suffices to consider the trace of $x$ in the smallest field containing $x$ and $F$, which is the simple extension $F(x)$ discussed in Section \ref{sec:simple-field-extension}.
There is a nice formula for the trace in $F(x)$, although the terms in this formula are elements in a larger field $E$
(such as the \emph{splitting field} of the minimal polynomial of $x$).
In formalizing this formula, we must first map the trace to $F$ using the canonical embedding $\lean{algebra\_map E F}$,
giving the following lemma statement:
\begin{lstlisting}
lemma power_basis.trace_gen_eq_sum_roots (pb : power_basis F L)
  (h : polynomial.splits (algebra_map F E) pb.minpoly_gen) :
  algebra_map F E (trace F L pb.gen) =
    sum (roots (map (algebra_map F E) pb.minpoly_gen))
\end{lstlisting}
%Applying this result to a specific $x$ is then a question of applying it to the power basis for $K(x)$ generated by $x$, to give:
%\begin{lstlisting}
%lemma trace_eq_sum_roots [finite_dimensional K L]
%  {x : L} (hx : is_integral K x)
%  (hF : (minimal_polynomial hx).splits (algebra_map K F)) :
%  algebra_map K F (algebra.trace K L x) =
%  (findim K(x) L) • ((minimal_polynomial hx).map (algebra_map K F)).roots.sum
%\end{lstlisting}
We formulate the lemma in terms of the power basis, since we will need to use it for $F(x)$ here
and for an arbitrary finite separable extension $L / F$ later in the proof.

The elements of \lean{(pb.minpoly\_gen.map (algebra\_map F E)).roots} are called \emph{conjugates} of $x$ in $E$.
Each conjugate of $x$ is integral since it is a root of (the same) monic polynomial,
and integer multiples and sums of integral elements are integral.
Combining \lean{trace\_gen\_eq\_sum\_roots} and \lean{trace\_algebra\_map} shows that the trace of $x$ is an integer multiple (namely \lean{findim F(x) L}) of a sum of conjugate roots, hence we conclude that the trace (and trace form) of an integral element is also integral.
% It would be marginally easier if `is_integral' was just an auxiliary definition for the subalgebra
% `integral_closure', since subalgebras are closed under sums and smul "for free".

Finally, we show the trace form is nondegenerate, following~\cite[Proposition~2.8]{Neukirch}.
Since $L / F$ is a finite, separable field extension, it has a power basis \lean{pb} generated by $x$.
Letting $x_k$ denote the $k$-th conjugate of $x$ in an algebraically closed field $E / L / F$,
the main difficulty lies in checking the equality $\sum_k x_k^{i + j} = \Tr_{L / F} (x^{i + j})$.
Directly applying \lean{trace\_gen\_eq\_sum\_roots} is tempting, since we have a sum over conjugates of powers on both sides.
However, the two expressions will not precisely match: the left hand side is a sum of conjugates of $x$, where each conjugate is raised to the power $i + j$,
while the conclusion of \lean{trace\_gen\_eq\_sum\_roots} results in a sum over conjugates of $x^{i + j}$.

Instead, the paper proof switches here to an equivalent definition of conjugate:
the conjugates of $x$ in $E$ are the images (counted with multiplicity) of $x$ under each embedding $\sigma \colon F(x) \to E$ that fixes $F$. This equivalence between the two notions of conjugate was contributed to \mathlib by the Berkeley group in the week before we realized we needed it. Mapping \lean{trace\_gen\_eq\_sum\_roots} through the equivalence gives
$\Tr_{L / F}(x) = \sum_{\sigma} \sigma x$.
% \lean{algebra\_map F E (trace F L pb.gen) = ∑ (σ : L →ₐ[F] E), σ pb.gen}.
Since each $\sigma$ is a ring homomorphism, $\sigma\ x^{i + j} = (\sigma\ x)^{i + j}$,
so the conjugates of $x^{i + j}$ are the $(i + j)$-th powers of conjugates of $x$, concluding the proof.

\section{Class group and class number} \label{sec:class-number}

% Recall that the ideal class group of an integral domain $R$ is defined as the quotient of the invertible fractional ideals modulo the principal fractional ideals.
Given a Dedekind domain with fraction map $f\colon D\to F$, we formalize the notion of class group in Lean by defining a map \lean{to\_principal\_ideal f:units f.codomain → units (fractional\_ideal f)}, %sending $x : K^\times$ to the principal ideal $\langle x \rangle$,
and define the class group as
\begin{lstlisting}
def class_group := quotient_group.quotient (to_principal_ideal (range f))
\end{lstlisting}
% to be the quotient group modulo \lean{to\_principal\_ideal.range}.
%Or equivalently, if the domain $R$ is Dedekind, the nonzero ideals of $R$ modulo the nonzero elements of $R$.
%For a Dedekind domain, the class group captures a lot of its factorization properties, e.g. the invertible fractional ideals consist of all nonzero ideals (which is one of the characterizing properties), and the class group is trivial if and only if the Dedekind domain is a UFD (iff it is a PID).
In general, Dedekind domains can have infinite class groups. However, as discussed in Section~\ref{sec math background}, the rings of integers of global field have finite class group.
% This result is a fundamental finiteness result in algebraic number theory.

We let $K$ be a number field and $K'$ be a function field, with ring of integers $\OK$ and $\OK[K']$, respectively. 
% Let $R$ denote the ring of integers inside some number field, and let $S$ denote the ring of integers inside some function field.
Most proofs of the finiteness of $\Cl_{\OK}$ one finds in a modern textbook (see~\cite[Theorems 4.4,~5.3,~6.3]{Neukirch}) depend on Minkowski's lattice point theorem, a result from the geometry of numbers (which has been formalized in Isabelle/HOL~\cite{Minkowskis_Theorem-AFP}).
Extending this proof to show the finiteness of $\Cl_{\OK[K']}$ is quite involved and does not result in a uniform proof for $\Cl_{\OK}$ and $\Cl_{\OK[K']}$.
%The formalization setup we are after is not only the finiteness of $\Cl_R$, but also the finiteness of $\Cl_S$ (at least in the setting of separable field extensions).
%While there exist analogues of Minkowski's theorem in the function field setting, which can be used for proving finiteness of $\Cl_S$, formalizing this approach would be quite involved and would also not give a very uniform proof of the finiteness of $\Cl_R$ and  $\Cl_S$.
Our formalization adapts and generalizes a classical approach to the finiteness of $\Cl_{\OK}$, where the use of Minkowski's theorem is replaced by the pigeonhole principle. This approach seems to go back to Kronecker
%\footnote{\url{https://mathoverflow.net/questions/19021/avoiding-minkowskis-theorem-in-algebraic-number-theory/19035#19035}}
and can be found, for instance, in~\cite{Ireland-Rosen}. 
%so that on the one hand most ingredients became more \mathlib ``friendly'' (by e.g. avoiding unnecessary field extensions, as used for example in norm estimates), and on the other hand it works in the function field setting as well.
We note that some other ``uniform'' approaches can be found in~\cite{Artin-Whaples} and~\cite{Stasinski}.

Let $D$ be an Euclidean domain: in particular, it will be a PID and hence a Dedekind domain. Given a fraction map $f \colon D \to F$, let $L$ be a finite separable field extension of $F$.
We formalize in the theorem \lean{class\_group.finite\_of\_admissible} that the integral closure of $D$ in $L$ has a finite class group if $D$ has an ``admissible'' absolute value \lean{abs}.
%In other words, we require that $R$ is a Dedekind domain with ``division with remainder'' operators \lean{/, \%} and an absolute value operator such that:
%\begin{align*}
%	|a \% b| &< |b| & (\lean{mod\_lt}) \\
%	|a| & \le |a * b| & (\lean{mul_left_mono}) \\
%\end{align*}
%\begin{lstlisting}
%(card : ℝ → ℕ)
%(exists_partition' : ∀ (n : ℕ) {ε : ℝ} (hε : 0 < ε) (b : R) (hb : b ≠ 0) (A : fin n → R),
%                     ∃ (t : fin n → fin (card ε)),
%                     ∀ i₀ i₁, t i₀ = t i₁ → (to_fun (A i₁ % b - A i₀ % b) : ℝ) < to_fun b • ε)
%\end{lstlisting}
Informally, the admissibility conditions require that the remainder operator produces values that are not too far apart.
Formally, we define the type of admissible absolute values on $D$ as follows, where \lean{to\_fun} stands for an application of the absolute value operator:
\begin{lstlisting}
structure admissible_absolute_value (D : Type*) [euclidean_domain D]
  extends euclidean_absolute_value D ℤ :=
(card : ℝ → ℕ) (exists_partition :
  ∀ (n : ℕ) (ε > (0 : ℝ) (b ≠ (0 : D)) (A : fin n → D),
  ∃ (t : fin n → fin (card ε)), ∀ i₀ i₁, t i₀ = t i₁ →
  (to_fun (A i₁ % b - A i₀ % b) : ℝ) < to_fun b • ε)
\end{lstlisting}

The above condition formalizes an intermediate result in pen-and-paper finiteness proofs;
the different proofs for number fields and function fields (still assuming $L/F$ separable) are the same after this point.
We use division with remainder to replace the \emph{fractional part} operator on $F$ in the classical proof,
allowing our proof to stay entirely within $D$ to avoid coercions.

The absolute value extends to a norm \lean{abs\_norm f abs:integral\_closure D L → ℤ}.
We use the admissibility of \lean{abs} to find a finite set \lean{finset\_approx L f abs} of elements of $D$,
such that the following generalization of~\cite[Theorem~12.2.1]{Ireland-Rosen} holds.
\begin{lstlisting}
theorem exists_mem_finset_approx' (a b : integral_closure D L) :=
  ∃ (q : integral_closure D L) (r ∈ finset_approx L f abs),
  abs_norm f abs (r • a - q * b) < abs_norm f abs b
\end{lstlisting}
After this, the classical approach mentioned above formalizes smoothly.

It remains to define an admissible absolute value for $\Z$ and $\Fq[q][t]$. On $\Z$, it is straightforward to formalize that the usual Archimedean absolute fulfils the requirements. For $\Fq[q][t]$, we show that $\lvert f\rvert_{\deg}:=q^{\deg f}$ for $f \in \Fq[q][t]$ is the required admissible absolute value; observe that this is somewhat more involved to formalize.
%(Note that these absolute values coincide with cardinalities in corresponding residue rings, but we do not need this result.)
We conclude that when $K$ is a global field (restricting to \emph{separable} extensions of $\Fq[q][t]$ in the function field case), the class group is finite:
\begin{lstlisting}
noncomputable instance : fintype
  (class_group (number_field.ring_of_integers.fraction_map K)) :=
class_group.finite_of_admissible K int.fraction_map int.admissible_abs

variables [is_separable f.codomain K]
noncomputable instance : fintype
  (class_group (function_field.ring_of_integers.fraction_map f K)) :=
class_group.finite_of_admissible F f polynomial.admissible_card_pow_degree
\end{lstlisting}

Finally, we define \lean{number\_field.class\_number} and \lean{function\_field.class\_number} as the cardinality of the respective class groups.

\section{Discussion}

\subsection{Related work}

Broadly speaking, one could see the formalization work as part of number theory. There are several formalization results in this direction; see, for instance, ~\cite[Section 6]{CapSetProblem}, most notably the formalization in Isabelle/HOL of a substantial part of analytic number theory~\cite{Eberl19}.
Narrowing somewhat to a more algebraic setting, we are not aware of any other formal developments of fractional ideals, Dedekind domains or class groups of global fields.
%Since our project touches upon the theories of field extensions, ideals, number fields and number rings,
%we provide here a partial overview of formalizations in these areas.

There are many libraries formalizing basic notions of commutative algebra such as field extensions and ideals, including the Mathematical Components library in Coq~\cite{mathcomp}, the algebraic library for Isabelle/HOL~\cite{algebra_isabelle}, the \texttt{set.mm} database for MetaMath~\cite{metamath} and the Mizar Mathematical Library~\cite{algebraic-hierarchy_mizar}. The field of algebraic numbers, or more generally algebraic closures of arbitrary fields, are also available in many provers, for example Coq~\cite{real-algebraic-numbers-coq, mathcomp}, Isabelle/HOL~\cite{algebraic-numbers-isabelle}, MetaMath~\cite{algebraic-numbers-metamath}, and Mizar~\cite{algebraic-numbers-mizar}. To our knowledge, the Coq Mathematical Components library is the only formal development beside ours specifically dealing with number fields~\cite[\texttt{field/algnum.v}]{mathcomp}.

Apart from the general theory of algebraic numbers, there are formalizations of specific number rings: the Gaussian integers $\Z[i]$ are available in Isabelle/HOL~\cite{gaussian_integers-isabelle}, MetaMath~\cite{gaussian_integers-metamath} and Mizar~\cite{gaussian_integers-mizar}.
The Isabelle/HOL formalization deserves special mention since it introduces techniques from algebraic number theory,
defining the integer-valued norm on $\Z[i]$ and classifying the prime elements of $\Z[i]$.

\subsection{Future directions}

Having formalized various basic results of algebraic number theory, there are several natural directions for future formalization work, including the following.
%
Finiteness of the class group for the ring of integers in all global fields, which would entail, amongst other things, dropping the separability condition in the result mentioned in the first paragraph of Section~\ref{sec:integral-closure}.
Finite generation of the group of units of the ring of integers in a number field, or slightly stronger, Dirichlet's unit theorem~\cite[Theorem 7.4]{Neukirch} (and the function field analogue). 
%
Other finiteness results in algebraic number theory, most notably Hermite's theorem about the existence of only finitely many number fields, up to isomorphism,
with bounded discriminant~\cite[Theorem 2.16]{Neukirch} (and the function field analogue). 
%
Verification of number theoretic software, such as KASH/KANT~\cite{kash} and PARI/GP~\cite{PARI2}, e.g. class number computations for quadratic number fields.
%
Applications to Diophantine equations, e.g. determining all pairs of integers $(x,y)$ such that $y^2=x^3+D$ for several given ``interesting'' $D\in\Z$.


%\begin{itemize}
%\item Finiteness of the class group for the ring of integers in all global fields. This would entail dropping the separability condition in the result mentioned in the first paragraph of Section~\ref{sec:integral-closure}, and consequently adapt some of the details in the final steps for the finiteness of the class group in the admissible case. Some basic prerequisites would be setting up some field theory dealing with (finite) inseparable field extensions, especially the purely inseparable ones. 
%All in all this seems a tedious though reasonable project.
%\item Finite generation of the group of units of the ring of integers in a number field, or slightly stronger, Dirichlet's unit theorem~\cite[Theorem 7.4]{Neukirch}. This seems a somewhat more involved, but still reasonable, project. The finite generation result also holds for function fields, so actually it would be nice (and doable) to consider all global fields (which would  involve finite inseparable field extensions, as in the previous item).
%\item Other finiteness results in algebraic number theory, most notably Hermite's theorem about the existence of only finitely many number fields, up to isomorphism,
%% or embedded in a fixed algebraically closed field containing $\Q$, e.g. $\C$) 
%with bounded discriminant~\cite[Theorem 2.16]{Neukirch}. 
%%This would be significantly more involved than the previous items and would require, amongst other things, setting up a lot of ramification theory (which is very important for algebraic number theory).
%%Also, Minkowski's lattice point theorem now becomes more essential (as far as we are aware).
%As usual, there are analogue results in the function field setting, though they are less straightforward. One reason being that the nondegenerateness of the trace form from Section~\ref{sec:trace-form} does not hold any more when the separability condition is dropped.
%\item From a computational point of view, our formalization lays some foundations to the verification of number theoretic software, such as KASH/KANT~\cite{kash} and PARI/GP~\cite{PARI2}. Verifying computations for class groups, or just class numbers, in the case of ``small'' (say, quadratic) number fields, looks within reach. Of course, getting really efficient algorithms (or certificates), is a hard research topic. 
%% Which relates to the ERC consolidator grant of Assia Mahboubi..
%\item %Number theoretic applications.
% All the above items consider theoretical or computational aspects within algebraic number theory itself. There are many applications of these, for instance solving Diophantine equations. Solving Mordell equations, which asks for determining all pairs of integers $(x,y)$ such that $y^2=x^3+D$ for a given nonzero $D\in\Z$, could be an interesting first case study. Dealing with some values of $D$ where elementary methods fail would already be interesting.
%\end{itemize}

\subsection{Conclusion}

In this project, we confirmed the rule that the hardest part of formalization is to get the definitions right.
Once this is accomplished, the ``pen and paper'' proof almost always translated to a formal proof without too much effort.
% Informal mathematics effortlessly switches between different viewpoints, choosing whichever suits the situation best.
In particular, we regularly had to invent abstractions in order to treat instances of the ``same'' situation uniformly.
Instead of fixing a canonical representation, be it $K \subseteq L \subseteq F$ as subfields, or the field of fractions $\Frac R$, or the monogenic $K(\alpha)$, we found that making the essence of the situation an explicit parameter, as in \lean{is\_scalar\_tower}, \lean{fraction\_map} or \lean{power\_basis},
allows to treat equivalent viewpoints uniformly without the need for transferring results.

The formalization efforts described in this paper cannot be cleanly separated from the development of \mathlib as a whole.
The decentralized organization and highly integrated design of \mathlib meant that we could contribute our formalizations as we completed them, resulting in a quick integration into the rest of the library.
Other contributors building on these results often extended them to meet our requirements,
before we could identify that we needed them, as the anecdote in Section \ref{sec:subobjects} illustrates.
In other words, the low barriers for contributions ensured mutually beneficial collaboration.

The formalization project described in this paper resulted in the contribution of thousands of lines of Lean code involving hundreds of declarations.
We validated existing design choices used in \mathlib, refactored those that did not scale well
and contributed our own set of designs.
The real achievement was not to complete each proof,
but to build a better foundation for formal mathematics.


\bibliography{lean}

\end{document}
