\documentclass[a4paper,USenglish,cleveref, autoref, thm-restate]{lipics-v2021}
%see https://submission.dagstuhl.de/documentation/authors

\bibliographystyle{plainurl}% the mandatory bibstyle

\title{A formalization of Dedekind domains and class groups of global fields}
\titlerunning{Dedekind domains and class groups}

\author{Anne Baanen}{Vrije Universiteit Amsterdam, Netherlands \and \url{https://cs.vu.nl/~tbn305}}{t.baanen@vu.nl}{https://orcid.org/0000-0001-8497-3683}{Received funding from the NWO under the Vidi program (project No. 016.Vidi.189.037, Lean Forward)}
\author{Sander Dahmen}{Vrije Universiteit Amsterdam, Netherlands \and \url{https://few.vu.nl/~sdn249/}}{s.r.dahmen@vu.nl}{orcID?}{funding?}
\author{Ashvni Narayanan}{affiliation? \and website?}{email}{orcID?}{funding?}
\author{Filippo A. E. Nuccio}{affiliation? \and website?}{email}{orcID?}{funding?}

\authorrunning{T. Baanen, S. Dahmen, A. Narayanan and F. A. E. Nuccio}

\Copyright{Anne Baanen, Sander Dahmen, Ashvni Narayanan and Filippo A. E. Nuccio}

\ccsdesc[500]{Mathematics of computing~Mathematical software}
\ccsdesc[500]{Security and privacy~Logic and verification}

\keywords{formal math,algebraic number theory,commutative algebra,Lean,mathlib} %TODO mandatory; please add comma-separated list of keywords

\supplement{Full source code of the formalization is part of mathlib. Copies of the source files relevant to this paper are available in a separate repository.}
\supplementdetails[swhid={Software Heritage Identifier}]{Software}{https://github.com/lean-forward/class-number}

\acknowledgements{I want to thank \dots}%optional

%\nolinenumbers %uncomment to disable line numbering

%\hideLIPIcs  %uncomment to remove references to LIPIcs series (logo, DOI, ...), e.g. when preparing a pre-final version to be uploaded to arXiv or another public repository

%Editor-only macros:: begin (do not touch as author)%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\EventEditors{John Q. Open and Joan R. Access}
\EventNoEds{2}
\EventLongTitle{42nd Conference on Very Important Topics (CVIT 2016)}
\EventShortTitle{CVIT 2016}
\EventAcronym{CVIT}
\EventYear{2016}
\EventDate{December 24--27, 2016}
\EventLocation{Little Whinging, United Kingdom}
\EventLogo{}
\SeriesVolume{42}
\ArticleNo{23}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage{xcolor}
\usepackage{xspace}
\usepackage{listings}
\def\lstlanguagefiles{lstlean.tex}
\lstset{language=lean}

\newcommand{\lean}[1]{\texttt{#1}\xspace} % for writing Lean expressions
\newcommand{\OK}{\mathrm{O}_K}
\DeclareMathOperator{\Tr}{\mathrm{Tr}}
\newcommand{\mathlib}{\texttt{mathlib}\xspace}
\newcommand{\N}{\mathbb{N}}
\newcommand{\pow}{\textasciicircum\xspace}
\newcommand{\Q}{\mathbb{Q}}
\newcommand{\Qbar}{\mathbb{\bar{Q}}}
\newcommand{\Z}{\mathbb{Z}}

\definecolor{keywordcolor}{rgb}{0.7, 0.1, 0.1}   % red
\definecolor{commentcolor}{rgb}{0.4, 0.4, 0.4}   % grey
\definecolor{symbolcolor}{rgb}{0.4, 0.4, 0.4}    % grey
\definecolor{sortcolor}{rgb}{0.1, 0.5, 0.1}      % green

\DeclareUnicodeCharacter{2090}{\ensuremath{_a}}
\DeclareUnicodeCharacter{2097}{\ensuremath{_l}}
\DeclareUnicodeCharacter{211A}{\ensuremath{\Q}}
\DeclareUnicodeCharacter{22A4}{\ensuremath{\top}}

\begin{document}

\maketitle

\begin{abstract}
Dedekind domains and their class groups are essential notions in algebraic number theory.
We formalized these structures and their fundamental properties in the Lean prover as part of the mathlib mathematical library.
This paper describes the formalization process,
especially the idioms we found useful in our development
and mathlib's decentralized collaboration processes involved in this project.
\end{abstract}

\section{Introduction}

Our main achievement: if $K$ is a finite field extension of $\Q$, then the ring of integers $\OK$ is a Dedekind domain with finite class number.

Overview of the work:
\begin{itemize}
 \item Define dedekind domains
 \item show the definitions are equivalent to each other
 \item show a principal ideal domain is a Dedekind domain
 \item show the integral closure of a Dedekind domain in a finite (separable) field extension is a Dedekind domain
 \item define the class group
 \item show the class group is finite
\end{itemize}

\section{Number fields, global fields and rings of integers}

A number field is a finite field extension of $\Q$.
Number fields are a basic concept in algebraic number theory. Examples: ....
We formalized number fields as the following typeclass:
\begin{lstlisting}
class is_number_field (K : Type*) [field K] :=
[cz : char_zero K] [fd : finite_dimensional ℚ K]
\end{lstlisting}
The condition \lean{[cz : char\_zero K]} states that $K$ has characteristic zero, i.e. the canonical ring homomorphism $\N \to K$ is an embedding.
This implies that there is a $\Q$-algebra structure on $K$ (found by typeclass search), this gives the vector space structure used in the \lean{[fd : finite\_dimensional ℚ K]} hypothesis.

\subsection{Field extensions}

The definition of \lean{is\_number\_field} illustrates our treatment of field extensions.
In informal mathematics, a field $L$ containing a subfield $K$ is said to be a field extension $L / K$.
Often we encounter towers of field extensions: we might have that $\Q$ is contained in $K$, $K$ is contained in $L$, $L$ is contained in the algebraic closure $\bar{K}$ of $K$, and $\bar{K}$ is contained in $\C$.
We might formalize this situation by viewing $\Q$, $K$, $L$ and $\bar{K}$ to be sets of complex numbers $\C$ and defining field extensions as subset relations between these subfields.
This way, no coercions need to be inserted to map elements of one field into a larger field.
% I believe this is what mathcomp does; verify?
In type theory we cannot define $\Q$ as a subset of $\C$ since we need $\Q$ to define $\C$.
Thus, some coercion is always needed to go from the original definition of $\Q$ to its image in $\C$; and similar issues arise for other subfields that were not originally defined as such.
Moreover, we lose flexibility since we need to choose the top field at the start and cannot adjoin more elements when needed.

Instead, we parametrize our results over abritrary types $K$ and $L$ and represent the hypothesis ``$L$ is a field extension of $K$'' by taking an instance argument \lean{[algebra K L]}.
This provides us with a canonical ring homomorphism $\lean{algebra\_map K L} : K \to L$; this map is injective because $K$ and $L$ are fields.
In other words, field extensions are given by their canonical embeddings.

\subsection{Scalar towers} \label{sec:scalar_tower}

The main drawback of allowing arbitrary embeddings is that we need to prove that these maps commute.
For example, we might start with a field extension $L / \Q$, then define a subfield $K$ of $L$,
giving a tower of extensions $L / K / \Q$.
In such a tower, the map $\Q \to L$ should be equal to the composition $\Q \to K \to L$,
yet we cannot define this to be the case since the map $\Q \to L$ came earlier.

We formalize a result with hypothesis of the form ``$L / K / F$ is a tower of field extensions''
to be parametrized over all three maps \lean{[algebra F K]}, \lean{[algebra K L]} and \lean{[algebra F L]},
and take an additional parameter \lean{[is\_scalar\_tower F K L]} stating that these maps commute.

\lean{is\_scalar\_tower} works well.
Parameters are automatically inferred by the typeclass system in many cases,
such as when \lean{K : intermediate\_field F L}.

\subsection{Ring of integers}

A number ring is defined as a ring whose fraction field is a number field, the ring of integers $\OK$ is an important example.
The ring of integers in $K$ is defined as all $x : K$ that are the root of a monic polynomials with coefficients in $\Z$:
\begin{lstlisting}
def ring_of_integers (K : Type*) [field K] [is_number_field K] :=
integral_closure ℤ K
\end{lstlisting}

Some examples of ring of integers include $\Z$ and $\Z[\iota]$. We prove ahead that the ring of integers of a number field is, in fact, a Dedekind domain. Moreover, it is a finitely-generated free $\Z$-module, with rank equal to the degree of the number field over $\Q$. 

%Will add more after completing proof

\section{Supporting definitions}

% I put this section in front because my notes later on refer back to definitions in this section. We could also give the informal overview first, then explain how we map this to formal maths.

\subsection{Subobjects}

We defined a subfield of $K$ as a subset of $K$ that contains $0$ and $1$ and is closed under addition, negation, multiplication, and taking inverses.

If $L$ is a field extension of $K$, we define an intermediate field as a subfield that is also a subalgebra: a subfield that contains the image of $\lean{algebra\_map K L}$.

If $K$ is an $R$-algebra and $x : K$, $x$ is integral if it is the root of a monic polynomial over $R$: there is a polynomial $p$ with leading coefficient $1$ and other coefficients in $R$, such that $p(x) = 0$.
The integral closure of $R$ in $K$ is the subalgebra containing all integral elements of $R$.
Elements of $K$ that are integral over the integral closure are also integral over $R$, explaining the word ``closure'' in the name.

\subsection{Fraction fields}

A fraction field $K$ of an integral domain $R$ is the smallest field that contains $R$ (or some other equivalent definitions).
The choice of $K$ is only unique up to isomorphism.
In particular, the generic construction of a fraction field of $\Z$ does not yield $\Q$.
One solution is to build a transfer tactic, the other is to state our theorems parametrized by $K$, along with a proof that $K$ is a fraction field of $R$.

The mathlib definition of fraction fields is based around the localization map. Let $R$ and $K$ be (commutative) rings with submonoid $P \subset R$, then $f : R \to K$ is a localization map if ..., expressed formally as the following structure:

The localization map $f$ endows $K$ with an $R$-algebra structure.

If the submonoid $P$ consists of all non-zero-divisors of $R$, we say that $f$ is a fraction map, and if $R$ is an integral domain, $K$ is a field. We call $K$ the fraction field of $R$.

The choice of $R$-algebra structure on $K$ is not unique, so we use a type synonym \lean{f.codomain}. This instructs the type class system to use the algebra instance derived from the localization map $f$.

In the following sections, let $f : R \to K$ be a fraction map.

\subsection{Fractional ideals}

When working with fraction fields, it is useful to extend the notion of $R$-ideals to fractional ideals: these are $R$-ideals divided by some $x : R$, or equivalently $R$-submodules $I$ of $K$ such that there is an $x : R$ with $x I \subseteq R$. The "$R$" in this statement is the image of $R$ in $K$, so our definition of fractional ideals depends on the fraction map $f$.

We defined the addition, multiplication and intersection operations on fractional ideals,
by showing the corresponding operations on submodules map fractional ideals to fractional ideals.
We also proved that these operations give a commutative semiring structure on the type of fractional ideals.
For example, multiplication of fractional ideals is defined as:
\begin{lstlisting}
lemma fractional_mul (I J : fractional_ideal f) :
  is_fractional f (I.1 * J.1) := _

instance : has_mul (fractional_ideal f) :=
⟨λ I J, ⟨I.1 * J.1, fractional_mul I J⟩⟩
\end{lstlisting}

Defining the quotient of two fractional ideals requires slightly more work.
The submodule quotient $I / J$\footnote{The $:$ operator typically used for the submodule quotient is already reserved by the type theory, so \mathlib uses $/$ instead.} is characterized by the property
\begin{lstlisting}
lemma submodule.mem_div_iff_forall_mul_mem {x : A} {I J : submodule R A} :
  x ∈ I / J ↔ ∀ y ∈ J, x * y ∈ I
\end{lstlisting}
However, if $J$ contains only the element $0$,
then $xy = 0 \in I$ for all $y \in J$, so all $x : A$ are elements of $I / J$.
The submodule consisting of all $x : A$ is not a fractional ideal in general,
so we cannot simply define the quotient of two fractional ideals to be the submodule quotient.
Instead we set $I / 0 = 0$, resulting in the following definition of the fractional ideal quotient:
\begin{lstlisting}
noncomputable instance fractional_ideal.has_div :
  has_div (fractional_ideal g) :=
⟨λ I J, if h : J = 0 then 0 else ⟨I.1 / J.1, fractional_div_of_nonzero h⟩⟩
\end{lstlisting}

In general, if there is a multiplicative inverse $J$ of $I$, such that $I J = J I = 1$, then $J = 1 / I$.
However, the converse does not always hold: $1 / I$ is not always the multiplicative inverse of $I$.
Indeed, the condition that $1 / I$ is an inverse for all $I$ is one of the equivalent definitions of a Dedekind domain.
Therefore, we defined the inverse operator $\cdot^{-1}$ only for fractional ideals in a Dedekind domain:
\begin{lstlisting}
noncomputable instance [is_dedekind_domain R] (g : fraction_map R K) :
  has_inv (fractional_ideal g) :=
⟨λ I, 1 / I⟩
\end{lstlisting}

Defining the inverse in terms of the quotient causes a problem later on, when we tried to define a \lean{group\_with\_zero} instance for fractional ideals in a Dedekind domain.
%TODO: explain group_with_zero? Is it already in another article?
The \lean{group\_with\_zero} typeclass defines its own division operator, $x / y := x y^{-1}$,
resulting in a definitionally unequal second interpretation of $I / J = I * (1 / J)$.
We were able to fix this issue by including the division operator as a field in \lean{group\_with\_zero},
along with a field $\lean{div\_eq\_mul\_inv} : \forall\ a\ b, a / b = a * b^{-1}$.
This weakened the requirement on division from definitional to propositional equality.
As a consequence, many \lean{group\_with\_zero} instances and proofs throughout \mathlib needed slight changes to explicily rewrite $x / y$ to $x * y^{-1}$ instead of using unification to implicitly do so.
% TODO: explain that we did the same for group and add_group, or is that too much detail?

\subsection{Representing simple field extensions}

A number field $K$ is defined as a finite extension of $\Q$, or equivalently a field of the form $\Q(\alpha)$ for some algebraic number $\alpha$.
A field extension $L / K$ is called \emph{simple} if there is an $\alpha$ algebraic over $K$, called the \emph{primitive element}, such that $L = K(\alpha)$.
The primitive element theorem states that a finite, separable extension is simple; the converse holds if the primitive element $\alpha$ is separable.

The exact choice of these $\alpha$ and $K(\alpha)$ are underspecified in the mathematical literature.
We can find $K(\alpha)$ by adjoining the root of a polynomial: there is an irreducible polynomial $p \in K[X]$ such that $K[X] / p \simeq L$; we set $\alpha$ to be the image of $X$ in $K[X] / p$.
We can also take $\alpha : \bar{K}$, the algebraic closure of $K$, set $K(\alpha)$ to be the smallest subfield of $\bar{K}$ that contains $\alpha$ and the image of $K$, and have an equality $L = K(\alpha)$ as subsets of $\bar{K}$.
Similarly, we can take $\alpha : L$ and $K(\alpha)$ to be the smallest subfield of $L$ containing $\alpha$ and the image of $K$; then $L = K(\alpha)$ means that $K(\alpha)$, as a subfield of $L$, contains all elements of $L$.

Because $\alpha$ is algebraic the smallest subring containing $\alpha$ and $\Q$ will be a field, thus we can add two more representations, replacing ``smallest subfield'' with ``smallest subring''.
Moreover, all subfields/subrings containing $K$ are also $K$-algebras, so we can additionally replace ``subfield'' with ``intermediate field'' and ``subring'' with ``$K$-subalgebra''.

The ability to switch between these representations is important: sometimes $K$ and $L$ are fixed and we want an arbitrary $\alpha$; sometimes $\alpha$ is fixed and we want an arbitrary type representing $K(\alpha)$.
In Lean, these different constructions have already been formalized:
$K[X] / p$ is a type called \lean{adjoin\_root p},
$K(\alpha)$ as smallest $K$-subalgebra containing $\alpha$ is called \lean{subalgebra.adjoin $K$ \{$\alpha$\}}
and the smallest intermediate field containing $\alpha$ is \lean{intermediate\-\_field.adjoin $K$ \{$\alpha$\}}.
The primitive element theorem had been formalized as:
\begin{lstlisting}
theorem exists_primitive_element
  [finite_dimensional F E] [is_separable F E] :
  ∃ α : E, intermediate_field.adjoin F α = ⊤
\end{lstlisting}

Note that the choice of $\alpha$ (or the irreducible polynomial $p$) is not unique in general; both $3^\frac{1}{3}$ and $3^\frac{2}{3}$ generate $\Q(\sqrt[3]{3})$.
This means none of the above conditions provides a uniform way of reasoning about simple extensions:
if we use a predicate like ``finite, separable extension'' we cannot guarantee that the primitive element chosen for $K(\alpha)$ is indeed $\alpha$.
If we need to choose an $\alpha$ ahead of time and work in (any definition of) $K(\alpha)$, we need extra work to transfer the result across the isomorphism $K(\alpha) \simeq L$.

We chose instead to use a \emph{power basis} to represent simple field extensions, a basis of the form $1, x, x^2, \dots, x^{n-1} : A$ (viewing $A$ as an $R$-module).
We call $x$ the \emph{generator} and $n$ the \emph{dimension} of this power basis.
In Lean, we defined the following structure, bundling the information of a power basis:
\begin{lstlisting}
structure power_basis (R A : Type*) [comm_ring R] [ring A] [algebra R A] :=
(gen : S) (dim : ℕ)
(is_basis : is_basis R (λ (i : fin dim), gen ^ (i : ℕ)))
\end{lstlisting}

% TODO: or just refer here to the names of the Lean functions?
If $x : A$ is the generator of a power basis over $R$, it is also integral over $R$:
let $n$ be the dimension of the power basis, then $x^n : A$ can be written as $x^n = \sum_i c_i x^i$ for some coefficients $c_i : R$;
thus $p(X) = X^n - \sum_i c_i X^i$ is a polynomial with root $x$.
That $p$ has minimal degree, follows from the linear independence of the powers of $x$ up to $n$.
Conversely, for algebraic (and therefore integral) $\alpha$, $\Q(\alpha)$ has a power basis generated by $\alpha$.
This shows that the condition of having a power basis is equivalent to being a simple field extension.

With the \lean{power\_basis} structure, we have the ability to parametrize our results,
being able to choose the $K$ and $L$ in a simple field extension $L / K$,
or being able to choose the $\alpha$ generating $K(\alpha)$ (packaged up as \lean{power\_basis.gen\ pb}).
Specializing a result from an arbitrary $L$ with a power basis over $K$, to \lean{adjoin K \{$\alpha$\}} specifically, is a matter of applying the result to the power basis generated by $\alpha$, and rewriting $\lean{power\_basis.gen (adjoin.power\_basis K $\alpha$)} = \alpha$.


\section{Defining Dedekind Domains}

Initially we used 3 different structures to represent Dedekind domains: \lean{is\_dedekind\_domain}, \lean{is\_dedekind\_domain\_iff} and \lean{is\_dedekind\_domain\_dvr}, defined as follows:
...

These different structures allowed us to do our work in parallel. This meshed well with the approach in mathlib of favouring short, complete, individual contributions over including projects. (This is also how the Linux kernel gets developed!)

In parallel we could then work on providing instances of the \lean{is\_dedekind\_domain} typeclass, proving the equivalences between the structures, and using the Dedekind domain definition as a hypothesis.

Discuss the \lean{not\_is\_field} assumption.

\section{Equivalence of the definitions}

In this section, we describe how we proved that the 3 definitions of Dedekind domain are equivalent.

We use the proof given in Cassels and Frohlich's Algebraic Number Theory (Chapter 1, Section 2, Proposition 1) to show that \lean{is\_dedekind\_domain\_inv} implies \lean{is\_dedekind\_domain}. A constant challenge that was faced while coding this proof is that one must work with pushforwards and pull backs of elements that belong to the ring, and hence to its localisation. The proofs for integrally closed and dimension being less than or equal to one are fairly straightforward.

Proving the Noetherian condition was the most challenging.
In the original proof by Cassels and Frohlich, they consider elements $a_1, \dots, a_n \in I$ and $b_1, \dots, b_n \in I^{-1}$ for any nonempty fractional ideal $I$,
such that $ \sum_i a_i b_i = 1 $.
However, it is quite challenging to prove that an element of the multiplication of two $R$-submodules $M$ and $N$ must be of the form $\sum_{i = 1}^m a_i*b_i$, for $a_i \in A$ and $b_i \in B$ for all $1 \leq i \leq m$.
Instead, we show that, for every element of an ideal, there exists a \lean{finset} whose span is contained in the ideal, and which contains the element.
This is accomplished by the lemma \lean{submodule.mem\_span\_mul\_finite\_of\_mem\_span\_mul}.
Now considering an ideal $s$ of the ring $A$, due to its invertibility, by \lean{submodule.mem\_span\_mul\_finite\_of\_mem\_span\_mul}, we obtain \lean{finset A} $T \subset s$ and $T' \subset 1/s$, such that 1 is contained in the span of $T*T'$.
This is then sufficient to show that $s$ is finitely generated, as shown in the lemma \lean{fg\_of\_one\_mem\_span\_mul}.

\section{Principal ideal domains are Dedekind}

This is not a long proof, so it can be a good demonstration of our definitions.

\section{Ring of integers are Dedekind domains}

An important class of Dedekind domains consists of the rings of integers of number fields.
We defined the ring of integers of a number field $K$ as the integral closure $\Z$ in $K$.
We proved a stronger result: let $R$ be a Dedekind domain with fraction field $K$, if $L$ is a finite separable extension of $K$, then the integral closure of $R$ in $L$ is a Dedekind domain with fraction field $L$.
Our approach is based on Neukirch, theorem 3.1, with adaptations to match the available results in \mathlib. % TODO: cite
Throughout this section, $R$ will be an integral domain with fraction field $K$ (given by the map $f : R \to K$), $L$ a field extension of $K$ and $S$ the integral closure of $R$ in $L$,
corresponding to the following Lean declarations:
\begin{lstlisting}
variables {R K L : Type*} [integral_domain R] [field K] [field L]
variables (f : fraction_map R K)
variables [algebra f.codomain L] [algebra R L] [is_scalar_tower R L]
notation `S` := integral_closure R L
\end{lstlisting}

The first step is showing $L$ is indeed the fraction field of the integral closure,
i.e. that there is a \lean{fraction\_map (integral\_closure R L) L}.
We formalized the following two results, where the first implies the second:
\begin{lstlisting}
def fraction_map_of_algebraic (alg : is_algebraic R L)
  (inj : function.injective (algebra_map R L)) :
  fraction_map S L

def fraction_map_of_finite_extension [finite_dimensional f.codomain L] :
  fraction_map S L
\end{lstlisting}
The main contents of \lean{fraction\_map\_of\_algebraic} consist of showing that all elements $x : L$ can be written as $y / z$ for integral elements $y, z$;
the standard proof of this fact formalizes readily. % TODO: a nice proof to refer to: Neukirch?
%Since $x$ is algebraic over $A$, it satisfies an equation $a_n x^n + a_{n-1} x^{n-1} + \cdots + a_0 = 0$, with $a_n, \dots, a_0 : A$.
%Multiplying each term by $a_n^{n-1}$, we see $(a_n x)^{n} + a_{n-1} (a_n x)^{n - 1} + \cdots + a_0 a_n^{n-1} = 0$,
%therefore $a_n x$ is integral, and we can write $x = (a_n x) / a_n$.

Now we are ready to show the integral closure of $R$ in $L$ is a Dedekind domain,
by proving it is integrally closed in $L$, has Krull dimension at most one and is Noetherian.
The fact that the integral closure is integrally closed is immediate.

To show the Krull dimension is at most one, we needed to develop basic going-up theory for ideals.
In particular, we show that an ideal $I$ in an integral extension is maximal if it lies over a maximal ideal,
and use a result already available in \mathlib that a prime ideal $I$ in an integral extension lies over a prime ideal.
\begin{lstlisting}
lemma is_maximal_of_is_integral_of_is_maximal_comap
  {S : Type*} [integral_domain S] [algebra R S]
  (hRS : algebra.is_integral R S) (I : ideal S) [I.is_prime]
  (hI : is_maximal (I.comap (algebra_map R S))) : is_maximal I

theorem is_prime.comap [hK : K.is_prime] : (comap f K).is_prime
\end{lstlisting}

\subsection{Integral closure is Noetherian}
The final condition, that the integral closure of $R$ in $L$ is a Noetherian ring, requires the most work.
It suffices to show that the integral closure is contained in a finitely generated $R$-module $M$,
since the well-founded order on $R$-submodules of $M$ restricts to a well-founded order on ideals of $S$.
\cite{Dummit-and-Foote}, theorem 15.29, proves that the integral closure of $\Z$ in $L$ is a finitely generated free $\Z$-module,
by first showing it is contained in a finitely generated $\Z$-module, and deriving the conclusion from this result.
If we weaken the assumptions, taking the integral closure of an arbitrary Dedekind domain $R$,
the first part of the proof still goes through.

Our formal proof that $S$ is a Noetherian ring adapts this first half of Dummit and Foote's proof.
Suppose we have a family of basis elements $b : \iota \to L$, such that each $b_i$ is integral,
and let $B$ be a nondegenerate bilinear form such that all integral $x, y : L$ satisfy $B(x, y) \in \lean{integral\_closure}\ R\ L$.
If $L$ is separable over $K$ and $R$ is integrally closed in $K$,
then there is a ``dual basis'' $b'$ also indexed by $\iota$, such that the integral closure is contained within the $R$-span of $b'$.
In particular, the $i$'th coordinate of $x : L$ according to the dual basis $b'$ satisfies $x_i = B(b_i, x)$,
therefore $x_i \in R$ if $x \in S$.
This gives the following result:
\begin{lstlisting}
lemma integral_closure_le_span
  [is_separable (localization_map.codomain f) L]
  {ι : Type*} [fintype ι] {b : ι → L} (hb : is_basis f.codomain b)
  (hb_int : ∀ i, is_integral R (b i))
  (int_cl : integral_closure R f.codomain = ⊥) :
  (S : submodule R L) ≤ submodule.span R (set.range (dual_basis hb))
\end{lstlisting}

Since $L$ is a finite extension of $K$, it has a finite basis $b : \iota \to L$ (as a vector space over $K$).
Each $b_i$ is algebraic, so there is a (nonzero) $c_i$ such that $c_i b_i$ is integral over $R$.
Thus, we can multiply $b$ by the product of all $c_i$ to give a basis of $L$ over $K$ consisting of integral elements.
That this is indeed a basis follows from the fact that each $c_i$ is invertible as element of $L$,
thus multiplying by each in turn is a linear automorphism $\lean{lsmul\_equiv}\ c_i : L \to L$.

The remaning ingredient is to find a bilinear form $B$ that is nondegenerate and maps pairs of integral elements to integral elements. In the next subsection, we will discuss how we proved the \emph{trace form} satisfies these criteria.

\subsection{Trace form}
Our formalization of the trace form is based on \cite{Neukirch}, 2.5--2.8.
In an $R$-algebra $S$ that is free and finitely generated as an $R$-module,
the map $\lean{lmul} = \lambda x y : S, xy$ is $R$-linear map in both $x$ and $y$, so it can be represented by a matrix $M_x$.
The \emph{algebra trace} of $x : S$ over $R$, denoted $\Tr_{S : R} x$ is the trace of $\lean{lmul}\ x$, i.e. the sum of the diagonal entries of $M_x$\footnote{Although the entries of $M_x$ depend on the choice of basis, the sum does not.}.
We defined the trace as an $R$-linear map from $S$ to $R$ as the composition of $\lean{lmul}$ and the trace operator for linear maps:
\begin{lstlisting}
noncomputable def trace : S →ₗ[R] R :=
(linear_map.trace R S).comp (lmul R S).to_linear_map
\end{lstlisting}
This definition is marked noncomputable since \lean{linear\_map.trace} makes a case distinction on the existence of a basis,
using an arbitrary basis if one exists and returning $0$ otherwise.
This latter case does not occur in our development.

The \emph{trace form} is a $R$-bilinear form on $S$, mapping $x, y : S$ to $\Tr(xy)$.
\begin{lstlisting}
noncomputable def trace_form : bilin_form R S :=
{ bilin := λ x y, trace R S (x * y), .. }
\end{lstlisting}

Although the trace form can be defined for any algebra,
for simplicity of exposition we will only consider finite field extensions in this paper.
In the formalization, we weakened assumptions to commutative rings or integral domains whenever this was practical.
In the following, let $K : L : F$ be a tower of finite field extensions,
i.e. we have the following declarations:
\begin{lstlisting}
variables {K L F : Type*} [field K] [field L] [field F]
variables [algebra K L] [algebra L F] [algebra K F] [is_scalar_tower K L F]
\end{lstlisting}
Note the use of \lean{is\_scalar\_tower K L F} to indicate that the extensions fit in a tower, as described in Section \ref{sec:scalar_tower}.

The value of the trace depends on the choice of $K$ and $L$: if $x : L$ and $L$ is a subfield of $F$,
then the trace of $(x : F)$ is an integer multiple of the trace of $(x : L)$.
This is a consequence of the following two results, formalizing \cite{Neukirch}, corollary 2.7:
\begin{lstlisting}
lemma trace_algebra_map (x : K) :
  trace K L (algebra_map K L x) = findim K L • x

lemma trace_comp (x : F) :
  trace K F x = trace K L (trace L F x)
\end{lstlisting}
Since a basis $b : \iota \to L$ for $K : L$ and a basis $c : \kappa \to F$ for $L : F$ induce a basis $b \cdot c : \iota \times \kappa \to F$ for $K : F$,
these results follow by direct computation of the multiplication matrices $M_x$.

To compute $\Tr_{K : L}(x)$ it therefore suffices to consider the trace of $x$ in the smallest field containing $x$ and $K$, which is $K(x)$.
It turns out that the trace of $x$ in $K(x)$ is the sum of all conjugate roots to $x$,
i.e. if the field extension $F$ contains all roots of the minimal polynomial of $x$, then the sum of its roots is exactly (the image of) $\Tr_{K : K(x)}(x)$.
We formalize this using the power basis, as follows:
\begin{lstlisting}
lemma power_basis.trace_gen_eq_sum_roots (pb : power_basis K L)
  (h : polynomial.splits (algebra_map K F) pb.minpoly_gen) :
  algebra_map K F (trace K L pb.gen) =
    (pb.minpoly_gen.map (algebra_map K F)).roots.sum
\end{lstlisting}
Applying this result to a specific $x$ is then a question of applying it to the power basis for $K(x)$ generated by $x$, to give:
\begin{lstlisting}
lemma trace_eq_sum_roots [finite_dimensional K L]
  {x : L} (hx : is_integral K x)
  (hF : (minimal_polynomial hx).splits (algebra_map K F)) :
  algebra_map K F (algebra.trace K L x) =
  (findim K(x) L) • ((minimal_polynomial hx).map (algebra_map K F)).roots.sum
\end{lstlisting}
We formulate the lemma in terms of the power basis, since we will also use it for a finite simple extension $L : K$ later in the proof.

Each conjugate element of $x$ is integral since they are roots of (the same) monic polynomial,
and integer multiples and sums of integral elements are integral.
Since \lean{trace\_eq\_sum\_roots} shows that the trace of $x$ is an integer (\lean{findim K(x) L}) multiple of a sum of conjugate roots,
we conclude that the trace (and trace form) of an integral element is also integral.
% It would be marginally easier if `is_integral' was just an auxiliary definition for the subalgebra
% `integral_closure', since subalgebras are closed under sums and smul "for free".

To show the trace form is nondegenerate, we adapted \cite{Neukirch}, Proposition 2.8 as follows:
Suppose $L : K$ is a separable field extension of finite degree $n$,
thus it has a primitive element $x$ generating a power basis \lean{pb} of dimension $n$.
Let $F$ be the algebraic closure of $K$. Since $L$ is a finite extension, hence algebraic over $K$, we find a tower of field extensions $F : L : K$.
Let $A$ be the matrix corresponding to \lean{trace\_form K L}, written out with respect to the basis \lean{pb}.
Computing the entries of this matrix, we see $A_{ij} = \Tr_{L : K} (x^{i + j})$.
We want to show that $\det A \ne 0$.

Let $x_0, \dots, x_{n - 1} : F$ enumerate the roots of the minimal polynomial of $x$,
since $L : K$ is separable and of degree $n$, there are indeed exactly $n$ distinct roots in $F$.
Consider the $n$-by-$n$ matrix $B$ such that $B_{ij} = x_i^j$.
This is a Vandermonde matrix, which has determinant $\prod_{i < j} (x_i - x_j)^2$.
In particular, since $L : K$ is separable, the conjugates are distinct, meaning each factor $x_i - x_j$ is nonzero,
so $\det B = \prod_{i < j} (x_i - x_j)^2 \ne 0$.
Therefore, $\det (B^T B) = (\det B)^2 \ne 0$.
We claim that $B^T B$ is equal to $A$('s image in $F$), whhich implies our desired result.

The $(i, j)$'th entry of $B^T B$ is equal to $\sum_k x_k^{i + j}$,
and we want to show this is equal to \lean{algebra\_map K F (trace (x \pow (i + j)))}.
Directly applying \lean{trace\_eq\_sum\_roots} is tempting, since we have a sum over conjugates of powers on both sides.
However, the two expressions will not precisely match: $B^T B$ contains a sum over conjugates of $x$, with each conjugate raised to the power $i + j$,
while the conclusion of \lean{trace\_eq\_sum\_roots} results in a sum over conjugates of $x^{i + j}$.

Instead of directly proving that the conjugates of $x^{i + j}$ (counted with the correct multiplicities) correspond to $i + j$'th powers of the conjugates of $x$,
we need to use an equivalent definition of conjugate:
the conjugates of $x$ in $F$ are the (distinct) images of $x$ under each embedding $K(x) \to F$ that fixes $K$.
The equivalence between these two notions of conjugates was developed in Berkeley at the same time as our project, and mapping the equivalence through a sum shows: % TODO: awkward, rephrase
\begin{lstlisting}
lemma power_basis.sum_embeddings_gen
  [is_alg_closed F] [is_separable K L] (f : F → R) :
  ∑ σ in (@finset.univ _ (@alg_hom.fintype_of_separable _ _ _ _ _ _ _ _ _
      pb.finite_dimensional)),
    f (σ pb.gen) =
  ((pb.minpoly_gen.map (algebra_map K F)).roots.map f).sum
\end{lstlisting}
Combining this result with \lean{trace\_gen\_eq\_sum\_roots} gives:
\begin{lstlisting}
lemma power_basis.trace_gen_eq_sum_embeddings [is_separable K L]
  (h : pb.minpoly_gen.splits (algebra_map K F)) :
  algebra_map K F (trace K L pb.gen) =
    ∑ σ in (@finset.univ _
        (@alg_hom.fintype_of_separable _ _ _ _ _ F _ _ _
          pb.finite_dimensional)),
      σ pb.gen
\end{lstlisting}
Taking the power basis of $K(y)$ generated by $y$, we generalize the above to all $y : L$.
\begin{lstlisting}
lemma trace_eq_sum_embeddings
  [is_alg_closed F] [finite_dimensional K L] [is_separable K L]
  {x : L} (hx : is_integral K x) :
  algebra_map K F (algebra.trace K L x) = ∑ σ : L →ₐ[K] F, σ x
\end{lstlisting}
The advantage of using these embeddings is that $\sigma\ x^{i + j} = (\sigma\ x)^{i + j}$,
so we can directly go from the conjugates of $x^{i + j}$ to the $i + j$'th powers of conjugates of $x$.

\section{Class number}

The class group is the quotient \lean{units (fractional\_ideal f)} modulo the principal fractional ideals, or equivalently the ideals of $R$ (except $0$) modulo the elements of $R$ (except $0$).

We are interested in the class group because ...

An important property of the ring of integers in a number field is that the class group is finite. The number of elements of the class group is called the class number.

We prove that the class group is finite using a simplified form of the traditional proof, ...

\end{document}
