\documentclass[a4paper,USenglish,cleveref, autoref, thm-restate]{lipics-v2021}

\bibliographystyle{plainurl}

\title{A formalization of Dedekind domains and class groups of global fields}
\titlerunning{Dedekind domains and class groups}

\author{Anne Baanen}{Department of Computer Science, Vrije Universiteit Amsterdam, The Netherlands \and \url{https://cs.vu.nl/~tbn305}}{t.baanen@vu.nl}{https://orcid.org/0000-0001-8497-3683}
{NWO Vidi grant No.\ 016.Vidi.189.037, Lean Forward}
\author{Sander R. Dahmen}{Department of Mathematics, Vrije Universiteit Amsterdam, The Netherlands \and \url{https://few.vu.nl/~sdn249/}}{s.r.dahmen@vu.nl}{https://orcid.org/0000-0002-0014-0789}{NWO Vidi grant No.\ 639.032.613, New Diophantine Directions}
\author{Ashvni Narayanan}{London School of Geometry and Number Theory}{a.narayanan20@imperial.ac.uk}{https://orcid.org/0000-0003-2777-4228}{EPSRC Grant EP/S021590/1 (UK)}
\author{Filippo A. E. Nuccio Mortarino Majno di Capriglio}{Univ Lyon, Université Jean Monnet Saint-Étienne, CNRS UMR 5208, Institut Camille Jordan, F-42023 Saint-\'Etienne, France\and\url {https://perso.univ-st-etienne.fr/nf51454h/index.html}}{filippo.nuccio@univ-st-etienne.fr}{https://orcid.org/0000-0002-5318-9869}{\empty}

\authorrunning{T. Baanen, S. R. Dahmen, A. Narayanan, and F. A. E. Nuccio}

\Copyright{Anne Baanen, Sander R. Dahmen, Ashvni Narayanan, and Filippo A. E. Nuccio Mortarino Majno di Capriglio}

\ccsdesc[500]{Mathematics of computing~Mathematical software}
\ccsdesc[500]{Security and privacy~Logic and verification}

\keywords{formal math, algebraic number theory, commutative algebra, Lean, mathlib}

\supplement{Full source code of the formalization is part of \mathlib. Copies of the source files relevant to this paper are available in a separate repository.}
\supplementdetails[swhid={swh:1:dir:3e46fd736dbb76b6e7be7f31ebc973f1a1c0237d}]
{Software}{https://github.com/lean-forward/class-number}

\acknowledgements{
We would like to thank Jasmin Blanchette and the anonymous reviewers for useful comments on previous versions of the manuscript, which found their way into this paper.\\
A.~N.~would like to thank Prof.\ Kevin Buzzard for his constant support and encouragement, and for introducing her to the other co-authors.\\
A.~N.~and F.~N.~wish to express their deepest gratitude to Anne Baanen for the generosity shown along all stages of the project. Without Anne's never-ending patience, it would have been impossible for them to contribute to this project, and to overcome several difficulties.\\
Finally, we would like to thank the whole \mathlib community for invaluable advice all along the project.
}

\nolinenumbers %uncomment to disable line numbering

%\hideLIPIcs  %uncomment to remove references to LIPIcs series (logo, DOI, ...), e.g. when preparing a pre-final version to be uploaded to arXiv or another public repository

%Editor-only macros:: begin (do not touch as author)%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\EventEditors{Liron Cohen and Cezary Kaliszyk}
\EventNoEds{2}
\EventLongTitle{12th International Conference on Interactive Theorem Proving (ITP 2021)}
\EventShortTitle{ITP 2021}
\EventAcronym{ITP}
\EventYear{2021}
\EventDate{June 29--July 1, 2021}
\EventLocation{Rome, Italy (Virtual Conference)}
\EventLogo{}
\SeriesVolume{193}
\ArticleNo{12}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage{xspace}
\usepackage{soul}
\usepackage{listings}
\def\lstlanguagefiles{lstlean.tex}
\lstset{language=lean,backgroundcolor=\color[rgb]{0.9,0.9,0.9}}

\newcommand{\C}{\mathbb{C}}
\newcommand{\lean}[1]{\texttt{#1}\xspace}
\newcommand*{\OK}[1][K]{\mathcal{O}_{#1}}
\newcommand*{\Cl}{\mathcal{C}\kern-.075em l}
\newcommand*{\Fq}[1][q]{\mathbb{F}_{#1}}
\DeclareMathOperator{\Tr}{Tr}
\newcommand{\mathlib}{\textsf{mathlib}\xspace}
\newcommand{\N}{\mathbb{N}}
\newcommand{\R}{\mathbb{R}}
\newcommand{\pow}{\textasciicircum\xspace}
\newcommand{\Q}{\mathbb{Q}}
\newcommand{\Z}{\mathbb{Z}}
\DeclareMathOperator{\Frac}{Frac}

\definecolor{keywordcolor}{rgb}{0.7, 0.1, 0.1}   % red
\definecolor{commentcolor}{rgb}{0.4, 0.4, 0.4}   % grey
\definecolor{symbolcolor}{rgb}{0.4, 0.4, 0.4}    % grey
\definecolor{sortcolor}{rgb}{0.1, 0.5, 0.1}      % green

\DeclareUnicodeCharacter{03B1}{\ensuremath{\alpha}}
\DeclareUnicodeCharacter{03C3}{\ensuremath{\sigma}}
\DeclareUnicodeCharacter{2081}{\ensuremath{_1}}
\DeclareUnicodeCharacter{2090}{\ensuremath{_a}}
\DeclareUnicodeCharacter{2097}{\ensuremath{_l}}
\DeclareUnicodeCharacter{211A}{\ensuremath{\Q}}
\DeclareUnicodeCharacter{2124}{\ensuremath{\Z}}
\DeclareUnicodeCharacter{2211}{\ensuremath{\sum}}
\DeclareUnicodeCharacter{2264}{\ensuremath{\l}}
\DeclareUnicodeCharacter{2286}{\ensuremath{\subseteq}}
\DeclareUnicodeCharacter{22A4}{\ensuremath{\top}}
\DeclareUnicodeCharacter{22A5}{\ensuremath{\bot}}

\begin{document}

\maketitle

\begin{abstract}
Dedekind domains and their class groups are notions in commutative algebra that are essential in algebraic number theory.
We formalized these structures and several fundamental properties, including number theoretic finiteness results for class groups, in the Lean prover as part of the \mathlib mathematical library.
This paper describes the formalization process, noting the idioms we found useful in our development and \mathlib's decentralized collaboration processes involved in this project.
\end{abstract}

\section{Introduction}

In its basic form, number theory studies properties of the integers $\Z$
and its fraction field, the rational numbers $\Q$.
Both for the sake of generalization, as well as for providing powerful techniques to answer questions about the original objects $\Z$ and $\Q$,
it is worthwhile to study finite extensions of $\Q$, called \emph{number fields}, as well as their \emph{rings of integers} (Section~\ref{sec math background}),
whose relations mirror the way $\Q$ contains $\Z$ as a subring.
In this paper, we describe our project aiming at formalizing these notions and some of their important properties. Our goal, however, is not to get to the definitions and properties as quickly as possible,
but rather
to lay the foundations for future work,
as part of a natural and more general theory as we shall explain below.

In particular, our project resulted in formalized definitions and elementary properties of
number fields and their rings of integers (Section~\ref{sec:ring-of-integers}),
Dedekind domains (Section~\ref{sec:Dedekind-domain}),
and the ideal class group and class number (Section~\ref{sec:class-number}).
Apart form the very basics concerning number fields, these concepts were not formalized before as far as we are aware of.
We note that our formal definition of the class number is an essential requirement for the use of theorem provers in modern number theory research.
The main proofs that we formalized show
that two definitions of Dedekind domains are equivalent (Section \ref{sec:equivalence}),
that the ring of integers
is a Dedekind domain (Section \ref{sec:integral-closure})
and that the class group of a number field is finite (Section \ref{sec:class-number}).
In fact, most of our results for number fields are also obtained in the more general setting of \emph{global fields}.

Our work is developed as part of the mathematical library \mathlib~\cite{mathlib} for the Lean 3 theorem prover~\cite{lean-prover}.
The formal system of Lean is a dependent type theory based on the calculus of inductive constructions,
with a proof-irrelevant impredicative universe \lean{Prop} at the bottom of a noncumulative hierarchy of universes \lean{Prop $:$ Type $:$ Type 1 $:$ \mbox{Type 2} $:$ \dots}\,; ``an arbitrary \lean{Type u}'' is abbreviated as \lean{Type*}.
Other important characteristics of Lean as used in \mathlib are the use of quotient types, ubiquitous classical reasoning and the use of typeclasses to define the hierarchy of algebraic structures.

Organizationally, \mathlib is characterized by a distributed and decentralized community of contributors, a willingness to refactor its basic definitions, and a preference for small yet complete contributions over larger projects added all at once.
In this project, as part of the development of \mathlib, we followed this philosophy by contributing pieces of our work as they were finished.
We, in turn, used results contributed by others after the start of the project.
At several points, we had just merged a formalization into \mathlib that another contributor needed,
immediately before they contributed a result that we needed.
Due to the decentralized organization and fluid nature of contributions to \mathlib, its contents are built up of many different contributions from over 100 different authors.
Attributing each formalization to a single set of main authors would not do justice to all others whose additions and tweaks are essential to its current use. Therefore, we will make clear whether a contribution is part of our project or not, but we will not stress whom we consider to be the main authors.

The source files of the formalization are currently in the process of being merged into \mathlib.
The up-to-date development branch is publically available.\footnote{\url{https://github.com/leanprover-community/mathlib/tree/dedekind-domain-dev}}
We also maintain a
repository%
\footnote{\url{https://github.com/lean-forward/class-number}}
containing the source code referred to in this paper.

\section{Mathematical background}\label{sec math background}

Let us now introduce some of the main objects we study, described informally. We assume some familiarity with basic ring and field theory.

A \emph{number field} $K$ is a finite extension of the field $\Q$, and as such has the structure of a finite dimensional vector space over $\Q$; its dimension is called the \emph{degree} of $K$.
The easiest example is $\Q$ itself, and the two-dimensional cases are given by the quadratic number fields
$\Q(\sqrt{d})=\{a+b\sqrt{d} : a,b \in \Q\}$
where $d \in \Z$ is not a square.
For an interesting cubic example, let $\alpha_0$ be the unique real number satisfying $\alpha_0^3 + \alpha_0^2 - 2\alpha_0 + 8=0$.
It gives rise to the number field
$\Q(\alpha_0)=\{a+b\alpha_0+c \alpha_0^2: a,b,c \in \Q\}$.
In general, taking any root $\alpha$ of an irreducible polynomial of degree $n$ over $\Q$ yields a number field of degree $n$:
$\Q(\alpha)=\{c_0+c_1\alpha+\ldots+c_{n-1} \alpha^{n-1} : c_0,c_1,\ldots,c_{n-1} \in \Q \}$,
and, up to isomorphism, these are all the number fields of degree $n$.

The \emph{ring of integers} $\OK$ of a number field $K$ is defined as the integral closure of $\Z$ in $K$, namely
\[
  \OK := \big\{x \in K : f(x)=0 \text{ for some \emph{monic} polynomial } f \text{ with integer coefficients}\big\},\]
where we recall that a polynomial is called \emph{monic} if its leading coefficient equals $1$.
While it might not be immediately obvious that $\OK$ is a ring, this follows from general algebraic properties of integral closures.
Some examples of $\OK$ are the following. Taking $K=\Q$, we get $\OK=\Z$ back.
For $K=\Q(i)=\Q(\sqrt{-1})$ we get that $\OK$ is the ring of Gaussian integers $\Z[i]=\{a+bi : a,b \in \Z\}$.
But for $K=\Q(\sqrt{5})$ we do \emph{not} simply get $\Z[\sqrt{5}]=\{a+b\sqrt{5} : a,b \in \Z\}$ as $\OK$, since the golden ratio $\varphi:=(1+\sqrt{5})/2\not\in \Z[\sqrt{5}]$ satisfies the monic polynomial equation $\varphi^2-\varphi-1=0$; hence by definition, $\varphi \in \OK$.
It turns out that $\OK=\Z[\varphi]=\{a+b\varphi : a,b \in \Z\}$.
Finally, if $K=\Q(\alpha_0)$ with $\alpha_0$ as before, then $\OK=\{a+b \alpha_0+c (\alpha_0+\alpha_0^2)/2 : a,b,c \in \Z\}$, illustrating that explicitly writing down $\OK$ can quickly become complicated.
Further well-known rings of integers are
the Eisenstein integers $\Z[(1+\sqrt{-3})/2]$ and the ring $\Z[\sqrt{2}]$.

Thinking of $\OK$ as a generalization of $\Z$, it is natural to ask which of its properties
still hold in $\OK$ and, when this fails, if a reasonable weakening does.

An important property of $\Z$ is that it is a principal ideal domain (PID), meaning that every ideal is generated by one element. This implies that every nonzero nonunit element can be written as a
finite product of prime elements, which is unique up to reordering and multiplying by $\pm 1$: a ring where this holds is called a unique factorization domain, or UFD.
For example, $6$ can be factored in primes in $4$ equivalent ways, namely $6=2\cdot 3=3\cdot2=(-2)\cdot (-3)=(-3) \cdot (-2)$.
In fact, the previously mentioned examples of rings of integers are UFDs, but this is certainly not true for all rings of integers. For example, unique factorization \emph{does not} hold in $\Z[\sqrt{-5}]$
: it is easy to prove that $6=2\cdot3$ and $6=(1+\sqrt{-5}) (1-\sqrt{-5})$ provide two essentially different ways to factor $6$ into prime elements of $\Z[\sqrt{-5}]$.

As it turns out, there is a way to remedy this. Namely, by considering factorization of \emph{ideals} instead of elements: given a number field $K$, with ring of integers $\OK$, a beautiful and classical result by Dedekind shows that every nonzero ideal of $\OK$ can be factored as a product of prime ideals in a unique way, up to reordering.

Although unique factorization in terms of ideals is of great importance, it is still interesting, and sometimes
necessary, to also consider factorization properties in terms of elements.
We mentioned that unique factorization in $\Z$ follows from the fact that every ideal is generated by a single element.
Now, it is convenient to extend the notion of ideals of $\Z$ to that of $\emph{fractional ideals}$. 
These are additive subgroups of $\Q$ of the form $\frac{1}{d} I$ with $I$ an ideal of $\Z$ and $d$ a nonzero integer.
When the distinction is important, we refer to an ideal $I \subseteq \Z$ as an \emph{integral ideal}.
The nonzero fractional ideals of $\Z$ naturally form a multiplicative group (whereas there is no integral ideal $I\subseteq \Z$ such that $I*(2\Z)=(1)$).
The statement that every ideal is generated by a single element
translates to the fact that the quotient group of nonzero fractional ideals modulo $\Q^\times$ is trivial (where $\frac{a}{b} \in \Q^\times$ corresponds to $\frac{1}{b} a \Z$, and as usual, the multiplicative group of invertible elements of a ring $R$ is denoted by $R^{\times}$).

It turns out that this quotient group can be defined for every ring of integers $\OK$.
The fundamental theoretical notion beneath this construction is that of Dedekind domain: these are integral domains $D$ which are Noetherian (every ideal of $D$ is finitely generated), integrally closed (if an element $x$ in $\Frac D$ (the fraction field of $D$) is a root of a monic polynomial with coefficients in $D$, then actually $x \in D$), and of Krull dimension at most $1$ (every nonzero prime ideal of $D$ is maximal).
It can be proved that the nonzero fractional ideals of $D$
again form a group, and the quotient of this group by the image of the natural embedding of $(\Frac D)^\times$ is called the \emph{\textup{(}ideal\textup{)} class group} $\Cl_{D}$.

What is arithmetically crucial is the theorem ensuring that the ring of integers $\OK$ of every number field $K$ is a Dedekind domain,
and that in this case the class group $\Cl_{\OK}$ is actually \emph{finite}.
In particular, $\Cl_{\OK}$ can be seen as ``measuring'' how far ideals of $\OK$ are from being generated by a single element and,
consequently, as a measure of the failure of unique factorization.
The order of $\Cl_{\OK}$ is called \emph{the class number} of $K$.
Intuitively, then, the smaller the class number, the fewer factorizations are possible.
In particular, the class number of $K$ is equal to $1$ if and only if $\OK$ is a UFD.

The statements in the previous paragraph also hold for \emph{function fields}, namely fields which are finite extensions of $\Fq(t) \simeq \Frac \Fq[q][t]$, where $\Fq[q][t]$ stands for the ring of univariate polynomials (in a free variable $t$) with coefficients in a finite field with $q$ elements $\Fq$. Recall that when $q$ is a prime number, $\Fq$ is simply the field $\Z/q\Z$.
A field which is either a number field or a function field is called a \emph{global field}.

In the next sections we will describe the formalization of the above concepts.

\section{Number fields, global fields and rings of integers} \label{sec:number fields}

We refer the reader to Section~\ref{sec math background} for the mathematical background needed in this section.

We formalized number fields as the following typeclass:
\begin{lstlisting}
class is_number_field (K : Type*) [field K] : Prop :=
[cz : char_zero K] [fd : finite_dimensional ℚ K]
\end{lstlisting}
The \emph{class} keyword declares a structure type (in other words, a type of records) and enables typeclass inference for terms of this type.
Round brackets mark parameters explicitly supplied by the user, such as \lean{(K : Type*)},
square brackets mark instance parameters inferred by the typeclass system, such as \lean{[field K]}. The condition \lean{[cz : char\_zero K]} states that $K$ has characteristic zero, so the canonical ring homomorphism $\Z \to K$ is an embedding.
This implies that there is a $\Q$-algebra structure on $K$ (found by typeclass instance search), endowing $K$ with the $\Q$-vector space structure used in the \mbox{\lean{[fd : finite\_dimensional ℚ K]}} hypothesis.

Typeclasses were originally introduced in Haskell as a mechanism for operator overloading~\cite{typeclasses-haskell},
and are used throughout Lean's core library and \mathlib to endow types with mathematical structures consisting of both operators and their properties~\cite{mathlib}.
The typeclass system will automatically infer values for instance parameters,
by searching for values of the appropriate type among the local parameters or declarations marked as an \emph{instance}~\cite[\S 10]{theorem-proving-in-lean}.

We defined the function field $K$ over a finite field $\Fq$ using the following typeclass:
\begin{lstlisting}
class is_function_field_over {$\Fq$ F : Type*} [field $\Fq$] [fintype $\Fq$]
  [field F] (f : fraction_map (polynomial $\Fq$) F) (K : Type*) [field K]
  [algebra f.codomain K] : Prop :=
[fd : finite_dimensional f.codomain K]
\end{lstlisting}
Curly brackets mark implicit parameters inferred through unification, such as \lean{\{$\Fq$ F : Type*\}}.
The map \lean{f} witnesses that $F$ is a fraction field of the polynomial ring $\Fq[q][t]$,
the notation \lean{f.codomain} endows $F$ with the $\Fq[q][t]$-algebra structure of $\Fq(t)$. We present a more detailed analysis of \lean{fraction\_map} in Section \ref{subsection : fields of fractions}.

\subsection{Field extensions}

The definition of \lean{is\_number\_field} illustrates our treatment of field extensions.
A field $L$ containing a subfield $K$ is said to be a field extension $L / K$.
Often we encounter towers of field extensions: we might have that $\Q$ is contained in $K$, $K$ is contained in $L$, $L$ is contained in an algebraic closure $\overline{K}$ of $K$, and $\overline{K}$ is contained in $\C$.
We might formalize this situation by viewing $\Q$, $K$, $L$ and $\overline{K}$ as sets of complex numbers $\C$ and defining field extensions as subset relations between these subfields.
This way, no coercions need to be inserted in order to map elements of one field into a larger field.
Unfortunately, we can only avoid coercions as far as we are able to stay within one largest field.
For example, the definition of complex numbers depends on many results for rational numbers, which would need to be proved again, or transported, for the subfield of $\C$ isomorphic to $\Q$.

Instead, we formalized results about field extensions through parametrization. The fields $K$ and $L$ can be arbitrary types
and the hypothesis ``$L$ is a field extension of~$K$'' is represented by an instance parameter \lean{[algebra K L]} denoting a $K$-algebra structure on $L$.
There are multiple possible $K$-algebra structures for a field $L$ and Lean does not enforce uniqueness of typeclass instances,
but the \mathlib maintainers try to ensure all instances that can be inferred are definitionally equal.
The \lean{algebra} structure provides us with a canonical ring homomorphism $\lean{algebra\_map K L} : K \to L$; this map is injective because $K$ and $L$ are fields.
In other words, field extensions are given by their canonical embeddings.

\subsection{Scalar towers} \label{sec:scalar_tower}

The main drawback of using arbitrary embeddings to represent field extensions is that we need to prove that these maps commute.
For example, we might start with a field extension $L / \Q$, then define a subfield $K$ of $L$,
resulting in a tower of extensions $L / K / \Q$.
In such a tower, the map $\Q \to L$ should be equal to the composition $\Q \to K$ followed by $K \to L$.
Such an equality cannot always be achieved by defining the map $\Q \to L$ to be this composition: in the example, the map $\Q \to K$ depends on the map $\Q \to L$.

The solution in \mathlib is to parametrize over all three maps, as long a there is also a proof of coherence:
a hypothesis of the form ``$L / K / F$ is a tower of field extensions'' is translated into three instance parameters \lean{[algebra F K]}, \lean{[algebra K L]} and \lean{[algebra F L]},
along with a parameter \lean{[is\_scalar\_tower F K L]} expressing that the maps commute.

The \lean{is\_scalar\_tower} typeclass derives its name from its applicability to any three types between which exist scalar multiplication operations:
\begin{lstlisting}
class is_scalar_tower (M N α : Type*)
  [has_scalar M N] [has_scalar N α] [has_scalar M α] : Prop :=
(smul_assoc : ∀ (x : M) (y : N) (z : α), (x • y) • z = x • (y • z))
\end{lstlisting}
For example, if $R$ is a ring, $A$ is an $R$-algebra and $M$ an $A$-module, we can state that $M$ is also an $R$-module by adding a \lean{[is\_scalar\_tower R A M]} parameter.
Since \lean{x~$\cdot$~y} for an $R$-algebra $A$ is defined as \lean{algebra\_map R A x * y}, applying \lean{smul\_assoc} for each $x : K$ with $y = (1 : L)$ and $z = (1 : F)$ shows that the \lean{algebra\_map}\kern-.3em s indeed commute.

Common \lean{is\_scalar\_tower} instances are declared in \mathlib,
such as for the maps $R \to S \to A$ when $S$ is a $R$-subalgebra of $A$.
The effect is that almost all coherence proof obligations are automated through typeclass instance search.
Only when defining a new algebra structure were we required to supply the \lean{is\_scalar\_tower} instances ourselves.
Our reliance on typeclasses did not cause any noticeable slowness in proof checking:
there was no instance that should be found but could not due to timeouts.

\subsection{Rings of integers} \label{sec:ring-of-integers}

When $K$ is a number field (defined as a field satifying \lean{is\_number\_field}), the ring $\OK$ of integers in $K$ is defined as the integral closure of $\Z$ in $K$.
This is the subring containing those $x : K$ that are the root of a monic polynomial with coefficients in $\Z$:
\begin{lstlisting}
def number_field.ring_of_integers (K : Type*) [field K]
  [is_number_field K] : subalgebra ℤ K :=
integral_closure ℤ K
\end{lstlisting}
where \lean{integral\_closure} was previously defined in \mathlib.

When $K$ is a function field over the finite field $\Fq$, we defined $\OK$ analogously as \lean{integral\_closure (polynomial $\Fq$) K}.
To treat both definitions of ring of integers on an equal footing,
we will work with the integral closure of any principal ideal domain when possible.

\subsection{Subobjects} \label{sec:subobjects}

The ring of integers is one example of a subobject, such as a subfield, subring or subalgebra, defined through a characteristic predicate.
In \mathlib, subobjects are ``bundled'', in the form of a \lean{structure} comprising the carrier set and proofs showing the carrier set is closed under the relevant operations.
Bundled subobjects provide similar benefits as bundled morphisms; the choice for the latter is explained in the \mathlib overview paper~\cite{mathlib}.

Two new subobjects that we defined in our development were \lean{subfield} as well as \lean{intermediate\_field}. We defined a subfield of a field $K$ as a subset of $K$ that contains $0$ and $1$ and is closed under addition, negation, multiplication and taking inverses.
If $L$ is a field extension of~$K$, we defined an intermediate field as a subfield that is also a $K$-subalgebra: a subfield that contains the image of $\lean{algebra\_map K L}$.
Other examples of subobjects available in \mathlib are submonoids, subgroups and submodules (with ideals as a special case of submodules).

The new definitions found immediate use:
soon after we contributed our definition of \lean{intermediate\_field} to \mathlib,
the Berkeley Galois theory group used it in a formalization of the primitive element theorem.
Soon after the primitive element theorem was merged into \mathlib,
we used it in our development of the trace form.
This anecdote illustrates the decentralized development style of \mathlib,
with different groups and people building on each other's results in a collaborative process.

By providing a coercion from subobjects to types, sending a subobject $S$ to the subtype of all elements of $S$,
and putting typeclass instances on this subtype,
we could reason about inductively defined rings such as $\Z$ and subrings such as \lean{integral\_closure $\Z$ K} uniformly.
If $S : \lean{subfield}\ K$, there is a canonical ring embedding, the map that sends $x : S$ to $K$ by ``forgetting'' that $x \in S$,
and we registered this map as an \lean{algebra S K} instance, also allowing us to treat field extensions of the form $\Q \to \C$ and subfields uniformly.
Similarly, for $F : \lean{intermediate\_field K L}$, we defined the corresponding \lean{algebra K F}, \lean{algebra F L} and \lean{is\_scalar\_tower K F L} instances.

\subsection{Fields of fractions}\label{subsection : fields of fractions}
The fraction field $\Frac R$ of an integral domain $R$ can be defined explicitly as a quotient type as follows:
starting from the set of pairs $(a,b)$ with $a,b \in R$ such that $b\neq 0$,
one quotients by the equivalence relation generated by $(\alpha a, \alpha b) \sim (a,b)$ for all $\alpha \ne 0 : R$, writing the equivalence class of $(a,b)$ as $\frac{a}{b}$.
It can easily be proved that the ring structure on $R$ extends uniquely to a field structure on $\Frac R$;
in \mathlib this construction is called \mbox{\lean{fraction\_ring R}}.
When $R=\Z$, this yields the traditional description of $\Q$ as the set of equivalence classes of fractions, where $\frac{2}{3}=\frac{-4}{-6}$, etc.
The drawback of this construction is that there are many other fields that can serve as the field of fractions for the same ring.
Consider the field $\{z \in \C : \Re z \in \Q, \Im z\in\Q\}$, which is isomorphic to $\Frac (\Z[i])$ but not definitionally equal to it.

The strategy used in \mathlib is to rather allow for many different \emph{fraction fields} of our given integral domain $R$,
as fields $K$ along with an injective \emph{fraction map} $f \colon R \to K$ which witnesses that all elements of $K$ are ``fractions'' of elements of $R$,
and to parametrize every result over the choice of $f$.
In the definition used by \mathlib, a fraction map is a special case of a \emph{localization map}.
Different localizations restrict the denominators to different multiplicative submonoids of $R\setminus\{0\}$.

The conditions on $f$ imply that $K$ is the smallest field containing $R$, expressed by the following unique mapping property.
If $g \colon R \to A$ is an injective map to a ring $A$ such that $g(x)$ has a multiplicative inverse for all $x \ne 0 : R$, then
it can be extended uniquely to a map $K \to A$ compatible with $f$ and $g$.
In particular, if $f_1 \colon R \to K_1$ and $f_2 \colon R \to K_2$ are fraction maps, they induce an isomorphism $K_1 \simeq K_2$.
The construction of $\Frac R$ then results in \emph{a} field of fractions (with fraction map \lean{fraction\_ring.of R}) rather than \emph{the} field of fractions.

This comes at a price:
informally, at any given stage of one's reasoning, the field $K$ is fixed and the map $f\colon R\to K$ is applied implicitly, just viewing every $x:R$ as $x:K$.
It is now impossible to view $f(R) \leq K$ as an inclusion of subalgebras,
because the map $f$ is needed explicitly to give the $R$-algebra structure on $K$.
As a solution, we use a type synonym \lean{f.codomain := K} and instantiate the $R$-algebra structure given by $f$ on this synonym.

\subsection{Representing monogenic field extensions} \label{sec:monogenic-field-extension}

In Section~\ref{sec math background} we have informally said that every number field $K$ can be written as $K=\Q(\alpha)$ for a root $\alpha$ of an irreducible polynomial $P\in\Q[X]$. This can be made precise in several ways. For instance, one can consider a large field $L$ (of characteristic $0$) where $P$ splits completely, then choose a root $\alpha\in L$ and let $K = \Q(\alpha)$ be the smallest subfield of $L$ containing $\alpha$. Or, one can consider the quotient ring $\Q[X]/P$ and observe that this is a field where the class $X\pmod{P}$ is a root of $P$. The assignment $\alpha\mapsto X\pmod{P}$ yields an isomorphism of the two fields, but any other choice of a root $\alpha'\in L$ leads to another isomorphism $\Q(\alpha')\cong \Q[X]/P$. Although mathematically we often tacitly identify the constructions, there is no canonical representation of the \emph{monogenic} extensions of $\Q$, those which can be obtained by adjoining a single root of one polynomial.

The same continues to hold if we replace the base field $\Q$ with another field $F$, thus considering extensions of the form $F(\alpha)$, now requiring that $\alpha$ be a root of some $P\in F[X]$. Various constructions of $F(\alpha)$ have already been formalized in \mathlib. The ability to switch between these representations is important: sometimes $K$ and $F$ are fixed and we want an arbitrary $\alpha$; sometimes $\alpha$ is fixed and we want an arbitrary type representing $F(\alpha)$.

To find a uniform way to reason about all these definitions,
we chose to formalize the notion of \emph{power basis} to represent monogenic field extensions: this is a basis of the form $1, x, x^2, \dots, x^{n-1} : K$ (viewing $K$ as a $F$-vector space).
We defined a structure type bundling the information of a power basis.
Omitting some generalizations not needed in this paper, the definition reads:
\begin{lstlisting}
structure power_basis (F K : Type*) [field F] [field K] [algebra F K] :=
(gen : S) (dim : ℕ)
(is_basis : is_basis F (λ (i : fin dim), gen ^ (i : ℕ)))
\end{lstlisting}
We formalized that the previously defined notions of monogenic field extensions are equivalent to the existence of a power basis.

With the \lean{power\_basis} structure, we gained the ability to parametrize our results,
being able to choose the $F$ and $K$ in a monogenic field extension $K / F$, or being able to choose the $\alpha$ generating $F(\alpha)$ (by setting \lean{power\_basis.gen\ pb} equal to $\alpha$).
To specialize a result from an arbitrary $K$ with a power basis over $F$ to a specific construction of $K = F(\alpha)$,
one can apply the result to the power basis generated by $\alpha$ and rewrite $\lean{power\_basis.gen F($\alpha$)} = \alpha$.


\section{Dedekind domains} \label{sec:Dedekind-domain}
The right setting to study algebraic properties of number fields are \emph{Dedekind domains}.
We formalized fundamental results on Dedekind domains, including the equivalence of two definitions of Dedekind domain.

\subsection{Definitions}\label{subsec:definitions_DD}
There are various equivalent conditions, used at various times, for an integral domain $D$ to be a Dedekind domain.
The following three have been formalized in \mathlib:
\begin{itemize}
\item \lean{is\_dedekind\_domain D}: $D$ is a Noetherian integral domain, integrally closed in its fraction field and has Krull dimension at most $1$;
\item \lean{is\_dedekind\_domain\_inv D}: $D$ is an integral domain and nonzero fractional ideals of $D$ have a multiplicative inverse (we discuss the notion and formalization of fractional ideals in Section~\ref{subsection:frac_ideals});
\item \lean{is\_dedekind\_domain\_dvr D}: $D$ is a Noetherian integral domain and the localization of $D$ at each nonzero prime ideal is a discrete valuation ring.
\end{itemize}
Note that fields are Dedekind domains according to these conventions.

The mathlib community chose \lean{is\_dedekind\_domain} as the main definition,
since this condition is usually the one checked in practice~\cite{Neukirch}.
The other two equivalent definitions were added to \mathlib, but before formalizing the proof that they are indeed equivalent.
Having multiple definitions allowed us to do our work in parallel without depending on unformalized results.
For example,
the proof of unique ideal factorization in a Dedekind domain initially assumed \lean{is\_dedekind\_domain\_inv D},
and the proof that the ring of integers $\OK$ is a Dedekind domain concluded \lean{is\_dedekind\_domain (ring\_of\_integers K)}.
After the equivalence between \lean{is\_dedekind\_domain D} and \lean{is\_dedekind\_domain\_inv D} was formalized,
we could easily replace usages of \lean{is\_dedekind\_domain\_inv} with \lean{is\_dedekind\_domain}.

The conditions \lean{is\_dedekind\_domain} and \lean{is\_dedekind\_domain\_inv} require a fraction field $K$,
although the truth value of the predicates does not depend on the choice of $K$.
For ease of use, we let the type of \lean{is\_dedekind\_domain} depend only on the domain $D$
by instantiating $K$ in the definition as \lean{fraction\_ring D}. From now on, we fix a fraction map $f\colon D\to K$.
\begin{lstlisting}
class is_dedekind_domain (D : Type*) [integral_domain D] : Prop :=
(to_is_noetherian_ring : is_noetherian_ring D)
(dimension_le_one : dimension_le_one D)
(is_integrally_closed : integral_closure D (fraction_ring D) = ⊥)
\end{lstlisting}
The notation $\bot$ is used in \mathlib for the bottom element of a lattice.
For example, here $\bot$ denotes the smallest $D$-subalgebra of \lean{fraction\_ring D}, i.e. $D$ itself,
and \lean{$\bot$ $:$ ideal D} denotes the zero ideal.

Applications of \lean{is\_dedekind\_domain} can choose a specific fraction field through the following lemma exposing the alternate definition:
\begin{lstlisting}
lemma is_dedekind_domain_iff (f : fraction_map D K) :
  is_dedekind_domain D ↔
    is_noetherian_ring D ∧ dimension_le_one D ∧
    integral_closure D f.codomain = ⊥
\end{lstlisting}

We marked \lean{is\_dedekind\_domain} as a typeclass by using the keyword \lean{class} rather than \lean{structure},
allowing the typeclass system to automatically infer the Dedekind domain structure when an appropriate instance is declared, such as for PIDs or rings of integers.

\subsection{Fractional ideals}\label{subsection:frac_ideals}
The notion which is pivotal to the definition of the ideal class group of a Dedekind domain is that of \emph{fractional ideals}:
given any integral domain $R$ with a field of fractions $F$,
we define \lean{is\_fractional} as a predicate on $R$-submodules $J$ of $F$, informally as ``there is an $x : R$ with $x J \subseteq R$''.
For a Dedekind domain, nonzero fractional ideals form a group under multiplication.
As seen in Section~\ref{subsection : fields of fractions}, this notion depends on the field $K$ as well as on the fraction map $f\colon R\to K$.
A more precise way of stating the above condition is then
$f(x)J\subseteq f(R)$.
We formalized the definition of fractional ideals relative to a map $f\colon R\to K$ as a type \lean{fractional\_ideal f}, whose elements consist of the $R$-submodule of $F$ along with a proof of \lean{is\_fractional}.
The structure of fractional ideals does not depend on the choice of a fraction map, which we formalized as an isomorphism \lean{fractional\_ideal.canonical\_equiv} between the fractional ideals relative to fraction maps $f_1\colon R\to K_1$ and $f_2\colon R\to K_2$.

We defined the addition, multiplication and intersection operations on fractional ideals,
by showing that the corresponding operations on submodules map fractional ideals to fractional ideals.
We also formalized that these operations give a commutative semiring structure on the type of fractional ideals.
For example, multiplication of fractional ideals is defined as
\begin{lstlisting}
lemma fractional_mul (I J : fractional_ideal f) :
  is_fractional f (I * J : submodule R f.codomain) := _ -- proof omitted

instance : has_mul (fractional_ideal f) :=
⟨λ I J, ⟨I * J : submodule R f.codomain, fractional_mul I J⟩⟩
\end{lstlisting}

Defining the quotient of two fractional ideals requires slightly more work. Consider any $R$-algebra $A$ and an injection $R\hookrightarrow A$. Given ideals $I,J\le R$, the submodule $I / J\le A$
is defined by the property
\pagebreak[3] % Break the page on this line, rather than the next
\begin{lstlisting}
lemma submodule.mem_div_iff_forall_mul_mem {x : A} {I J : submodule R A} :
  x ∈ I / J ↔ ∀ y ∈ J, x * y ∈ I
\end{lstlisting}
Beware that the notation $1/I$ might be misleading here: indeed, for general integral domains, the equality $I\ast 1/I=1$ might not hold. As an example, one can consider the ideal $(X,Y)$ in $\C[X,Y]$.
On the other hand, we formalized that this equality holds for Dedekind domains (Section~\ref{sec:equivalence}) as the following lemma:
\begin{lstlisting}
lemma fractional_ideal.is_unit {hD : is_dedekind_domain D}
  (I : fractional_ideal f) (hne : I ≠ ⊥) : is_unit I
\end{lstlisting}
This justifies the notation $I^{-1}=1/I$. In fact, we define this notation even for the ideal $0$, by declaring that $0^{-1}=0$. This reflects the existence of the typeclass \lean{group\_with\_zero} in \mathlib, consisting of groups endowed with an extra element \lean{0} whose inverse is again \lean{0}.

Moreover, \mathlib used to define \lean{$a / b := a * b^{-1}$}, but our definition of $I^{-1} = 1 / I$ would cause circularity. This led us to a major refactor of this core definition. In particular, we had to weaken the definitional equality to a proposition; this involved many small changes throughout \mathlib.%
\footnote{The pull requests are available as \url{https://github.com/leanprover-community/mathlib/pull/5302} and \url{https://github.com/leanprover-community/mathlib/pull/5303}.}

\subsection{Equivalence of the definitions} \label{sec:equivalence}
We now describe how we proved and formalized that the two definitions \lean{is\_dedekind\_domain} and \lean{is\_dedekind\_domain\_inv} of being a Dedekind domain are equivalent. Let $D$ be a Dedekind domain, and $f\colon D\to K$ a fraction map to a field of fractions $K$ of $D$.

To show that \lean{is\_dedekind\_domain\_inv} implies \lean{is\_dedekind\_domain}, we follow the proof given by Fr\"ohlich in~\cite[Chapter 1, \S~2, ~Proposition 1.2.1]{frohlich}. A constant challenge that was faced while coding this proof was already mentioned in Section \ref{subsection : fields of fractions}, namely the fact that elements of the ring must be traced along the fraction map.
The proofs for being integrally closed and of dimension being less than or equal to $1$ are fairly straightforward.

Formalizing the Noetherian condition was the most challenging. Fr\"ohlich considers elements $a_1, \dots, a_n \in I$ and $b_1, \dots, b_n \in I^{-1}$ for any nonempty fractional ideal $I$,
satisfying $ \sum_i a_i b_i = 1 $.
However, it is quite challenging to prove that an element of the product of two $D$-submodules $A$ and $B$ must be of the form $\sum_{i = 1}^m a_i*b_i$, for $a_i \in A$ and $b_i \in B$ for all $1 \leq i \leq m$.
Instead, we show that, for every element $x\in A\ast B$, there are finite sets $T\subseteq A$, $T'\subseteq B$ such that \lean{x $\in$ span (T * T')}, formalized as
\lean{submodule.mem\_span\_mul\_finite\_of\_mem\_mul}.
Now considering a nonzero integral ideal $I$ of the ring $D$, by definition of invertibility we can write \lean{1 $\in$ (1 $:$ fractional\_ideal f) = I * 1 / I}. Hence, we obtain 
finite sets $T \subset I$ and $T' \subset 1/I$ such that $1$ is contained in the $D$-span of $T*T'$. We used the \lean{norm\_cast} tactic~\cite{norm_cast} to resolve most coercions, however, this tactic did not solve coercions coming from the fraction map. With coercions, the actual statement of the latter expression in Lean is \lean{↑T' ⊆ ↑↑(1 / ↑I)}, which reads
\begin{lstlisting}
(T' : set (fraction_ring.of D).codomain) ⊆
  (((1 / (I : fractional_ideal (fraction_ring.of D)))
    : submodule D (fraction_ring.of D).codomain)
    : set (fraction_ring.of D).codomain
\end{lstlisting}
The lemma \lean{fg\_of\_one\_mem\_span\_mul} then shows that $I$ is finitely generated, concluding the proof.

The theorem \lean{fractional\_ideal.mul\_inv\_cancel} proves the converse, namely that \lean{is\_dedekind\_domain} implies \lean{is\_dedekind\_domain\_inv}. The classical proof consists of three steps: first, every maximal ideal $M\subseteq D$, seen as a fractional ideal, is invertible;
secondly, every nonzero ideal is invertible, using that it is contained in a maximal ideal;
thirdly, the fact that every fractional ideal $J$ satisfies $xJ\leq I$ for a suitable $x\in D$ and an ideal $I\subseteq D$ implies that every fractional ideal is invertible, concluding the proof that nonzero fractional ideals form a group.
The third step was easy, building upon the material developed for the general theory of \lean{fractional\_ideal f}. Concerning the first two, we found that passing from the case where $M$ is maximal to the general case required more code than directly showing invertibility of arbitrary nonzero ideals. The formal statement reads
\begin{lstlisting}
lemma coe_ideal_mul_one_div [hD : is_dedekind_domain D] 
  (I : ideal D) (hne : I ≠ ⊥) :
  ↑I * ((1 : fractional_ideal f) / ↑I) = (1 : fractional_ideal f)
\end{lstlisting}
from where it becomes apparent that we had to repeatedly distinguish between \lean{I $:$ ideal D}, and its coercion \lean{↑I $:$ fractional\_ideal f} although these objects, from a mathematical point of view, are identical.

The formal proof of this result relies on the lemma \lean{exists\_not\_mem\_one\_of\_ne\_bot}, which says that for every non-trivial ideal $0\subsetneq I\subsetneq D$, there exists an element in the field $K$ which is not integral (so, not in $f(D)$) but lies in $1/I$. The proof begins by invoking that every nonzero ideal in the Noetherian ring $D$ contains a product of nonzero prime ideals. This result was not previously available in \mathlib.
The dimension condition shows its full force when applying this lemma:
each prime ideal in the product, being nonzero, will be maximal because the Krull dimension of $D$ is at most $1$; from this, \lean{exists\_not\_mem\_one\_of\_ne\_bot} follows easily. Having the above lemma at our disposal,
we were able to prove that every ideal $I\ne 0$ is invertible by arguing by contradiction: if $I\ast 1/I\lneq D$, we can find an element $x\in K\setminus f(R)$ which is in $1/(1\ast 1/I)$ thanks to \lean{exists\_not\_mem\_one\_of\_ne\_bot} and some easy algebraic manipulation will imply that $x$ is actually integral over $D$. Since $D$ is integrally closed, it must lie in $f(D)$, contradicting the construction of $x$. Combining these results gives the equivalence between the two conditions for being a Dedekind domain.

\section{Principal ideal domains are Dedekind}

As an example of our definitions, we discuss in some detail our formalization of the fact that a principal ideal domain is a Dedekind domain. There is no explicit definition of PIDs in \mathlib, rather it is split up into two hypotheses.
One uses \lean{[integral\_domain R] [is\_principal\_ideal\_ring R]} to denote a PID $R$,
where \lean{is\_principal\_ideal\_ring} is a typeclass defined for all commutative rings:
\begin{lstlisting}
class is_principal_ideal_ring (R : Type*) [comm_ring R] : Prop :=
(principal : ∀ (I : ideal R), is_principal I)
\end{lstlisting}

Our proof that the hypotheses \lean{[integral\_domain R] [is\_principal\_ideal\_ring R]} imply \lean{is\_dedekind\_domain R} was relatively short:
\begin{lstlisting}
instance principal_ideal_ring.to_dedekind_domain (R : Type*)
  [integral_domain R] [is_principal_ideal_ring R] :
  is_dedekind_domain R :=
⟨principal_ideal_ring.is_noetherian_ring,
 dimension_le_one.principal_ideal_ring _,
 unique_factorization_monoid.integrally_closed (fraction_ring.of R)⟩
\end{lstlisting}
Recall from Section \ref{sec:number fields} that the \lean{instance} keyword marks the declaration for inference by the typeclass system.

The Noetherian property of a Dedekind domain followed easily by the previously defined lemma \lean{principal\_ideal\_ring.is\_noetherian\_ring}, since, by definition, each ideal in a principal ideal ring is finitely generated (by a single element).

We proved the lemma \lean{dimension\_le\_one.principal\_ideal\_ring}, which is an instantiation of the existing result \lean{is\_prime.to\_maximal\_ideal}, showing a nonzero prime ideal in a PID is maximal.
The latter lemma uses the characterization that $I$ is a maximal ideal if and only if any strictly larger ideal $J\supsetneq I$ is the full ring $R$.
If $I$ is a nonzero prime ideal and $J \supsetneq I$ in the PID $R$, we have that the generator $j$ of $J$ is a divisor of the generator $i$ of $I$. Since $I$ is prime, this implies that either $j \in I$, contradicting the assumption that $J \supsetneq I$, $i = 0$, contradicting that $I$ is nonzero, or that $j$ is a unit, implying $J = R$ as desired.

The final condition of a PID being integrally closed was the most challenging.
We used the previously defined instance \lean{principal\_ideal\_ring.to\_unique\_factorization\_monoid} to deduce that a PID is a unique factorisation monoid (UFM),
to instantiate our proof that every UFM is integrally closed.
In the same way that principal ideal domains are generalized to principal ideal rings, \mathlib generalizes unique factorization domains to unique factorization monoids.
A commutative monoid $R$ with an absorbing element $0$ and injectivity of multiplication is defined to be a UFM,
if the relation ``$x$ properly divides $y$'' is well-founded (implying each element can be factored as a product of irreducibles) and
an element of $R$ is prime if and only if it is irreducible (implying the factorization is unique).
The first condition is satisfied for a PID since the Noetherian property implies that the division relation is well-founded.
The second condition followed from \lean{principal\_ideal\_ring.irreducible\_iff\_prime}.
To prove that an irreducible element $p$ is prime, the proof uses that prime elements generate prime ideals and irreducible elements of a PID generate maximal ideals. Since all maximal ideals are prime ideals, the ideal generated by $p$ is maximal, hence prime, thus $p$ is prime.
We proved the lemma \lean{irreducible\_of\_prime}, which shows the converse holds in any commutative monoid with zero.

To show that a UFM is integrally closed, we first formalized the Rational Root Theorem, named \lean{denom\_dvd\_of\_is\_root},
which states that for a polynomial $p : R[X]$ and an element of the fraction field $x : \Frac R$ such that $p(x) = 0$, the denominator of $x$ divides the leading coefficient of $p$.
If $x$ is integral with minimal polynomial $p$, the leading coefficient is $1$, therefore the denominator is a unit and $x$ is an element of $R$.
This gave us the required lemma \lean{unique\_factorization\_monoid.integrally\_closed}, which states that the integral closure of $R$ in its fraction field is $R$ itself.

\section{Rings of integers are Dedekind domains} \label{sec:integral-closure}

An important classical result in algebraic number theory is that the ring of integers of a number field $K$, defined as the integral closure of $\Z$ in $K$, is a Dedekind domain. We formalized a stronger result: given a Dedekind domain $D$ and a field of fractions $F$, if $K$ is a finite separable extension of~$F$, then the integral closure of $D$ in $K$ is a Dedekind domain with fraction field $K$.
Our approach was adapted from Neukirch \cite[Theorem~3.1]{Neukirch}.
Throughout this section, let $D$ be a Dedekind domain with a field of fractions $F$ (given by the map $f \colon D \to F$), $K$ a finite, separable field extension of~$F$ and let $S$ denote the integral closure of $D$ in $K$.

The first step was to show that $K$ is a field of fractions for the integral closure, namely, there is a map \lean{fraction\_map\_of\_finite\_extension f K : fraction\_map S K}.
The main content of \lean{fraction\_map\_of\_finite\_extension} consisted of showing that all elements $x : K$ can be written as $y / z$ for elements $y \in S$, $z \in D \subseteq S$;
the standard proof of this fact (see~\cite[Theorem~15.29]{Dummit-and-Foote}) formalized readily.

We could then show that the integral closure of $D$ in $K$ is a Dedekind domain,
by proving it is integrally closed in $K$, has Krull dimension at most $1$ and is Noetherian.
The fact that the integral closure is integrally closed was immediate.

To show the Krull dimension is at most $1$, we needed to develop basic going-up theory for ideals.
In particular, we showed that an ideal $I$ in an integral extension is maximal if it lies over a maximal ideal,
and used a result already available in \mathlib that a prime ideal $I$ in an integral extension lies over a prime ideal.
\begin{lstlisting}
lemma is_maximal_of_is_integral_of_is_maximal_comap
  (I : ideal S) [is_prime I]
  (hI : is_maximal (comap f I)) : is_maximal I
theorem is_prime.comap (I : ideal S) [hI : is_prime I] :
  is_prime (comap f I)
\end{lstlisting}

The final condition, that the integral closure $S$ of $D$ in $L$ is a Noetherian ring, required the most work.
We started by following the first half of Dummit and Foote~\cite[Theorem~15.29]{Dummit-and-Foote},
so that it sufficed to find a nondegenerate bilinear form $B$ such that all integral $x, y : K$ satisfy $B(x, y) \in \lean{integral\_closure}\ D\ K$.
We then formalized the results in Neukirch \cite[\S\S~2.5--2.8]{Neukirch} to show that the \emph{trace form} is a bilinear form satisfying these requirements.

\subsection{The trace form}\label{sec:trace-form}
In the notation from the previous section, consider the bilinear map \lean{lmul := $\lambda$ x y $:$ K, x~*~y}.
The trace of the linear map \lean{lmul x} is called the \emph{algebra trace} $\Tr_{K / F}(x)$ of $x$.
We defined the algebra trace
as a linear map, in this case from $K$ to $F$:
\begin{lstlisting}
noncomputable def trace : K →ₗ[F] F :=
linear_map.comp (linear_map.trace F K) (to_linear_map (lmul F K))
\end{lstlisting}
This definition was marked noncomputable since \lean{linear\_map.trace} makes a case distinction on the existence of a finite basis,
choosing an arbitrary finite basis if one exists and returning $0$ otherwise.
This latter case did not occur in our development.

We defined the \emph{trace form} to be an $F$-bilinear form on $K$, mapping $x, y : K$ to $\Tr_{K/F}(xy)$.
\begin{lstlisting}
noncomputable def trace_form : bilin_form F K :=
{ bilin := λ x y, trace F K (x * y), .. /- proofs omitted -/ }
\end{lstlisting}

In the following, let $L / K / F$ be a tower of finite extensions of fields, namely we assumed \lean{[algebra F K] [algebra K L] [algebra F L] [is\_scalar\_tower F K L]}, as described in Section~\ref{sec:scalar_tower}.

The value of the trace depends on the choice of $F$ and $K$; we formalized this as lemmas \lean{trace\_algebra\_map x $:$ trace F K (algebra\_map F K x) = findim F K • x} as well as \lean{trace\_comp K x $:$ trace F L x = trace F K (trace K L x)}.
These results followed by direct computation.

To compute $\Tr_{K/F}(x)$, it therefore suffices to consider the trace of $x$ in the smallest field containing $x$ and $F$, which is the monogenic extension $F(x)$ discussed in Section \ref{sec:monogenic-field-extension}.
There is a nice formula for the trace in $F(x)$, although the terms in this formula are elements in a larger field $L$
(such as the \emph{splitting field} of the minimal polynomial of $x$).
In formalizing this formula, we first mapped the trace to $L$ using the canonical embedding $\lean{algebra\_map F L}$,
which gave the following lemma statement:
\begin{lstlisting}
lemma power_basis.trace_gen_eq_sum_roots (pb : power_basis F K)
  (h : polynomial.splits (algebra_map F L) pb.minpoly_gen) :
  algebra_map F L (trace F K pb.gen) =
    sum (roots (map (algebra_map F L) pb.minpoly_gen))
\end{lstlisting}
We formulated the lemma in terms of the power basis, since we needed to use it for $F(x)$ here
and for an arbitrary finite separable extension $L / K$ later in the proof.

The elements of \lean{(pb.minpoly\_gen.map (algebra\_map F L)).roots} are called \emph{conjugates} of $x$ in $L$.
Each conjugate of $x$ is integral since it is a root of (the same) monic polynomial,
and integer multiples and sums of integral elements are integral.
Combining \lean{trace\_gen\_eq\_sum\_roots} and \lean{trace\_algebra\_map} showed that the trace of $x$ is an integer multiple (namely \lean{findim F(x) L}) of a sum of conjugate roots, hence we concluded that the trace (and trace form) of an integral element is also integral.

Finally, we showed that the trace form is nondegenerate, following Neukirch~\cite[Proposition~2.8]{Neukirch}.
Since $K / F$ is a finite, separable field extension, it has a power basis \lean{pb} generated by $x$.
Letting $x_k$ denote the $k$-th conjugate of $x$ in an algebraically closed field $L / K / F$,
the main difficulty was in checking the equality $\sum_k x_k^{i + j} = \Tr_{K / F} (x^{i + j})$.
Directly applying \lean{trace\_gen\_eq\_sum\_roots} was tempting, since we had a sum over conjugates of powers on both sides.
However, the two expressions did not precisely match: the left hand side is a sum of conjugates of $x$, where each conjugate is raised to the power $i + j$,
while the conclusion of \lean{trace\_gen\_eq\_sum\_roots} resulted in a sum over conjugates of $x^{i + j}$.

Instead, the paper proof switched here to an equivalent definition of conjugate:
the conjugates of $x$ in $L$ are the images (counted with multiplicity) of $x$ under each embedding $\sigma \colon F(x) \to L$ that fixes $F$. This equivalence between the two notions of conjugate was contributed to \mathlib by the Berkeley group in the week before we realized we needed it. Mapping \lean{trace\_gen\_eq\_sum\_roots} through the equivalence gave
$\Tr_{K / F}(x) = \sum_{\sigma} \sigma x$.
Since each $\sigma$ is a ring homomorphism, $\sigma\ x^{i + j} = (\sigma\ x)^{i + j}$,
so the conjugates of $x^{i + j}$ are the $(i + j)$-th powers of conjugates of $x$, which concluded the proof.

\section{Class group and class number} \label{sec:class-number}

Given a Dedekind domain with fraction map $f\colon D\to K$, we formalized the notion of class group in Lean by defining a map \lean{to\_principal\_ideal f $:$ units f.codomain → units (fractional\_ideal f)},
and defined the class group as
\begin{lstlisting}
def class_group := quotient_group.quotient (to_principal_ideal (range f))
\end{lstlisting}
In general, Dedekind domains can have infinite class groups. However, as discussed in Section~\ref{sec math background}, the rings of integers of global fields have finite class groups.

We let $K$ be a number field and $K'$ be a function field, with ring of integers $\OK$ and $\OK[K']$ (w.r.t. a fixed $\Fq[q][t]$), respectively. 
Most proofs of the finiteness of $\Cl_{\OK}$ one finds in a modern textbook (see~\cite[Theorems 4.4,~5.3,~6.3]{Neukirch}) depend on Minkowski's lattice point theorem, a result from the geometry of numbers (which has been formalized in Isabelle/HOL~\cite{Minkowskis_Theorem-AFP}).
Extending this proof to show the finiteness of $\Cl_{\OK[K']}$ is quite involved and does not result in a uniform proof for $\Cl_{\OK}$ and $\Cl_{\OK[K']}$.
Our formalization instead adapted and generalized a classical approach to the finiteness of $\Cl_{\OK}$, where the use of Minkowski's theorem is replaced by the pigeonhole principle. 
For an informal writeup of the proof, used in the formalization efforts, see~\url{https://github.com/lean-forward/class-number/blob/itp-2021-final/FiniteClassGroup.pdf}.
The classical approach seems to go back to Kronecker
and can be found, for instance, in~\cite{Ireland-Rosen}.
We note that some other ``uniform'' approaches can be found in~\cite{Artin-Whaples} and~\cite{Stasinski}.

Let $D$ be an Euclidean domain: in particular, it will be a PID and hence a Dedekind domain. Given a fraction map $f \colon D \to F$, let $K$ be a finite separable field extension of~$F$.
We formalized, in the theorem \lean{class\_group.finite\_of\_admissible}, that the integral closure of $D$ in $K$ has a finite class group if $D$ has an ``admissible'' absolute value \lean{abs}.
This notion originated in our project from the adaptation and generalization of the classical finiteness proof in interaction with the formalization efforts.
Very informally, the admissibility conditions require that the remainder operator \lean{\%} produces values that are not too far apart.
Formally, we defined the type of admissible absolute values on $D$ as follows, where \lean{to\_fun} is local notation for an application of the absolute value operator:
\pagebreak[3] % Hint that we want the code block on one page
\begin{lstlisting}
structure admissible_absolute_value (D : Type*) [euclidean_domain D]
  extends euclidean_absolute_value D ℤ :=
(card : ℝ → ℕ) (exists_partition :
  ∀ (n : ℕ) (ε > (0 : ℝ) (b ≠ (0 : D)) (A : fin n → D),
  ∃ (t : fin n → fin (card ε)), ∀ i₀ i₁, t i₀ = t i₁ →
  (to_fun (A i₁ % b - A i₀ % b) : ℝ) < to_fun b • ε)
\end{lstlisting}

The above condition formalizes and generalizes an intermediate result in paper finiteness proofs;
the different proofs for number fields and function fields (still assuming $K/F$ separable) become the same after this point.
We used division with remainder to replace the \emph{fractional part} operator on $F$ in the classical proof, which was essential to incorporate function fields, and at the same time allowed our proof to stay entirely within $D$ to avoid coercions.

The absolute value extends to a norm \lean{abs\_norm f abs $:$ integral\_closure D K → ℤ}.
We used the admissibility of \lean{abs} to find a finite set \lean{finset\_approx L f abs} of elements of $D$,
such that the following generalization of~\cite[Theorem~12.2.1]{Ireland-Rosen} holds.
\begin{lstlisting}
theorem exists_mem_finset_approx' (a b : integral_closure D L) :=
  ∃ (q : integral_closure D L) (r ∈ finset_approx L f abs),
  abs_norm f abs (r • a - q * b) < abs_norm f abs b
\end{lstlisting}
After this, the classical approach mentioned above formalized smoothly.

It remained to define an admissible absolute value for $\Z$ and $\Fq[q][t]$. On $\Z$, it was straightforward to formalize that the usual Archimedean absolute value fulfils the requirements. For $\Fq[q][t]$, we showed that $\lvert f\rvert_{\deg}:=q^{\deg f}$ for $f \in \Fq[q][t]$ is the required admissible absolute value; we note that this was somewhat more involved to formalize.
We concluded that when $K$ is a global field, restricting to \emph{separable} extensions of $\Fq[q](t)$ in the function field case (but see the remark below), the class group is finite:
\begin{lstlisting}
noncomputable instance : fintype
  (class_group (number_field.ring_of_integers.fraction_map K)) :=
class_group.finite_of_admissible K int.fraction_map int.admissible_abs
\end{lstlisting} % Try to get the page break here.
\begin{lstlisting}
noncomputable instance [is_separable f.codomain K] : fintype
  (class_group (function_field.ring_of_integers.fraction_map f K)) :=
class_group.finite_of_admissible F f polynomial.admissible_card_pow_degree
\end{lstlisting}

Finally, we defined \lean{number\_field.class\_number} and \lean{function\_field.class\_number} as the cardinality of the respective class groups.

We remark that it is possible to get rid of the \lean{[is\_separable f.codomain K]} assumption above. 
For instance, using that any function field $K$, given as finite extension of $\Fq[q](t)$, contains an $s \in K$ such that $K/\Fq[q](s)$ is a finite \emph{and separable} extension; see for example \cite[Corollary 4.4 in Chapter VIII]{Lang} (noting that $\Fq$ is perfect and $K$ has transcendence degree $1$ over $\Fq$).
One then also needs to show that finiteness of the class group of the integral closure of $\Fq[q][s]$ in $K$ is preserved upon replacing $\Fq[q][s]$ by $\Fq[q][t]$.
A trivial way to get rid of the assumption in the statement above is to simply move it to our definition of function field.
While this would be mathematically consistent by the result just cited, we did not opt to do this (for instance showing a finite extension of a function field is a function field
would become nontrivial).
%One reason being that it would simply preserve the proof obligation for future basic formalizaion work, for instance when showing a finite extension of a function field is a function field.

We rounded off our development by determining the class number in the simplest possible case: the rational numbers $\Q$.
First, we formalized the theorem \lean{class\_number\_eq\_one\_iff}, stating that the class number of $K$ is $1$ if and only if $\OK$ is a principal ideal domain.
After defining the isomorphism \lean{rat.ring\_of\_integers\_equiv} showing $\OK[\Q]$ is $\Z$,
we could use the fact that $\Z$ is a PID to conclude that the class number of $\Q$ is equal to $1$:
\begin{lstlisting}
theorem rat.class_number : number_field.class_number ℚ = 1 :=
class_number_eq_one_iff.mpr (is_principal_ideal_ring.of_surjective _
  rat.ring_of_integers_equiv.symm.surjective)
\end{lstlisting}

\section{Discussion}

\subsection{Related work}

Broadly speaking, one could see the formalization work as part of number theory. There are several formalization results in this direction.
Most notably, Eberl formalized a substantial part of analytic number theory in Isabelle/HOL~\cite{Eberl19}.
Narrowing somewhat to a more algebraic setting,
Cano, Cohen, Dénès, Mörtberg and Siles formalized constructive definitions in ring theory, most notable for our discussion being the Krull dimension~\cite{linear-algebra-coq}.
We are not aware of any other formal developments of fractional ideals, Dedekind domains or class groups of global fields.

There are many libraries formalizing basic notions of commutative algebra such as field extensions and ideals, including the Mathematical Components library in Coq~\cite{mathcomp},
the algebraic library for Isabelle/HOL~\cite{algebra_isabelle},
the \texttt{set.mm} database for MetaMath~\cite{metamath} and the Mizar Mathematical Library~\cite{algebraic-hierarchy_mizar}.
The field of algebraic numbers, or more generally algebraic closures of arbitrary fields, are also available in many provers.
For example, Blot~\cite{algebraic-numbers-ccorn} formalized algebraic numbers in Coq,
Cohen~\cite{real-algebraic-numbers-coq} constructed the subfield of real algebraic numbers in Coq,
Thiemann, Yamada and Joosten~\cite{algebraic-numbers-isabelle} formalized algebraic numbers in Isabelle/HOL,
Carneiro~\cite{algebraic-numbers-metamath} in MetaMath,
and Watase~\cite{algebraic-numbers-mizar} in Mizar.
To our knowledge, the Coq Mathematical Components library is the only formal development beside ours specifically dealing with number fields~\cite[\texttt{field/algnum.v}]{mathcomp}.

Apart from the general theory of algebraic numbers, there are formalizations of specific rings of integers.
For instance, the Gaussian integers $\Z[i]$ have been formalized
in Isabelle/HOL by Eberl~\cite{gaussian_integers-isabelle},
in MetaMath by Carneiro~\cite{gaussian_integers-metamath}
and in Mizar by Futa, Mizushima, and Okazaki~\cite{gaussian_integers-mizar}.
Eberl's Isabelle/HOL formalization deserves special mention in this context since it introduces techniques from algebraic number theory,
defining the integer-valued norm on $\Z[i]$ and classifying the prime elements of $\Z[i]$.

\subsection{Future directions}

Having formalized various basic results of algebraic number theory, there are several natural directions for future work, including formalizing some of the following results.
\begin{itemize}

\item The group of units of the ring of integers in a number field is finitely generated, or slightly stronger, Dirichlet's unit theorem~\cite[Theorem 7.4]{Neukirch} (and the function field analogue).

\item Other finiteness results in algebraic number theory, most notably Hermite's theorem about the existence of finitely many number fields, up to isomorphism,
with bounded discriminant~\cite[Theorem 2.16]{Neukirch} (and the function field analogue).

\item Class number computations, say of quadratic number fields.
This could be part of verifying correctness of number theoretic software, such as KASH/KANT~\cite{kash} and PARI/GP~\cite{PARI2}.

\item Applications of algebraic number theory to solving Diophantine equations, such as determining all pairs of integers $(x,y)$ such that $y^2=x^3+D$ for
given nonzero $D \in \Z$.
\end{itemize}

\subsection{Conclusion}

In this project, we confirmed the rule that the hardest part of formalization is to get the definitions right.
Once this is accomplished, the paper proof (sometimes first adapted with formalization in mind) almost always translates into a formal proof without too much effort.
In particular, we regularly had to invent abstractions to treat instances of the ``same'' situation uniformly.
Instead of fixing a canonical representation, be it $F \subseteq K \subseteq L$ as subfields or the field of fractions $\Frac R$, or the monogenic $K(\alpha)$, we found that making the essence of the situation an explicit parameter, as in \lean{is\_scalar\_tower}, \lean{fraction\_map} or \lean{power\_basis},
allows to treat equivalent viewpoints uniformly without the need for transferring results.

The formalization efforts described in this paper cannot be cleanly separated from the development of \mathlib as a whole.
The decentralized organization and highly integrated design of \mathlib meant that we could contribute our formalizations as we completed them, resulting in a quick integration into the rest of the library.
Other contributors building on these results often extended them to meet our requirements,
before we could identify that we needed them, as the anecdote in Section \ref{sec:subobjects} illustrates.
In other words, the low barriers for contributions ensured mutually beneficial collaboration.

Quantifying the ratio between the length of our formal proofs and their paper counterparts in an accurrate and meanifngful way will be very difficult as background assumptions and levels of detail varied significantly. We actually did not always literally follow some written text, but deviated from the paper mathematics (often discussed orally, on blackboards, through Zulip, etc.) on many occasions. An important aspect we had to take into account was to consistently combine different descriptions of mathematical objects from different sources.
The formalization project described in this paper resulted in the contribution of thousands of lines of Lean code involving hundreds of declarations.
A rough estimate concerning the former would be that about five thousand lines of project specific code were added, and about half of that number of lines of more generic background code.
We validated existing design choices used in \mathlib, refactored those that did not scale well
and contributed our own set of designs.
The real achievement was not to complete each proof,
but to build a better foundation for formal mathematics.


\bibliography{lean}

\end{document}
